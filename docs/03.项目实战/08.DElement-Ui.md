---
title: DElement-Ui
index_img: /img/article/empty.png
categories: 
  - 组件库
tags: 
  - DElement-Ui
  - 前端
date: 2023-10-29 10:25:12
permalink: /pages/052176/
author: 
  name: 爱写bug的小邓程序员
  link: https://github.com/dengerpu
---

# 从零搭建Vue3组件DElement-Ui

## 环境搭建

在搭建环境之前推荐阅读几篇文章

* [大仓实践录：Lerna/NPM/Yarn Workspace 方案组合和性能对比](https://cloud.tencent.com/developer/article/1913720)
* [手把手，教你搭建基于lerna+pnpm构建的monorepo项目](https://blog.csdn.net/NEXT00/article/details/133685591)
* [learn + pnpm 搭建morerepo](https://zhuanlan.zhihu.com/p/568876897?utm_id=0)
* [Monorepo 項目管理方案：lerna + yarn workspace / pnpm](https://blog.csdn.net/weixin_46803507/article/details/120792359)
* [PNPM Workspaces 替换 Lerna + Yarn](https://article.juejin.cn/post/7071992448511279141)

### 组件库初始化

[Lerna](https://www.lernajs.cn/)

全局安装Lerna

```shell
yarn global add lerna
```

#### monorepo项目初始化

创建一个DElement-Ui目录,然后初始化

```shell
lerna init
yarn init
```

会生成下面的目录

![image-20231029150722430](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202310291507492.png)

修改lerna.json文件

```json
{
  "$schema": "node_modules/lerna/schemas/lerna-schema.json",
  "version": "0.0.0",
  "npmClient": "yarn", // 使用yarn管理
   // "useWorkspaces": true // 使用workspace,需要配置package.json
}
```

> 在"lerna": "^7.4.1"中已经移除了useWorkspaces

![image-20231029154443896](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202310291544943.png)

#### 初始化组件

```shell
$ lerna create button
$ lerna create icon
```

包名填写@d-ui/名字

![image-20231029162226630](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202310291622676.png)

![image-20231029162345781](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202310291623823.png)

```
├─button
│  │  package.json
│  │  README.md
│  ├─src
|  ├─  button.vue
│  ├─index.ts # 组件入口
│  └─__tests__ # 测试相关
└─icon
    │  package.json
    │  README.md
    ├─src
    ├─  icon.vue
    ├─index.ts # 组件入口
    └─__tests__ 
```

将lib改为src

#### tsconfig生成

```shell
yarn add typescript -W
```

tscconfig.json配置如下：

```json
{
  "compilerOptions": {
    "target": "ESNext", // 打包的目标语法
    "module": "ESNext", // 模块转化后的格式
    "esModuleInterop": true, // 支持模块转化
    "skipLibCheck": true, // 跳过类库检测
    "forceConsistentCasingInFileNames": true, // 强制区分大小写
    "moduleResolution": "node", // 模块解析方式
    "jsx": "preserve", // 不转化jsx
    "declaration": true, // 生成声明文件
    "sourceMap": true // 生成映射文件
  }
}
```

### 组件初始化

```shell
$ yarn add vue -W
```

编写声明文件

typings/vue-shim.d.ts

```typescript
declare module '*.vue' {
  import {App,defineComponent} from 'vue';
  const component: ReturnType<typeof defineComponent> & {
      install(app:App):void
  };;
  export default component
}
```

不添加会报如下错误

![image-20231029163736929](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202310291637993.png)

#### 编写组件入口及出口

packages/button/src/button.vue

```vue
<template>
  <button> 按钮 </button>
</template>

<script lang="ts">
import { defineComponent } from "vue";
export default defineComponent({
  name: "DButton",
});
</script>
```

packages/icon/src/icon.vue

```vue
<template>
  <div> icon </div>
</template>

<script lang="ts">
import { defineComponent } from "vue";
export default defineComponent({
  name:'DIcon'
})
</script>
```

添加入口声明文件

packages/button/index.ts

icon文件也做同样的操作

```typescript
import { App } from 'vue'
import Button from './src/button.vue'

Button.install = (app: App): void => {
    app.component(Button.name, Button);
}
export default Button;
```

> install方法，会在app.use()的时候自动调用

#### 整合所有组件

> 此处的作用是为了实现全局组件引入

```shell
lerna create d-ui
```

![image-20231029164812906](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202310291648950.png)

packages/d-ui/index.ts

```typescript
import Button from "@d-ui/button";
import Icon from "@d-ui/icon";
import { App } from "vue";
const components = [ // 引入所有组件
    Button,
    Icon
];
const install = (app: App): void => {
    components.forEach(component => {
        app.component(component.name, component);
    })
}
export default {
    install // 导出install方法
}
```

### 搭建文档

根目录下创建play文件夹

play/App.vue

```vue
<template>
  <div>app
      <d-button></d-button>
      <d-Icon></d-Icon>
  </div>
</template>
```

play/main.ts

```typescript
import {createApp} from 'vue'
import App from './App.vue'

//引入 组件 全局
import Dui from 'd-ui'

createApp(App).use(Dui).mount("#app")
```

play/template.html

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
    <div id="app"></div>
</body>
</html>
```

#### 搭建文档环境

安装webpack构建工具

```shell
yarn add webpack webpack-cli webpack-dev-server vue-loader@next @vue/compiler-sfc -D -W
yarn add babel-loader @babel/core @babel/preset-env @babel/preset-typescript babel-plugin-module-resolver url-loader file-loader html-webpack-plugin css-loader sass-loader style-loader sass -D -W
```

根目录下新建babel.config.js

```javascript
module.exports = {
  presets: [
      '@babel/preset-env',
      "@babel/preset-typescript" // 解析ts语法，在采用preset-env
  ],
  overrides: [{
      test: /\.vue$/,
      plugins: [ // ?
          '@babel/transform-typescript',
      ],
  }],
  env: {
      utils: {
          plugins: [ // ?
              [
                  'babel-plugin-module-resolver', // 为了能正确找到d-ui模块
                  { root: 'd-ui' }
              ]
          ]
      }
  }
}
```

使用webpack进行文档构建工作

play/webpack.config.js

```javascript
const { VueLoaderPlugin } = require("vue-loader");
const HtmlWebpackPlugin = require('html-webpack-plugin')
const path = require('path')
module.exports = {
    mode: 'development',
    devtool:'source-map',
    entry: path.resolve(__dirname, 'main.ts'), // 打包入口
    output: {
        path: path.resolve(__dirname, '../play-dist'), // 出口
        filename: 'bundle.js'
    },
    resolve: {
        extensions: ['.ts', '.tsx', '.js', '.vue', '.json'] // 解析文件顺序
    },
    module: {
        rules: [{ // 识别vue
                test: /\.vue$/,
                use: 'vue-loader',
            },
            { // 识别tsx
                test: /\.(ts|js)x?$/,
                exclude: /node_modules/,
                loader: 'babel-loader'
            },
            { // 识别图标...
                test: /\.(svg|otf|ttf|woff|eot|gif|png)$/,
                loader: 'url-loader',
            },
            { // 识别样式
                test: /\.(scss|css)$/,
                use: [
                    'style-loader',
                    'css-loader',
                    'sass-loader'
                ]
            }
        ],
    },
    plugins: [
        new VueLoaderPlugin(),
        new HtmlWebpackPlugin({ // html插件
            template: path.resolve(__dirname, 'template.html')
        })
    ]
}
```

package.json

```json
  "scripts": {
    "play-dev": "webpack serve --config ./play/webpack.config.js"
  },
```

运行

```shell
npm run play-dev
```

![image-20231029195152882](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202310291951951.png)

### 组件样式处理

在编写样式之前，推荐先看以下推荐的文章

* [CSS之BEM命名规范](https://zhuanlan.zhihu.com/p/122214519)
* [BEM代码规范简单介绍](https://www.cnblogs.com/qianduan-lucky/p/15858916.html)
* [BEM 命令规范](https://www.jianshu.com/p/418f95a54623)

> 全部:：x-xx
>
> 局部： __名称
>
> 修饰：--success
>
> 状态：is-

```
│ button.scss
│ icon.scss
├─common
│    var.scss # 提供scss变量
├─fonts # 字体
└─mixins
     config.scss # 提供名字
     mixins.scss # 提供mixin方法
  index.scss  # 整合所有scss
```

#### 基本样式

packages下新建theme-chalk目录

packages/theme-chalk/src/mixins/config.scss

```scss
// 提供名字
$namespace:'d'; // 修饰命名空间
$state-prefix: 'is-';// 修饰状态
$modifier-separator:'--'; // 修饰类型的
$element-separator: '__'; // 划分空间分隔符
```

packages/theme-chalk/src/common/var.scss

```scss
// 提供scss变量
@import "../mixins/config.scss";
$--color-primary: #409EFF;
$--color-white: #FFFFFF;
$--color-black: #000000;
$--color-success: #67C23A;
$--color-warning: #E6A23C;
$--color-danger: #F56C6C;
$--color-info: #909399;
```

packages/theme-chalk/src/mixins/mixin.scss

```scss
// 提供mixin方法
@import "../common/var.scss";

// @include b(button) { // 相当于.d-button{}
//   @include when(disable) { // 相当于.d-button{.is-disable{}}

//   }
// }

// .d-button{}
@mixin b($block) {
    $B: $namespace+'-'+$block; // $B相当与d-button
    .#{$B}{ // 相当于.d-button{ 样式内容  }
        @content;
    }
}
// .d-button.is-xxx
@mixin when($state) {
    @at-root { // d-button
        &.#{$state-prefix + $state} {
            @content;
        }
    }
}
// &--primary => .d-button--primary
@mixin m($modifier) {
    @at-root {
        #{&+$modifier-separator+$modifier} {
            @content;
        }
    }
}
// &__header  => .d-button__header
@mixin e($element) {
    @at-root {
        #{&+$element-separator+$element} {
            @content;
        }
    }
}
```

## Icon组件

### 下载图标

阿里图标库

官网：https://www.iconfont.cn/

选择自己想要的图标，添加到购物车

点击添加至项目,然后点击项目设置

![image-20231029210805476](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202310292108554.png)

前缀填写`d-icon-`，fontFamily填写 `d-ui-icons`

![image-20231029211756825](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202310292117928.png)

最后点击下载到本地

![image-20231029211354343](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202310292113430.png)

### 导入图标

复制图中三个文件到packages/theme-chalk/src/fonts目录下

![image-20231029213423936](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202310292134020.png)

复制iconfont.css文件里面的内容到packages/theme-chalk/src/icon.scss文件夹下

```scss
// 引入以下两个文件
@import "./common/var.scss";
@import "./mixins/mixin.scss";
// 并修改上述三个文件的地址
@font-face {
  font-family: "d-ui-icons"; /* Project id 4306789 */
  src: url('./fonts/iconfont.woff2') format('woff2'),
       url('./fonts/iconfont.woff') format('woff'),
       url('./fonts/iconfont.ttf') format('truetype');
}
// [class^='#{$namespace}-icon-'] 自动填充前缀
```

theme-chalk/src/icon.scss

```scss
@import "./common/var.scss";
@import "./mixins/mixin.scss";

@font-face {
  font-family: "d-ui-icons"; /* Project id 4306789 */
  src: url('./fonts/iconfont.woff2') format('woff2'),
       url('./fonts/iconfont.woff') format('woff'),
       url('./fonts/iconfont.ttf') format('truetype');
}
// 问题 i class ="d-ui-icons d-icon-tabqiehuan"
// 用了 d-icon  自动的添加前缀
[class^='#{$namespace}-icon-'] {
  font-family: "d-ui-icons" !important;
  font-size: 16px;
  font-style: normal;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

.d-icon-tabqiehuan:before {
  content: "\e75d";
}

.d-icon-chakan:before {
  content: "\e75f";
}
....
```

packages/theme-chalk/src/index.scss

```scss
//集合样式
@import "./button.scss";
@import "./icon.scss";
```

在theme-chalk/src目录下创建package.json,并以下内容，并且执行命令`yarn install`

```json
{
  "name": "theme-chalk",
  "version": "0.0.0"
}
```

### 使用样式

全局引入

play/main.ts

```typescript
import {createApp} from 'vue'
import App from './App.vue'

//引入 组件 全局
import Dui from 'd-ui'
// 全局引入样式
import 'theme-chalk/src/index.scss'

createApp(App).use(Dui).mount("#app")
```

修改packages/icon/src/icon.vue

```vue
<template>
  <i :class="`d-icon-${name}`"></i>
</template>

<script lang="ts">
import { defineComponent } from "vue";
export default defineComponent({
  name:'DIcon',
  props: {
    name: {
      title: String,
      default: ''
    }
  }
})
</script>
```

App.vue

```vue
<template>
  <div>app
      <d-button></d-button>
      <d-Icon name="tabqiehuan"></d-Icon>
      <d-Icon name="chakan"></d-Icon>
  </div>
</template>
```

运行 `npm run play-dev`

![image-20231029220432798](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202310292204888.png)

## Button组件

packages/button/src/button.vue

```vue
<template>
  <button :class="classes">
    <i v-if="loading" class="d-icon-jiazai"></i>
    <i v-if="icon && !loading" :class="icon"></i>
    <!-- 如果没有传值就不显示span这个标签 -->
    <span v-if="$slots.default"><slot></slot></span>
  </button>
</template>

<script lang="ts">
import { computed, defineComponent, PropType } from "vue";
type buttonType = "primary"|"success"|"danger"|'info'|"text"|"warning"
export default defineComponent({
  name: "DButton",
  props: {
    type: {
      type: String as PropType<buttonType>,
      vaildator: (val: string) => {
        return [ "primary","success","danger",'info',"text","warning"].includes(val) 
      },
      default: "primary"
    },
    icon: {
      type: String,
      default: ''
    },
    plain: Boolean,
    round: Boolean,
    circle: Boolean,
    loading: Boolean,
    disabled: Boolean,
  },
  setup(props, ctx) {
      const classes = computed(() => [
        "d-button",
        //修饰动态的样式
        "d-button--" + props.type,
        {
          "is-plain": props.plain,
          "is-round": props.round,
          "is-circle": props.circle,
          "is-loading": props.loading,
          "is-disabled": props.disabled
        }
      ])

      return {
        classes
      }
  },
});
</script>
```

packages/theme-chalk/src/mixins/mixin.scss

新增button-type方法，用来处理不同的按钮类型

```scss
//处理button-type
@mixin button-type($color,$border-color,$backgound){
    border: 1px solid;
    color:$color;
    border-color:$border-color;
    background:$backgound
}
```

button.scss

```scss
@import "./common/var.scss"; // 变量
@import "./mixins/mixin.scss"; // 方法

@include b(button) {
  display: inline-block;
  line-height: 1;
  min-height: 40px;
  white-space: nowrap;
  cursor: pointer;
  outline: none;
  padding:0 15px;
  background:rgb(219, 201, 201);
  vertical-align: middle;
  border:rgb(219, 201, 201);
  border-radius: 5px;
  //在嵌套中只要样式 是 x-cion
  & [class*='#{$namespace}-icon-'] {
      vertical-align: middle;
      & + span {
        margin-left: 5px;
      }
    }
  //状态  when
 
  @include when(disabled){
      cursor: not-allowed;
  }
  @include when(round){
      border-radius:20px ;
  }
  @include when(circle){
    border-radius: 50%;
  }
  @include when(loading){
   pointer-events: node;
  }
  // button组件的样式 ： 
  @include m(primary){
         @include button-type($--color-white,$--color-primary,$--color-primary)  
  }
  @include m(success){
      @include button-type($--color-white,$--color-success,$--color-success);
      &:hover,
      &:focus {
        background: $--color-primary;
        border-color:$--color-primary;
        color: red;
      }
  }
  @include m(info){
      @include button-type($--color-white,$--color-info,$--color-info)  
  }
  @include m(danger){
      @include button-type($--color-white,$--color-danger,$--color-danger)  
  }
  @include m(warning){
    @include button-type($--color-white,$--color-warning,$--color-warning)  
}
}
```

最后记得在index.scss里面引入button.scss

App.vue进行测试

```vue
<template>
  <div>
    <div>
      <d-button>Default</d-button>
      <d-button type="primary" loading>Primary</d-button>
      <d-button type="success">Success</d-button>
      <d-button type="info">Info</d-button>
      <d-button type="warning" disabled>Warning</d-button>
      <d-button type="danger" round>Danger</d-button>
    </div>
    <div style="margin: 10px 0;">
      <d-button plain>Plain</d-button>
      <d-button type="primary" plain>Primary</d-button>
      <d-button type="primary" icon="d-icon-tabqiehuan" circle></d-button>
      <d-button type="success" icon="d-icon-chakan">按钮</d-button>
      <d-button type="warning" :loading="buttonLoading">加载</d-button>
    </div>
  </div>
</template>
<script lang="ts">
import {defineComponent, onMounted, ref} from 'vue'
function useButton() {
  let buttonLoading = ref(true)
  onMounted(()=>{
      setTimeout(() => {
          buttonLoading.value = false;
      }, 2000);
  });
  return {
    buttonLoading
  }
}

export default defineComponent({
  setup() {
    return {
      ...useButton()
    }
  },
})

</script>
```

![image-20231030160921703](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202310301609792.png)

## Button-group组件

### 编写组件

packages\button\src\button-group.vue

> 为什么要写button目录下？
>
> 参考官方的写法，并且这个组件也没有很多样式

```vue
<template>
  <div class="d-button-group">
    <slot></slot>
  </div>
</template>

<script lang="ts">
import {defineComponent} from "vue"
export default defineComponent({
  name: 'DButtonGroup'
})
</script>
```

生成button-group文件

```shell
lerna create button-group
```

packages\button-group\index.ts

```typescript
import {App} from "vue"
import ButtonGroup from "../button/src/button-group.vue"

ButtonGroup.install = (app: App): void => {
  app.component(ButtonGroup.name, ButtonGroup)
}

export default ButtonGroup;
```

最后要在packages\d-ui\index.ts中引入，目的是全局引入

### 编写样式

packages\theme-chalk\src\button-group.scss

```scss
@import "./common/var.scss";
@import "./mixins/mixin.scss";

@include b(button-group) {
  
  &>.#{$namespace}-button {
    
      &:first-child {
          border-top-right-radius: 0;
          border-bottom-right-radius: 0;
      }
      &:nth-child(n+2) {
        margin-left: 1px;
      }
      // 除了第一个和最后一个，其他元素的角度为0
      &:not(:first-child):not(:last-child) {
        border-radius: 0;
      }
      &:last-child {
          border-top-left-radius: 0;
          border-bottom-left-radius: 0;
      }
  }
}
```

样式文件要在index.scss中引入

### 测试

App.vue

```vue
    <div>
      <div>ButtonGroup</div>
      <div style="display: flex;">
        <d-button-group>
          <d-button type="primary" icon="d-icon-jiantou_shangyiye">上一页</d-button>
          <d-button type="primary" >下一页<i class="d-icon-jiantou_xiayiye"></i></d-button>
        </d-button-group>
        <d-button-group style="margin-left: 10px;">
          <d-button type="primary" icon="d-icon-jiantou_shangyiye" />
          <d-button type="primary" icon="d-icon-chakan" />
          <d-button type="primary" icon="d-icon-jiantou_xiayiye" />
        </d-button-group>
      </div>
    </div>
```

## 改造展现文档

安装vue-router

```shell
yarn add vue-router -W
```

App.vue

```vue
<template>
  <div class="app_container">
    <div class="app_header"></div>
    <div class="app_center">
      <div class="app_menu">
        <ul>
          <li v-for="item in menu">
            <router-link active-class="active" :to="'/' + item">{{item}}</router-link>
          </li>
        </ul>
      </div>
      <div class="app_content">
        <router-view></router-view>
      </div>
    </div>
  </div>
</template>
<script setup lang="ts">
import { reactive } from "vue";

const menu = reactive(["button","button-group"])
</script>
<style lang="scss" scope>
.app_container {
  width: 100%;
  height: 100%;
  .app_header {
    width: 100%;
    height: 60px;
    background-color: cadetblue;
  }
  .app_center {
    display: flex;
    height: 100%;
    .app_menu {
      width: 200px;
      height: 100%;
      border-right: 1px solid #ccc;
      padding: 20px 0;
      ul {
        list-style: none;
        li {
          height: 30px;
          line-height: 30px;
          text-align: center;
          cursor: pointer;
          a {
            display: block;
          }
        }
        li:hover {
          color: blue;
          background-color: burlywood;
        }
      }
    }
    .app_content {
      width: 100%;
      padding: 20px;
    }
  }
 }
</style>
```

router/index.ts

```typescript
import {createRouter, createWebHashHistory} from "vue-router"

const routes = [
  {
    path: '/button',
    name: 'button',
    component: () => import("../views/button.vue")
  },
  {
    path: '/button-group',
    name: 'button-group',
    component: () => import("../views/button-group.vue")
  }
]

const router = createRouter({
  history: createWebHashHistory(),
  routes
})

export default router

```

style/index.css

```css
* {
  margin: 0;
  padding: 0;
}
html, body, #app {
  width: 100%;
  height: 100%;
}
a {
  text-decoration: none;
}

.active {
  background-color: #d9ecff;
  color: #409eff;
}
```

main.ts

// 引入全局样式和引入路由

```typescript
import {createApp} from 'vue'
import App from './App.vue'
import Router from './router/index'


//引入 组件 全局
import Dui from 'd-ui'
// 全局引入样式
import 'theme-chalk/src/index.scss'

import './style/index.css'

createApp(App).use(Dui)
.use(Router).mount("#app")
```

最终展示效果

![image-20231031162244280](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202310311622375.png)

## Layout 布局

```shell
leran create row # 名字填 @d-ui/row
leran create col # 名字填 @d-ui/col
```

这种找不到包的情况，执行一下`yarn install`

![image-20231031164917397](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202310311649471.png)

### Row编写组件

packages\row\src\row.ts

> 为什么要用ts来写，为不用vue，是因为要自定义标签，如果有vue标签的话会有很多if判断

```typescript
import {defineComponent, h, PropType, computed, provide} from "vue"
type justifyType = 'start' | 'end' | 'center' | 'space-around' | 'space-between' | 'space-evenly'
export default defineComponent({
  name: "DRow",
  props: {
    tag: { // 自定义元素标签
      type: String,
      default: 'div'
    },
    gutter: { // 栅格间隔
      type: Number,
      default: 0
    },
    justify: { // 	flex 布局下的水平排列方式
      type: String as PropType<justifyType>,
      vaildator: (val : string)=> {
        return ['start','end', 'center','space-around', 'space-between', 'space-evenly'].includes(val)
      },
      default: "start" 
    },
    align: {
      type: String,
      default: ""
    }
  },
  setup(props, {slots}) {
    //父组件中提供数据 provide  子组件中使用
    provide('DRow',props.gutter)
    const classs = computed(() => [
        'd-row',
        props.justify !== 'start' ? `is-justify-${props.justify}` : ""
    ])
    //解决gutter 给开头和结尾元素和容器对齐
    const styles = computed(() => {
      let res = {
        marginLeft: '',
        marginRight: ''
      }
      if(props.gutter) {
        res.marginLeft = res.marginRight =  `-${props.gutter/2}px`;
      }
      return res
    })

    return () => h(props.tag, {
      class: classs.value,
      style: styles.value
    }, slots.default?.()) // 相当于slots.default && slots.default()
  }
})
```

packages\col\index.ts

```typescript
import {App} from "vue"

import DCol from "./src/col"

DCol.install = (app: App) => {
  app.component(DCol.name, DCol)
}

export default DCol
```

别忘了在d-ui/index.ts中引入

### Row样式

packages\theme-chalk\src\row.scss

```scss
@import "./common/var.scss"; // 变量
@import "./mixins/mixin.scss"; // 方法

@include b(row) {
  display: flex;
  flex-wrap: wrap;
     //添加is-
  @include when(justify-end){ //  is-justify-end
    justify-content:flex-end;
  }
  @include when(justify-center){ //  is-justify-center
    justify-content:center;
  }
  @include when(justify-space-around){ //  is-justify-space-around
    justify-content:space-around;
  }
  @include when(justify-space-between){ //  is-justify-space-between
    justify-content:space-between;
  }
  @include when(justify-space-evenly){ //  is-justify-space-evenly
    justify-content:space-evenly;
  }
}
```

最后别忘了在index.scss中引入

### Col组件编写

packages\col\src\col.ts

```typescript
import { defineComponent, h, computed,inject } from 'vue';

export default defineComponent({
  name: "DCol",
  //用户属性  tag
  props: {
    tag: {
        type: String,
        default: 'div'
    },
    span: {
        type: Number,
        default: 24
    },
    offset: {
        type: Number,
        default: 0
    }
  },

  setup(props, ctx) {
    //我们已经定好属性  通过计算属性  d-col-span - 5   d-col-offset - 5 
    const gutter = inject('DRow', 0)
    console.log('gutter值', gutter)
    const classs = computed(() => {
      let ret = []
      const pops = ["span", "offset"] as const
      pops.forEach((item) => {
        const num = props[item]
        if(typeof num == "number" && num > 0) {
          ret.push(`d-col-${item}-${num}`)
        }
      })

      return [
        'd-col',
        ...ret
      ]
    })
    // gutter处理
    const styles = computed(() => {
      if(gutter != 0) {
        return {
          paddingLeft: gutter / 2 +'px',
          paddingRight: gutter / 2 + 'px'
        }
      } else {
        return {}
      }
    })
    return () => h(props.tag, {
      class: classs.value,
      style: styles.value
    }, ctx.slots.default?.())
  }
})
```

index.ts

```typescript
import {App} from "vue"

import DRow from "./src/row"

DRow.install = (app: App) => {
  app.component(DRow.name, DRow)
}

export default DRow
```

别忘了在d-ui/index.ts中引入

### Col样式

packages\theme-chalk\src\col.scss

```scss
@use 'sass:math';

@import "./common/var.scss"; // 变量
@import "./mixins/mixin.scss"; // 方法

@include b(col) {
  &[class*='#{$namespace}-col-'] {
    box-sizing: border-box;
  }
  @for $i from 0 through 24 {
    &.d-col-span-#{$i} { // d-col-span-5
      max-width: (math.div(1, 24) * $i *100) * 1%;
      flex: (math.div(1, 24) * $i *100) * 1%;
    }
    &.d-col-offset-#{$i} { // d-col-offset-10
      margin-left: (math.div(1, 24) * $i *100) * 1%;
    }
  }
}
```

最后别忘了在index.scss中引入

### 测试

![image-20231031210031254](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202310312100366.png)

```vue
<template>
  <div>
    <h1>Layout布局组件-Row-Col</h1>
    <div>
      span	栅格占据的列数
      <d-row tag="div">
        <d-col tag="span" :span="6">
          <div style="background:red;">11</div>
        </d-col>
        <d-col tag="span" :span="6">
          <div style="background:blue;">22</div>
        </d-col>
        <d-col tag="span" :span="6">
          <div style="background:pink;">33</div>
        </d-col>
        <d-col tag="span" :span="6">
          <div style="background: green;">44</div>
        </d-col>
      </d-row>
    </div>
    <div style="margin: 10px 0;" >
      offset	栅格左侧的间隔格数
      <d-row tag="div" >
        <d-col tag="span" :span="2">
          <div style="background:red;">11</div>
        </d-col>
        <d-col tag="span" :span="2" :offset="8">
          <div style="background:blue;">offset8</div>
        </d-col>
        <d-col tag="span" :span="2">
          <div style="background:pink;">33</div>
        </d-col>
        <d-col tag="span" :span="2" :offset="8">
          <div style="background: green;">offset8</div>
        </d-col>
      </d-row>
    </div>
    <div style="margin: 10px 0;" >
      justify	flex 布局下的水平排列方式
      <d-row tag="div" justify="space-between">
        <d-col tag="span" :span="2">
          <div style="background:red;">11</div>
        </d-col>
        <d-col tag="span" :span="2">
          <div style="background:blue;">22</div>
        </d-col>
        <d-col tag="span" :span="2">
          <div style="background:pink;">33</div>
        </d-col>
        <d-col tag="span" :span="2">
          <div style="background: green;">44</div>
        </d-col>
      </d-row>
    </div>
    <div style="margin: 10px 0;" >
      gutter	栅格间隔
      <d-row tag="div" :gutter="20">
        <d-col tag="span" :span="6">
          <div style="background:red;">11</div>
        </d-col>
        <d-col tag="span" :span="6">
          <div style="background:blue;">22</div>
        </d-col>
        <d-col tag="span" :span="6">
          <div style="background:pink;">33</div>
        </d-col>
        <d-col tag="span" :span="6">
          <div style="background: green;">44</div>
        </d-col>
      </d-row>
    </div>
  </div>
</template>
<script lang="ts">
import {defineComponent} from 'vue'
export default defineComponent({
  name: "RowCol",
  setup() {
  
  },
})

</script>
```

## checkbox组件

```shell
lerna create checkbox  # 包名填 @d-ui/checkbox
```

### 组件属性

packages\checkbox\src\checkbox.type.ts

```typescript
export interface ICheckBoxProps {
  name?: string, // input中name属性
  label?: string | boolean | number, // v-model为array时使用
  modelValue: string | boolean | number, // 绑定的值
  indeterminate?: boolean // 是否半选
  disabled?: boolean // 禁用
  checked?: boolean // 是否选中
}
```

### checkbox组件编写

packages\checkbox\src\useCheckBoxProps.ts

```typescript
import { ICheckBoxProps } from "./checkbox.type"
import { computed, getCurrentInstance } from "vue"

// 处理modelValue
function useModel(props: ICheckBoxProps) {
  // emit 可以通过ctx上下文来获取的，也就是setup(props,ctx)
  // 这里为了方便使用getCurrentInstance方法来获取当前用户的实例
  let { emit } = getCurrentInstance()
  // 通过计算属性来处理
  const model = computed({
    get() { // 获取值
      return props.modelValue
    },
    set(val) { // 值改变通过自定义事件通知父组件
      emit("update:modelValue", val)
    }
  })
  return model
}
// 是否是选中状态
function usecheckbox(props: ICheckBoxProps, model) {
  const isChecked = computed(() => {
    const value = model.value
    return value
  })
  return isChecked;
}


function useEvent() {
  let { emit } = getCurrentInstance();
  function handChange(e) {
    const target = e.target
    const value = target.isChecked ? true : false
    emit("change", value)
  }
  return handChange
}

export const useCheckBoxProps = (props: ICheckBoxProps) => {
  let model = useModel(props);
  // 是否选中状态
  let isChecked = usecheckbox(props,model)
  // 触发事件
  let handChange = useEvent()
  return {
    model,
    isChecked,
    handChange
  }
}
```

packages\checkbox\src\checkbox.vue

```vue
<template>
  <div class="d-checkbox">
    <span class="d-checkbox__input">
      <input type="checkbox" 
      v-model="model"  
      :disabled="disabled"
      :indeterminate="indeterminate"
      :name="name"
      :checked="isChecked"
      @change="handChange"
      :value="label"
      >
    </span>
    <span class="d-checkbox__label">
      <slot></slot>
    </span>
  </div>
</template>
<script lang="ts">
import { defineComponent } from "vue"
import { useCheckBoxProps } from "./useCheckBoxProps"
export default defineComponent({
  name: "DCheckbox",
  props: {
    indeterminate: Boolean, //半选
    checked: Boolean,
    name: String,
    disabled: Boolean,
    label: [String, Number, Boolean],
    modelValue: [String, Number, Boolean] //双向数据绑定
  },
  emits:["update:modelValue", "change"],
  setup(props) {
    return {
      ...useCheckBoxProps(props)
    }
  },
})
</script>
```

packages\checkbox\index.ts

```typescript
import { App } from "vue"
import Checkbox from "./src/checkbox.vue"

Checkbox.install = (app: App) => {
  app.component(Checkbox.name, Checkbox);
}

export default Checkbox;
```

### 测试

```vue
<template>
  <div>
    <h1>CheckBox组件</h1>
    {{ checkboxValue }}
    <d-checkbox v-model="checkboxValue" @change="handleChange">1111</d-checkbox>
    <d-checkbox v-model="checkboxValue1" :disabled="disabled">2222</d-checkbox>
    <d-checkbox v-model="checkboxValue2" indeterminate>3333</d-checkbox>
  </div>
</template>
<script lang="ts">
import { defineComponent, ref } from 'vue'

export default defineComponent({
  name: "checkbox",
  setup() {
    const checkboxValue = ref(true)
    const checkboxValue1 = ref(false)
    const checkboxValue2 = ref(true)
    const disabled = ref(true)
    function handleChange(val) {
      console.log("复选框发生了变化", val)
    }
    return {
      checkboxValue,
      checkboxValue1,
      checkboxValue2,
      disabled,
      handleChange
    }
  },
})
</script>
```

![image-20231102222146177](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202311022221268.png)

## checkboxGroup组件

```shell
lerna create checkgroup-box # @d-ui/checkgroup-box
```

> 整体思想：
>
> 通过`v-model`绑定数组值到==d-checkbox-group==上,当子组件选中状态发生变化后，就会触发==d-checkbox-group==，的自定义事件`update:modelValue`和`change`(这两个方法都在`useProvide.handChange`)
>
> ```typescript
> const model = computed({
>     get() { // 获取值
>       // return props.modelValue
>       return useProvide.modelValue?useProvide.modelValue.value:props.modelValue;
>     },
>     set(val) { // 值改变通过自定义事件通知父组件
>       if(useProvide.modelValue) {
>         return useProvide.handChange(val);
>       } 
>       emit("update:modelValue", val)
>     }
>   })
> ```
>
> 父组件（==d-check-group==）初始化时传入的（`v-model`）数组数据,通过传入的数据数组中是否包括该组件来实现子组件（==d-checkbox==）的选中状态
>
> ```typescript
> // 是否是选中状态
> function usecheckbox(props: ICheckBoxProps, model) {
>   const isChecked = computed(() => {
>     const value = model.value
>     if(Array.isArray(value)) {
>       return value.includes(props.label)
>     } else { // checkbox单个使用
>       return value
>     }
>   })
>   return isChecked;
> }
> ```

### 组件编写

packages\checkbox\src\checkboxGroup.vue

```vue
<template>
  <div class="d-checkbox-group">
        <slot></slot>
  </div>
</template>

<script lang="ts">
import { computed, defineComponent, provide } from "vue"

export default defineComponent({
  name: "DCheckboxGroup",
  props: {
    modelValue: Array // 给子组件提供数据
  }, 
  emits: ["update:modelValue","change"],
  setup(props, { emit }) {
    let modelValue = computed(() => props.modelValue);
    const handChange = (val) => {
      emit("update:modelValue", val);
      emit("change", val);
    }
    // 给子组件提供数据
    provide("DCheckBoxGroup", {
      modelValue,
      handChange,
      name: "DCheckBoxGroup"
    })
  },
})
</script>
```

packages\checkbox\src\checkbox.type.ts

```typescript
export interface ICheckBoxProps {
  name?: string, // input中name属性
  label?: string | boolean | number, // v-model为array时使用
  modelValue: string | boolean | number, // 绑定的值
  indeterminate?: boolean // 是否半选
  disabled?: boolean // 禁用
  checked?: boolean // 是否选中
}

import { ComputedRef } from "vue"
export interface IGroupProvide {
  modelValue?:ComputedRef,
  handChange?:(val: unknown) => void
}
```

packages\checkbox\src\useCheckBoxProps.ts

```typescript
import { ICheckBoxProps, IGroupProvide } from "./checkbox.type"
import { computed, getCurrentInstance, inject } from "vue"

// 处理modelValue
function useModel(props: ICheckBoxProps) {
  // emit 可以通过ctx上下文来获取的，也就是setup(props,ctx)
  // 这里为了方便使用getCurrentInstance方法来获取当前用户的实例
  let { emit } = getCurrentInstance()

  // 获取父组件传过来的数据
  let useProvide = inject<IGroupProvide>("DCheckBoxGroup", {})

  // 通过计算属性来处理
  const model = computed({
    get() { // 获取值
      // return props.modelValue
      return useProvide.modelValue?useProvide.modelValue.value:props.modelValue;
    },
    set(val) { // 值改变通过自定义事件通知父组件
      if(useProvide.modelValue) {
        return useProvide.handChange(val);
      } 
      emit("update:modelValue", val)
    }
  })
  return model
}
// 是否是选中状态
function usecheckbox(props: ICheckBoxProps, model) {
  const isChecked = computed(() => {
    const value = model.value
    if(Array.isArray(value)) {
      return value.includes(props.label)
    } else { // checkbox单个使用
      return value
    }
  })
  return isChecked;
}

function useEvent() {
  let { emit } = getCurrentInstance();
  function handChange(e) {
    const target = e.target
    const value = target.checked ? true : false
    e.stopPropagation();
    emit("change", value)
  }
  return handChange
}

export const useCheckBoxProps = (props: ICheckBoxProps) => {
  let model = useModel(props);
  // 是否选中状态
  let isChecked = usecheckbox(props,model)
  // 触发事件
  let handChange = useEvent()
  return {
    model,
    isChecked,
    handChange
  }
}
```

packages\checkbox-group\index.ts

```typescript
import { App } from "vue"
import checkBoxGroup from "../checkbox/src/checkboxGroup.vue"

checkBoxGroup.install = (app: App) => {
  app.component(checkBoxGroup.name, checkBoxGroup)
}

export default checkBoxGroup
```

最后别忘了在d-ui的index.ts中引入，目的是全局引入

#### 测试

play\views\checkbox-group.vue

```vue
<template>
  <div>
    <h1>CheckBoxGroup组件</h1>
    <div>
      {{ checkedCities }}
      <d-checkbox
      v-model="checkAll"
      :indeterminate="isIndeterminate"
      @change="handleCheckAllChange"
      >Check all</d-checkbox
    >
    <d-checkbox-group
      v-model="checkedCities"
      @change="handleCheckedCitiesChange"
    >
      <d-checkbox v-for="city in cities" :key="city" :label="city"></d-checkbox>
    </d-checkbox-group>
    </div>
  </div>
</template>
<script lang="ts">
import { defineComponent, ref } from 'vue'

export default defineComponent({
  name: "checkbox-group",
  setup() {
    const checkAll = ref(false)
    const isIndeterminate = ref(true)
    const checkedCities = ref(['北京', '上海'])
    const cities = ['北京', '上海', '广州', '深圳']

    const handleCheckAllChange = (val: boolean) => {
      console.log(val)
      checkedCities.value = val ? cities : []
      checkAll.value = val
      isIndeterminate.value = false
    }
    const handleCheckedCitiesChange = (value: string[]) => {
      const checkedCount = value.length
      checkAll.value = checkedCount === cities.length
      isIndeterminate.value = checkedCount > 0 && checkedCount < cities.length
    }
    return {
      checkAll,
      isIndeterminate,
      checkedCities,
      cities,
      handleCheckAllChange,
      handleCheckedCitiesChange
    }
  },
})
</script>
```

![image-20231105153730208](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202311051537312.png)

## Transfer组件

```shell
lerna create transfer # @d-ui/transfer
```

### 组件编写

#### 定义组件属性

packages\transfer\src\transfer.type.ts

```typescript
export type key = string|number
export type IDate = {
    key: key,
    label:string,
    disabled:boolean
}
export type Props = {
    key: string,
    label:string,
    disabled:string
}
export interface ItransferProps{
    data:IDate[], //数据源
    modelValue: key[], //右侧数据
    props:Props //别名
}
```

#### 组件面板transfer-panel编写

packages\transfer\src\transfer-panel.vue

![image-20231109171413805](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202311091714882.png)

```vue
<template>
  <div class="d-transfer-panel">
    <div class="d-transfer-panel__header">
      <d-checkbox v-model="allCheck"  @change="handleChange">全选/半选</d-checkbox>
    </div>
    <div class="d-transfer-panel__body">
      <d-checkbox-group v-model="checked">
        <d-checkbox v-for="item in data" :key="item[keyProps]" :label="item[keyProps]" :disabled="item[disabledPorps]"></d-checkbox>
      </d-checkbox-group>
    </div>
  </div>
</template>

<script lang="ts">
import { defineComponent, reactive, toRefs } from "vue"
import DCheckbox from "@d-ui/checkbox"
import DCheckboxGroup from "@d-ui/checkbox-group"
import {useCheck} from './useCheck'

export default defineComponent({
  name: "DtransferPanel",
  components: {
    DCheckbox,
    DCheckboxGroup
  },
  props:{
    data:{
        type:Array,
        default:()=>[]
    },
    props:{
      type:Object
    }
  },
  emits:["checkChange"],
  setup(props) {
    //注意 （1）处理数据
    const State = reactive({
      checked:[],
      allCheck:false //是否全选
    })
    let  {labelProps,keyProps,disabledPorps,handleChange} = useCheck(props,State)
    return {
      ...toRefs(State),
      labelProps,keyProps,disabledPorps,handleChange
    }
  },
})
</script>

```

packages\transfer\src\useCheck.ts

```typescript
import { computed, getCurrentInstance, watch } from "vue"
export const useCheck = (props, State) => {
  let { emit } = getCurrentInstance()
  // 变成响应式
  const labelProps = computed(() => props.props.label)
  const keyProps = computed(() => props.props.key)
  const disabledPorps = computed(() => props.props.disabled)
  
  // 处理全选和反选
  const checkDisAble = computed(() => {
    return props.data.filter(item => !item[disabledPorps.value])
  })
  
  const handleChange = (val) => {
    State.allCheck  = val
    State.checked = val?checkDisAble.value.map(item=>{
      return item[keyProps.value]
    }):[]
  }

  // 实现反选功能（下面的按钮取消勾选之后，全选按钮取消）
  watch(() => State.checked, () => {
    // 获取所有的key
    let checkeys = checkDisAble.value.map(item => item[keyProps.value]);
    State.allCheck = checkeys.length > 0 && checkeys.every(key => State.checked.includes(key));
    // 通知父组件，选中发生改变，为穿梭功能提供数据
    emit("checkChange", State.checked);
    // 实现穿梭，原理就是兄弟间组件传值 （这里采用借助父组件的形式）
  })
  
  // 解决穿梭之后全选还在的问题
  watch(() => props.data, () => {
    State.allCheck = false;
  })


  return{
    labelProps,
    keyProps,
    disabledPorps,
    handleChange
 }
}
```

#### transfer组件编写

packages\transfer\src\transfer.vue

```vue
<template>
  <div class="d-transfer">
    <d-transfer-panel :data="sourceData" :props="props" @checkChange="sourceCheckChange">左侧</d-transfer-panel>
    <div class="d-transfer__buttons">
      <d-button icon="d-icon-jiantou_shangyiye" :disabled="rightState.length === 0" @click="leftClick">去左</d-button>&nbsp;
      <d-button icon="d-icon-jiantou_xiayiye" :disabled="leftState.length === 0" @click="rightClick">去右</d-button>
    </div>
    <d-transfer-panel :data="targetData" :props="props" @checkChange="targteCheckChange">右侧</d-transfer-panel>
  </div>
</template>

<script lang="ts">
import { defineComponent, PropType, reactive, toRefs } from "vue"
import DTransferPanel from "./transfer-panel.vue"
import DButton from "@d-ui/button"
import { IDate } from './transfer.type';
import { useComponentData } from "./useComponentData"

export default defineComponent({
  name: "DTransfer",
  components: {
    DTransferPanel,
    DButton
  },
  props:{
    data:{
      type: Array as PropType<IDate[]>
    },
    props:{ //别名
      type:Object
    },
    modelValue:{
      type:Array
    }
  },
  setup(props, {emit}) {
    // 获取左右列表选中的数据
    let checkState = reactive({
      leftState: [],
      rightState: []
    })
    const sourceCheckChange = (leftValue) => {
      console.log("left", leftValue);
      checkState.leftState = leftValue;
    }
    const targteCheckChange = (rightValue) => {
      console.log("right", rightValue);
      checkState.rightState = rightValue;
    }
    // 穿梭点击事件
    const leftClick = () => { // 右边的数据给左边
      // 获取到右边的数据
      let currentValue = props.modelValue.slice(0);

      // 选中的值在右边删除
      checkState.rightState.forEach(item => {
        let index = currentValue.indexOf(item); // 找不到就是-1
        if(index > -1) {
          currentValue.splice(index, 1);
        }
        // 通知父亲
        emit("update:modelValue", currentValue)
      })
    }
    // 左边的数据到右边
    const rightClick = () => { // 左边的数据给右边
      // 目前右边有的数据
      let currentValue = props.modelValue.slice(0);
      // 合并
      currentValue = currentValue.concat(checkState.leftState);
      emit("update:modelValue", currentValue);
    }
    let {propkey,sourceData,targetData} = useComponentData(props)
    return{
      sourceCheckChange,
      targteCheckChange,
      leftClick,
      rightClick,
      propkey,
      sourceData,
      targetData,
      ...toRefs(checkState)
    }
  },
})
</script>

```

packages\transfer\src\useComponentData.ts

```typescript
import { computed } from "vue"
export const useComponentData = (props) => {
  // console.log(props.data) 
  // 左边的数据
  // 1.获取到key
  let propkey = computed(() => props.props.key)
  // 2.把数组变成对象 []=>{}  {}=[]
  const data = computed(() => { // [{key:1},{key:2}]
    return props.data.reduce((memo, cur) => {
      // console.log("memo", memo)
      memo[cur[propkey.value]] = cur;
    }, {})
  })
  // 3.将数据分 左右
  const sourceData = computed(() => {
    return props.data.filter(item => !props.modelValue.includes(item[propkey.value]))
  })
  // console.log("sourceData", sourceData.value)

  // 右边的数据
  const targetData = computed(() => {
    return props.data.filter(item => props.modelValue.includes(item[propkey.value]))
  })

  // console.log("targetData", targetData.value)

  return {
    propkey,
    sourceData,
    targetData
  }
}
```

### 组件样式编写

packages\theme-chalk\src\transfer.scss

```scss
@import "./common/var.scss"; // 变量
@import "./mixins/mixin.scss"; // 方法

@include b(transfer) {
  display: flex;
  vertical-align: middle;
}

@include b(transfer-panel) {
  width:200px;
  margin:0 20px;
  height:300px;
  border:1px solid rgb(109, 104, 104);
  overflow: hidden;
  @include e(header) {
    display: flex;
    align-items: center;
    height: $--transfer-panel-header-height;
    background-color: $--fill-color-light;
  }
  @include e(body) {
    width:100%;
    height: $--transfer-panel-body-height;
    display: inline-block;
    vertical-align: middle;
    overflow: scroll;
  } 
}
```

### 测试

play\views\transfer.vue

```vue
<template>
  <div>
    <h1>Transfer</h1>
    <d-transfer v-model="rightValue" :data="transferDate" :props="transferProps"></d-transfer>
  </div>
</template>
<script lang="ts">
import { defineComponent, ref } from 'vue'

export default defineComponent({
  name: "transfer",
  setup() {
    const generateData = () => { //数据源
      const data = []
      for (let i = 1; i <= 15; i++) {
        data.push({
          key: i,
          label: 'label' + i,
          disabled: i % 4 === 0,
        })
      }
      return ref(data) //响应数据
    }
    return{
        transferDate:generateData(),
        rightValue: ref([1,4]),
        transferProps:{ //指定属性
          key: "key",
          label: "label",
          disabled:"disabled",
        }
    }
  },
})
</script>

```

![image-20231109171104900](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202311091711994.png)

### 核心功能说明

#### 穿梭功能

在每个`d-transfer-panel`组件上绑定checkChange自定义事件，然后监听内部选中的值，当选中的State.checkd发生改变，就把这个值传过来，绑定到checkState属性上。

点击左按钮，要实现的是右边的数据到左边，因为父组件，也就是调用这个组件的时候d-transfer，v-model绑定的是右边的数据，所有要把v-model绑定的数据暂存下来，然后获取索引，删除已选中的值。这样右边面板的数据变动就实现了。

```typescript
transfer.vue    
// 穿梭点击事件
    const leftClick = () => { // 右边的数据给左边
      // 获取到右边的数据
      let currentValue = props.modelValue.slice(0);

      // 选中的值在右边删除
      checkState.rightState.forEach(item => {
        let index = currentValue.indexOf(item); // 找不到就是-1
        if(index > -1) {
          currentValue.splice(index, 1);
        }
        // 通知父亲
        emit("update:modelValue", currentValue)
      })
    }
```

左边面板数据的变化是如何实现呢？

这是因为左右两边的数据都是计算属性(sourceData,  targetData)动态计算出来的

```vue
transfer.vue
<template>
  <div class="d-transfer">
    <d-transfer-panel :data="sourceData" :props="props" @checkChange="sourceCheckChange">左侧</d-transfer-panel>
    <div class="d-transfer__buttons">
      <d-button icon="d-icon-jiantou_shangyiye" :disabled="rightState.length === 0" @click="leftClick">去左</d-button>&nbsp;
      <d-button icon="d-icon-jiantou_xiayiye" :disabled="leftState.length === 0" @click="rightClick">去右</d-button>
    </div>
    <d-transfer-panel :data="targetData" :props="props" @checkChange="targteCheckChange">右侧</d-transfer-panel>
  </div>
</template>
```

sourceData,  targetData相关计算逻辑

props.modelValue是父组件提供的，因为刚刚点击了左右按钮的时候，已经通知了父组件v-model绑定的值改变，所以父组件v-model绑定的值，子组件的sourceData,  targetData就会重新计算。

```typescript
transfer.vue
// 3.将数据分 左右
  const sourceData = computed(() => {
    return props.data.filter(item => !props.modelValue.includes(item[propkey.value]))
  })
  // console.log("sourceData", sourceData.value)

  // 右边的数据
  const targetData = computed(() => {
    return props.data.filter(item => props.modelValue.includes(item[propkey.value]))
  })
```

点击右按钮，要实现的是左边的数据变到右边，只需要原来的右边数据和选中的左边数据拼接一下就好了

```typescript
  // 左边的数据到右边
    const rightClick = () => { // 左边的数据给右边
      // 目前右边有的数据
      let currentValue = props.modelValue.slice(0);
      // 合并
      currentValue = currentValue.concat(checkState.leftState);
      emit("update:modelValue", currentValue);
    }
```

## Message组件

```shell
lerna create message  #@d-ui/message
```

### 组件编写

packages\message\src\message.type.ts

```typescript
type Itype = "success"|"info"|"error"|"warning"
export interface ImessageProps{
    id?:string,
    message?:string,
    type?:Itype,
    duration?:number,
    center?:boolean,
    onclose?:()=>void,
    offset?:number
}

export type ImessageOptions =  ImessageProps
```

packages\message\src\message.ts

```typescript
import { ImessageOptions, ImessageProps } from "./message.type"
import MessageComponent from "./messageComponent.vue"
import { createVNode, render, getCurrentInstance } from "vue";

let instances : any[] = [] // 保存实例
export default function Message(options: ImessageOptions) {
  if(typeof options === "string") {
    options =  {
      message: options,
      type: "info",
      center: true
    }
  }

  // 添加一个offset
  let offset = options.offset || 20;
  instances.forEach(item => {
    // console.log("组件实例", item)
    offset += 60
  })

  // 处理 清除元素
  let userClose = options.onclose;
  const container = document.createElement("div");

  let ops = {
    ...options,
    offset,
    // 添加事件
    onclose: () => {
      // console.log("关闭事件前执行的操作")
      userClose?.()
    },
    onDestroy: () => {
      render(null, container)
    },
  }
    

  //将template 放到body 
  // (1) createVNode()  将 组件变成一个vnode
  // （2）render() 将vnode变成真实的dom 放到元素
  //（3）放到指定的位置 body 下的儿子
  //对象
  //渲染组件
  // 组件
  //vue3  createVNode :将 组件变成一个vnode
  // console.log(MessageComponent);
  // console.log(createVNode(MessageComponent));
  let vm = createVNode(MessageComponent, ops);

  // 接收父组件的数据
  // vm.props!.onDestory = () => {
  //   console.log("组件销毁");
  //   render(null, container);
  //   console.log(container);
  // }
  // render(组件，位置)
  render(vm, container);

  console.log("当前组件", container)

  // 放到指定的位置 body 下的儿子
  document.body.appendChild(container.firstElementChild!)
  instances.push(vm);
}
```

packages\message\src\messageComponent.vue

```vue
<template>
<!-- 添加动画的效果 
 css    @before-leave="onClose"
 js  transition name="fade" mode="out-in" appear>
-->
<transition name="d-message-fade" @before-leave="onclose" @after-leave="$emit('destroy')">
  <div class="d-message" :class="classs" :style="styles" v-show="show">
    <d-icon name="shaixuan"></d-icon>{{message}}
  </div>
</transition>
</template>
<script lang="ts">
import DIcon from "@d-ui/icon";
import { computed, defineComponent, onMounted, onUnmounted, ref } from "vue"

export default defineComponent({
  props: {
    //重新一次属性
    id:{type:String,default:''},
    message:{type:String,default:""},
    type:{type:String,default:'success' }, // PropType<>
    duration:{
      type:Number,default:2000
    },
    center:{type:Boolean,defalut:true},
    offset:{type:Number,default:20},
    onclose:{ 
      type: Function,
      required: false,
    }
  },
  components: {
    DIcon
  },
  setup(props) {
    let show = ref(false);
    let timer;
    onMounted(() => {
      show.value = true
      time()
    }) 
    // 处理样式
    const classs = computed(() => [
      'd-message--' + props.type,
      props.center?"is-center":""
    ])
    // 定时器
    function time() {
      timer = setTimeout(() => {
        show.value = false;
      }, props.duration)
    }
    // 组件销毁时清除定时器
    onUnmounted(() => {
      clearTimeout(timer);
    })
    // 计算偏移量, style: {top: 20px}
    // 包裹一层小括号是确保 JavaScript 解析器将花括号 {} 视为对象字面量，而不是代码块
    let styles:any = computed(() => ({
      top:`${props.offset}px`
    }))
    return {
      show,
      classs,
      styles
    }
  },
})
</script>
```

### 组件样式编写

packages\theme-chalk\src\message.scss

```scss
@import "./common/var.scss";
@import "./mixins/mixin.scss";

@include b(message) {
  position: fixed;
  top: 20px;
  left: 50%;
  min-width:300px;
  transform: translateX(-50%);
  border-radius: 5px;
  border: 1px solid #ccc;
  height: 40px;
  line-height: 40px;
  display:flex;
  transition: all 0.4s,to; //动画效果
  @include m(success){
      background:$--color-success;
  }
  @include m(info){
   background:$--color-info;
  }
  @include m(warning){
    background:$--color-warning;
  }
  @include m(danger){
    background:$--color-danger;
  }
  @include when(center){
    justify-content: center;
    color:pink,
  }
}

//添加动画
//问题：我们是不是可以根据不同的条件显示的button组件的文字，boder background 不同
   //重新 一个方法根据不同参数去设置
.d-message-fade-enter-from,.d-message-fade-leave-to{
  transform:translate(-50%,-100%) //左右 ,上下
}
```

### 组件测试

play\views\message.vue

```vue
<template>
  <div>
    <h1 class="title">Message</h1>
    <div style="display: flex;">
      <d-button :plain="true" @click="open">Show message</d-button>
      <d-button @click="ClickChange"> 点击出现message </d-button>
    </div>
  </div>
</template>
<script lang="ts">
import { defineComponent } from 'vue';
import Message from "@d-ui/message"
export default defineComponent({
  name: 'Message',
  setup() {
    const open = () => {
      Message('this is a message.')
    }
    const ClickChange =()=>{
      Message({
        message:`<span>你好同学</span>`,
        type:"success",
        center:true
      })
    }

    return {
      open,
      ClickChange
    }
  },
})
</script>

```

## 组件打包

### 打包Umd格式组件库

使用webpack打包成umd格式

build目录下新增webpack.config.js文件

```javascript
const path = require('path');
const { VueLoaderPlugin } = require('vue-loader')
module.exports = {
    mode: 'production',
    // 打包入口文件
    entry: path.resolve(__dirname, '../packages/d-ui/index.ts'),
    output: {
        // 打包输出目录
        path: path.resolve(__dirname, '../lib'),
        filename: 'index.js',
        libraryTarget: 'umd',
        library: 'd-ui',
    },
    externals: { // 排除vue打包
        vue: {
            root: 'Vue',
            commonjs: 'vue',
            commonjs2: 'vue',
        },
    },
    module: {
        rules: [{
                test: /\.vue$/,
                use: 'vue-loader',
            },
            {
                test: /\.(ts|js)x?$/,
                exclude: /node_modules/,
                loader: 'babel-loader',
            },
        ]
    },
    resolve: {
        extensions: ['.ts', '.tsx', '.js', '.json'],
    },
    plugins: [
        new VueLoaderPlugin(),
    ]
}
```

package.json中添加打包命令

```json
"build": "webpack --config ./build/webpack.config.js"
```

![image-20231115201308722](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202311152013867.png)

### 打包esModule格式组件库

使用rollup进行打包，安装所需依赖

```shell
yarn add rollup@2.78.0 rollup-plugin-typescript2@0.30.0 @rollup/plugin-node-resolve rollup-plugin-vue@6.0.0 -D -W
yarn add 
```

[!] Error: Cannot find module '@lerna/project'

报错需要安装

```shell
yarn add @lerna/project -D -W
```

#### 全局打包

build目录下新增rollup.config.bundle.js文件

```javascript
import typescript from 'rollup-plugin-typescript2';
import { nodeResolve } from '@rollup/plugin-node-resolve';
import path from 'path';
import { getPackagesSync } from '@lerna/project';
import vue from 'rollup-plugin-vue'

const inputs = getPackagesSync().map(pck => pck.name).filter(name => name.includes('@d-ui'));
export default {
    input: path.resolve(__dirname, `../packages/d-ui/index.ts`),
    output: {
        format: 'es',
        file: `lib/index.esm.js`,
    },
    plugins: [
        nodeResolve(),
        vue({
            target: 'browser'
        }),
        typescript({
           exclude: [
               'node_modules',
               'play'
           ]
        })
    ],
    external(id) { // 排除vue本身
        return /^vue/.test(id)
    },
}
```

package.json添加打包命令

```json
"build:esm-bundle": "rollup -c ./build/rollup.config.bundle.js",
```

![image-20231115204718760](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202311152047874.png)

#### 按组件打包

build\rollup.config.bundle.split.js

```javascript
import typescript from 'rollup-plugin-typescript2';
import { nodeResolve } from '@rollup/plugin-node-resolve';
import path from 'path';
import { getPackagesSync } from '@lerna/project';
import vue  from 'rollup-plugin-vue'

const inputs = getPackagesSync().map(pck => pck.name).filter(name => name.includes('@d-ui'));
export default inputs.map(name => {
    const pckName = name.split('@d-ui')[1]
    return {
        input: path.resolve(__dirname, `../packages/${pckName}/index.ts`),
        output: {
            format: 'es',
            file: `output/${pckName}/index.js`,
        },
        plugins: [
            nodeResolve(),
            vue({
                target: 'browser'
            }),
            typescript({
                tsconfigOverride: {
                    compilerOptions: { // 打包单个组件的时候不生成ts声明文件
                        declaration: false,
                    },
                    exclude: [
                        'node_modules'
                    ],
                }
            })
        ],
        external(id) { // 对vue本身 和 自己写的包 都排除掉不打包
            return /^vue/.test(id) ||  /^@d-ui/.test(id)
        },
    }
})
```

打包命令

```json
"build:esm-bundle-split": "rollup -c ./build/rollup.config.bundle.split.js"
```

![image-20231115210601009](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202311152106117.png)

## 发布组件包

参考文档：

[npm发布自己的组件UI包（详细步骤，图文并茂）](https://blog.csdn.net/cuclife/article/details/128468313)

[如何在 npm 上发布一个包](https://blog.csdn.net/SLQ1893/article/details/126371859)

发布之前，要先进行打包

### npm发布前的配置

package.json

```json
{
  "name": "d-element-ui",
  "private": true,
  "workspaces": [
    "packages/*"
  ],
  "scripts": {
    "play-dev": "webpack serve --config ./play/webpack.config.js",
    "build": "webpack --config ./build/webpack.config.js",
    "build:esm-bundle": "rollup -c ./build/rollup.config.bundle.js",
    "build:esm-bundle-split": "rollup -c ./build/rollup.config.bundle.split.js"
  },
  "dependencies": {
    "typescript": "^5.2.2",
    "vue": "^3.3.7",
    "vue-router": "^4.2.5"
  },
  "devDependencies": {
    "@babel/core": "^7.23.2",
    "@babel/preset-env": "^7.23.2",
    "@babel/preset-typescript": "^7.23.2",
    "@lerna/project": "^6.4.1",
    "@rollup/plugin-node-resolve": "^15.2.3",
    "@vue/compiler-sfc": "^3.3.7",
    "babel-loader": "^9.1.3",
    "babel-plugin-module-resolver": "^5.0.0",
    "css-loader": "^6.8.1",
    "file-loader": "^6.2.0",
    "html-webpack-plugin": "^5.5.3",
    "lerna": "^7.4.1",
    "rollup": "2.78.0",
    "rollup-plugin-typescript2": "0.30.0",
    "rollup-plugin-vue": "6.0.0",
    "sass": "^1.69.5",
    "sass-loader": "^13.3.2",
    "style-loader": "^3.3.3",
    "url-loader": "^4.1.1",
    "vue-loader": "^17.3.0",
    "webpack": "^5.89.0",
    "webpack-cli": "^5.1.4",
    "webpack-dev-server": "^4.15.1"
  },
  "version": "1.0.0",
  "main": "./lib/index.js",
  "description": "后台管理系统组件库",
  "repository": "https://github.com/dengerpu/DElement-Ui.git",
  "author": "dengerpu",
  "license": "MIT"
}

```

name: 包名，该名不能和已有的名称冲突
version: 版本号，不能和历史版本号相同
description: 简介
main: 入口文件，应指向编译后的包文件
keyword：关键字，以空格分割
author：作者
private：是否私有，需要修改为 false 才能发布到 npm
license：开源协议

### 创建发布忽略文件.npmignore

```
.DS_Store
node_modules/
examples/
output/
packages/
public/
play/
lerna.json
vue.config.js
babel.config.js
tsconfig.json
*.map
*.html

# 本地开发文件
.env.local
.env.*.local

# 日志文件
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# 编辑器文件
.idea
.vscode
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw*
```

### 发布

在您的系统上登录 npm

> 这里只想临时使用默认的镜像源

```shell
npm login --registry https://registry.npmjs.org/
```

> 注意这里不能是淘宝源
>
> 默认镜像： https://registry.npmjs.org/ 
>
> ```shell
> npm config get registry # 当前的npm registry
> npm config set registry <registry-url> # 修改 registry
> npm config set registry https://registry.npm.taobao.org/ # 修改为淘宝的
> ```
>
> 如果您只需要临时更改npm registry，可以使用以下命令，在不更改默认registry的情况下，在单个命令中将npm registry传递给npm
>
> ```shell
> npm install <package-name> --registry <registry-url>
> ```
>

发布包

```shell
npm publish  --registry https://registry.npmjs.org/
```

![image-20231117155953794](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202311171559927.png)

> 报错没有权限可能是因为包名冲突
>
> 直接访问这个网站，如果可以返回信息代表包名冲突
>
> https://registry.npmjs.org/你的包名

![image-20231117160315526](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202311171603663.png)

### 测试

