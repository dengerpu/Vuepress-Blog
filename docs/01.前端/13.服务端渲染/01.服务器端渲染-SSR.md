---
title: æœåŠ¡å™¨ç«¯æ¸²æŸ“(SSR)
index_img: /img/article/ssr.png
categories: 
  - æœåŠ¡å™¨ç«¯æ¸²æŸ“
tags: 
  - SSR
  - Nuxt
  - vue-server-render
date: 2023-08-06 12:48:13
permalink: /pages/bc41f0/
author: 
  name: çˆ±å†™bugçš„å°é‚“ç¨‹åºå‘˜
  link: https://github.com/dengerpu
---

## å®¢æˆ·ç«¯æ¸²æŸ“å’ŒæœåŠ¡å™¨ç«¯æ¸²æŸ“

[ç®€è¿°æœåŠ¡å™¨ç«¯æ¸²æŸ“ã€å®¢æˆ·ç«¯æ¸²æŸ“ã€é™æ€ç«™ç‚¹ç”Ÿæˆ](https://juejin.cn/post/7189203151130460218?searchId=2023080710324249231654ED4007C45AC0)

### CSR

CSR => client-side-renderï¼Œå³å®¢æˆ·ç«¯æ¸²æŸ“ã€‚å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š

- ç”¨æˆ·è¯·æ±‚é¡µé¢ï¼Œè¿”å›é¡µé¢ã€‚æ­¤æ—¶é¡µé¢åªæ˜¯æ¨¡ç‰ˆé¡µé¢
- æµè§ˆå™¨è§£æé¡µé¢ä»£ç ï¼Œè¯»åˆ°jsä»£ç æ—¶ï¼Œä¼šæ ¹æ®æˆ‘ä»¬æ‰€å†™çš„æ¥å£å»è¯·æ±‚æ•°æ®
- å¾—åˆ°è¿”å›æ•°æ®åä½¿ç”¨æ¨¡ç‰ˆï¼ˆvue/react/ng/art-templateï¼‰è¿›è¡Œæ¸²æŸ“
- [ç½‘ç«™ä¸¾ä¾‹](https://gitee.com/link?target=https%3A%2F%2Fmain.m.taobao.com%2F%3Fsprefer%3Dsypc00)

### SSR

SSR => server-side-renderï¼Œå³æœåŠ¡å™¨ç«¯æ¸²æŸ“ã€‚å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š

- ç”¨æˆ·è¯·æ±‚é¡µé¢
- åç«¯å–åˆ°å‡†å¤‡å¥½çš„æ•°æ®ï¼Œæ¸²æŸ“åˆ°æˆ‘ä»¬è‡ªå·±å†™çš„æœåŠ¡å™¨æ¨¡ç‰ˆï¼ˆnext/nuxt/ejsï¼‰ä¸­ï¼Œå‡†å¤‡å¥½htmlç»“æ„ä¸ç›¸åº”æ•°æ®åè¿”å›ç»™æµè§ˆå™¨

### CSR & SSR ä¼˜ç¼ºç‚¹å¯¹æ¯”

|      | ä¼˜ç‚¹                       | ç¼ºç‚¹                                     |
| :--- | :------------------------- | :--------------------------------------- |
| CSR  | å‡è½»æœåŠ¡å™¨å‹åŠ›ï¼Œå‰åç«¯åˆ†ç¦» | å¯¹seoä¸å‹å¥½ï¼ˆä¸åˆ©äºçˆ¬è™«çˆ¬å–ï¼‰            |
| SSR  | å¯¹seoå‹å¥½                  | å¯¹æœåŠ¡å™¨æ€§èƒ½æœ‰ä¸€å®šè¦æ±‚ï¼Œä¸åˆ©äºå‰åç«¯åˆ†ç¦» |

å…¶å®åœ¨çœŸæ­£å¼€å‘ä¸­é€šå¸¸æ˜¯ csr ä¸ ssr ç›¸ç»“åˆä½¿ç”¨ï¼Œå‰ç«¯ä½¿ç”¨cdnç¼“å­˜ï¼Œåç«¯ä½¿ç”¨nginxç¼“å­˜ã€‚è¿™æ ·æ˜¯æœ€ä¼˜çš„è§£å†³æ–¹æ¡ˆã€‚ä¸Šä¸¤å¼ å›¾å¤§å®¶å¯¹æ¯”ç†è§£ï¼š

![image-20230817111837439](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202308171118588.png)



![image-20230817111858035](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202308171118192.png)

## Vue SSR

[å®˜ç½‘å‚è€ƒæ–‡ç« ](https://v2.ssr.vuejs.org/zh/guide/#%E5%AE%89%E8%A3%85)

### åŸºæœ¬ç”¨æ³•

å®‰è£…

```shell
npm install vue@2 vue-server-renderer --save
```

#### æ¸²æŸ“ä¸€ä¸ªVueå®ä¾‹

server.js

```javascript
// 1.åˆ›å»ºä¸€ä¸ªVueå®ä¾‹
const Vue = require('vue')
const app = new Vue({
    template: `<div>Hello World</div>`
})

// 2.åˆ›å»ºä¸€ä¸ªrenderer
const renderer = require('vue-server-renderer').createRenderer()

// 3.å°†Vueå®ä¾‹æ¸²æŸ“ä¸ºHTML
renderer.renderToString(app, (err, html) => {
    if(err) throw err
    console.log(html)
})

// 2.5.0+, å¦‚æœæ²¡æœ‰ä¼ å…¥å›è°ƒå‡½æ•°ï¼Œåˆ™ä¼šè¿”å›Promise
renderer.renderToString(app).then(html => {
    console.log(html)
}).catch(err => {
    console.log(err)
})
```

package.json

```json
{
  "name": "vue-server-renderer",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "dev": "nodemon ./server.js"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "dependencies": {
    "vue": "^2.7.14",
    "vue-server-renderer": "^2.7.14"
  }
}
```

#### ä¸æœåŠ¡å™¨ç«¯é›†æˆ

``` cmd
npm install express --save
```

server2.js

```javascript
const Vue = require('vue')
const server = require('express')()
const renderer = require('vue-server-renderer').createRenderer()

server.get('*', (req,res) => {
    const app =  new Vue({
        data: {
            url: req.url
        },
        template: `<h1>ä½ è®¿é—®çš„ URL æ˜¯ï¼š {{ url }}</h1>`
    })

    // å°†Vueå®ä¾‹æ¸²æŸ“ä¸ºHTML
    renderer.renderToString(app, (err, html) => {
        if(err) {
            res.status(500).end('æœåŠ¡å™¨ç«¯å‘ç”Ÿé”™è¯¯')
            return
        }
        res.end(`
            <!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <meta http-equiv="X-UA-Compatible" content="IE=edge">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Document</title>
            </head>
            <body>
                ${html}
            </body>
            </html>
        `)
    })
})

server.listen(8080)


```

è®¿é—®ï¼šhttp://localhost:8080/

![image-20230808103517153](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202308081035216.png)

#### ä½¿ç”¨ä¸€ä¸ªé¡µé¢æ¨¡æ¿

å½“ä½ åœ¨æ¸²æŸ“ Vue åº”ç”¨ç¨‹åºæ—¶ï¼Œrenderer åªä»åº”ç”¨ç¨‹åºç”Ÿæˆ HTML æ ‡è®° (markup)ã€‚åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å¿…é¡»ç”¨ä¸€ä¸ªé¢å¤–çš„ HTML é¡µé¢åŒ…è£¹å®¹å™¨ï¼Œæ¥åŒ…è£¹ç”Ÿæˆçš„ HTML æ ‡è®°ã€‚

ä¸ºäº†ç®€åŒ–è¿™äº›ï¼Œä½ å¯ä»¥ç›´æ¥åœ¨åˆ›å»º renderer æ—¶æä¾›ä¸€ä¸ªé¡µé¢æ¨¡æ¿ã€‚å¤šæ•°æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šå°†é¡µé¢æ¨¡æ¿æ”¾åœ¨ç‰¹æœ‰çš„æ–‡ä»¶ä¸­ï¼Œä¾‹å¦‚ `index.html`ï¼š

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
      <!--vue-ssr-outlet-->   
</body>
</html>
```

æ³¨æ„ `<!--vue-ssr-outlet-->` æ³¨é‡Š -- è¿™é‡Œå°†æ˜¯åº”ç”¨ç¨‹åº HTML æ ‡è®°æ³¨å…¥çš„åœ°æ–¹ã€‚

> `<!--vue-ssr-outlet-->`è¿™ä¸ªæ³¨é‡Šè¦åŠ ä¸Šï¼Œå¦åˆ™ä¼šæŠ¥ä»¥ä¸‹é”™è¯¯
>
> ![image-20230808104138288](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202308081041374.png)

ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥è¯»å–å’Œä¼ è¾“æ–‡ä»¶åˆ° Vue renderer ä¸­ï¼š

```javascript
const Vue = require('vue')
const server = require('express')()
const renderer = require('vue-server-renderer').createRenderer({
    template: require('fs').readFileSync('./index.html', 'utf-8')
})

server.get('*', (req,res) => {
    const app =  new Vue({
        data: {
            url: req.url
        },
        template: `<h1>ä½ è®¿é—®çš„ URL æ˜¯ï¼š {{ url }}</h1>`
    })

    // å°†Vueå®ä¾‹æ¸²æŸ“ä¸ºHTML
    renderer.renderToString(app, (err, html) => {
        if(err) {
            res.status(500).end('æœåŠ¡å™¨ç«¯å‘ç”Ÿé”™è¯¯')
            return
        }
        res.end(html)
    })
})

server.listen(8080)
```

**æ¨¡æ¿æ’å€¼**

index.html

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- ä½¿ç”¨åŒèŠ±æ‹¬å·(double-mustache)è¿›è¡Œ HTML è½¬ä¹‰æ’å€¼(HTML-escaped interpolation) -->
    <title>{{ title }}</title>
     <!-- ä½¿ç”¨ä¸‰èŠ±æ‹¬å·(triple-mustache)è¿›è¡Œ HTML ä¸è½¬ä¹‰æ’å€¼(non-HTML-escaped interpolation) -->
    {{{ meta }}}
</head>
<body>
     <!--vue-ssr-outlet-->
</body>
</html>
```

æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¼ å…¥ä¸€ä¸ª"æ¸²æŸ“ä¸Šä¸‹æ–‡å¯¹è±¡"ï¼Œä½œä¸º `renderToString` å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œæ¥æä¾›æ’å€¼æ•°æ®ï¼š

```javascript
const context = {
  title: 'hello',
  meta: `
    <meta ...>
    <meta ...>
  `
}

renderer.renderToString(app, context, (err, html) => {
  // é¡µé¢ title å°†ä¼šæ˜¯ "Hello"
  // meta æ ‡ç­¾ä¹Ÿä¼šæ³¨å…¥
})
```

ä¹Ÿå¯ä»¥ä¸ Vue åº”ç”¨ç¨‹åºå®ä¾‹å…±äº« `context` å¯¹è±¡ï¼Œå…è®¸æ¨¡æ¿æ’å€¼ä¸­çš„ç»„ä»¶åŠ¨æ€åœ°æ³¨å†Œæ•°æ®ã€‚

server2.js

```javascript
const Vue = require('vue')
const server = require('express')()

const template = require('fs').readFileSync('./index.html', 'utf-8')

const renderer = require('vue-server-renderer').createRenderer({
    template
})

const context = {
    title: 'è‡ªå®šä¹‰æ ‡é¢˜',
    meta: `
        <meta name="keyword" content="vue,ssr">
        <meta name="description" content="vue srr demo">
    `
}

server.get('*', (req,res) => {
    const app =  new Vue({
        data: {
            url: req.url
        },
        template: `<h1>ä½ è®¿é—®çš„ URL æ˜¯ï¼š {{ url }}</h1>`
    })

    // å°†Vueå®ä¾‹æ¸²æŸ“ä¸ºHTML
    renderer.renderToString(app, context, (err, html) => {
        if(err) {
            res.status(500).end('æœåŠ¡å™¨ç«¯å‘ç”Ÿé”™è¯¯')
            return
        }
        res.end(html)
    })
})

server.listen(8080)

```

![image-20230808105019019](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202308081050085.png)

### é€šç”¨ä»£ç 

#### æœåŠ¡å™¨ä¸Šçš„æ•°æ®å“åº”

åœ¨çº¯å®¢æˆ·ç«¯åº”ç”¨ç¨‹åº (client-only app) ä¸­ï¼Œæ¯ä¸ªç”¨æˆ·ä¼šåœ¨ä»–ä»¬å„è‡ªçš„æµè§ˆå™¨ä¸­ä½¿ç”¨æ–°çš„åº”ç”¨ç¨‹åºå®ä¾‹ã€‚å¯¹äºæœåŠ¡å™¨ç«¯æ¸²æŸ“ï¼Œæˆ‘ä»¬ä¹Ÿå¸Œæœ›å¦‚æ­¤ï¼šæ¯ä¸ªè¯·æ±‚åº”è¯¥éƒ½æ˜¯å…¨æ–°çš„ã€ç‹¬ç«‹çš„åº”ç”¨ç¨‹åºå®ä¾‹ï¼Œä»¥ä¾¿ä¸ä¼šæœ‰äº¤å‰è¯·æ±‚é€ æˆçš„çŠ¶æ€æ±¡æŸ“ (cross-request state pollution)ã€‚

å› ä¸ºå®é™…çš„æ¸²æŸ“è¿‡ç¨‹éœ€è¦ç¡®å®šæ€§ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå°†åœ¨æœåŠ¡å™¨ä¸Šâ€œé¢„å–â€æ•°æ® ("pre-fetching" data) - è¿™æ„å‘³ç€åœ¨æˆ‘ä»¬å¼€å§‹æ¸²æŸ“æ—¶ï¼Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå°±å·²ç»è§£æå®Œæˆå…¶çŠ¶æ€ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå°†æ•°æ®è¿›è¡Œå“åº”å¼çš„è¿‡ç¨‹åœ¨æœåŠ¡å™¨ä¸Šæ˜¯å¤šä½™çš„ï¼Œæ‰€ä»¥é»˜è®¤æƒ…å†µä¸‹ç¦ç”¨ã€‚ç¦ç”¨å“åº”å¼æ•°æ®ï¼Œè¿˜å¯ä»¥é¿å…å°†ã€Œæ•°æ®ã€è½¬æ¢ä¸ºã€Œå“åº”å¼å¯¹è±¡ã€çš„æ€§èƒ½å¼€é”€ã€‚

#### ç»„ä»¶ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°

ç”±äºæ²¡æœ‰åŠ¨æ€æ›´æ–°ï¼Œæ‰€æœ‰çš„ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°ä¸­ï¼Œåªæœ‰ `beforeCreate` å’Œ `created` ä¼šåœ¨æœåŠ¡å™¨ç«¯æ¸²æŸ“ (SSR) è¿‡ç¨‹ä¸­è¢«è°ƒç”¨ã€‚è¿™å°±æ˜¯è¯´ä»»ä½•å…¶ä»–ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°ä¸­çš„ä»£ç ï¼ˆ**ä¾‹å¦‚ `beforeMount` æˆ– `mounted`ï¼‰ï¼Œåªä¼šåœ¨å®¢æˆ·ç«¯æ‰§è¡Œã€‚**

æ­¤å¤–è¿˜éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½ åº”è¯¥é¿å…åœ¨ `beforeCreate` å’Œ `created` ç”Ÿå‘½å‘¨æœŸæ—¶äº§ç”Ÿå…¨å±€å‰¯ä½œç”¨çš„ä»£ç ï¼Œä¾‹å¦‚åœ¨å…¶ä¸­ä½¿ç”¨ `setInterval` è®¾ç½® timerã€‚åœ¨çº¯å®¢æˆ·ç«¯ (client-side only) çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®ä¸€ä¸ª timerï¼Œç„¶ååœ¨ `beforeDestroy` æˆ– `destroyed` ç”Ÿå‘½å‘¨æœŸæ—¶å°†å…¶é”€æ¯ã€‚ä½†æ˜¯ï¼Œç”±äºåœ¨ SSR æœŸé—´å¹¶ä¸ä¼šè°ƒç”¨é”€æ¯é’©å­å‡½æ•°ï¼Œæ‰€ä»¥ timer å°†æ°¸è¿œä¿ç•™ä¸‹æ¥ã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œè¯·å°†å‰¯ä½œç”¨ä»£ç ç§»åŠ¨åˆ° `beforeMount` æˆ– `mounted` ç”Ÿå‘½å‘¨æœŸä¸­ã€‚

#### è®¿é—®ç‰¹å®šå¹³å°(Platform-Specific) API

é€šç”¨ä»£ç ä¸å¯æ¥å—ç‰¹å®šå¹³å°çš„ APIï¼Œå› æ­¤å¦‚æœä½ çš„ä»£ç ä¸­ï¼Œç›´æ¥ä½¿ç”¨äº†åƒ `window` æˆ– `document`ï¼Œè¿™ç§ä»…æµè§ˆå™¨å¯ç”¨çš„å…¨å±€å˜é‡ï¼Œåˆ™ä¼šåœ¨ Node.js ä¸­æ‰§è¡Œæ—¶æŠ›å‡ºé”™è¯¯ï¼Œåä¹‹ä¹Ÿæ˜¯å¦‚æ­¤ã€‚

å¯¹äºå…±äº«äºæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ï¼Œä½†ç”¨äºä¸åŒå¹³å° API çš„ä»»åŠ¡(task)ï¼Œå»ºè®®å°†å¹³å°ç‰¹å®šå®ç°åŒ…å«åœ¨é€šç”¨ API ä¸­ï¼Œæˆ–è€…ä½¿ç”¨ä¸ºä½ æ‰§è¡Œæ­¤æ“ä½œçš„ libraryã€‚ä¾‹å¦‚ï¼Œ[axios (opens new window)](https://github.com/axios/axios)æ˜¯ä¸€ä¸ª HTTP å®¢æˆ·ç«¯ï¼Œå¯ä»¥å‘æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯éƒ½æš´éœ²ç›¸åŒçš„ APIã€‚

å¯¹äºä»…æµè§ˆå™¨å¯ç”¨çš„ APIï¼Œé€šå¸¸æ–¹å¼æ˜¯ï¼Œåœ¨ã€Œçº¯å®¢æˆ·ç«¯ (client-only)ã€çš„ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°ä¸­æƒ°æ€§è®¿é—® (lazily access) å®ƒä»¬ã€‚

è¯·æ³¨æ„ï¼Œè€ƒè™‘åˆ°å¦‚æœç¬¬ä¸‰æ–¹ library ä¸æ˜¯ä»¥ä¸Šé¢çš„é€šç”¨ç”¨æ³•ç¼–å†™ï¼Œåˆ™å°†å…¶é›†æˆåˆ°æœåŠ¡å™¨æ¸²æŸ“çš„åº”ç”¨ç¨‹åºä¸­ï¼Œå¯èƒ½ä¼šå¾ˆæ£˜æ‰‹ã€‚ä½ *å¯èƒ½*è¦é€šè¿‡æ¨¡æ‹Ÿ (mock) ä¸€äº›å…¨å±€å˜é‡æ¥ä½¿å…¶æ­£å¸¸è¿è¡Œï¼Œä½†è¿™åªæ˜¯ hack çš„åšæ³•ï¼Œå¹¶ä¸”å¯èƒ½ä¼šå¹²æ‰°åˆ°å…¶ä»– library çš„ç¯å¢ƒæ£€æµ‹ä»£ç ã€‚

#### è‡ªå®šä¹‰æŒ‡ä»¤

å¤§å¤šæ•°è‡ªå®šä¹‰æŒ‡ä»¤ç›´æ¥æ“ä½œ DOMï¼Œå› æ­¤ä¼šåœ¨æœåŠ¡å™¨ç«¯æ¸²æŸ“ (SSR) è¿‡ç¨‹ä¸­å¯¼è‡´é”™è¯¯ã€‚æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼š

1. æ¨èä½¿ç”¨ç»„ä»¶ä½œä¸ºæŠ½è±¡æœºåˆ¶ï¼Œå¹¶è¿è¡Œåœ¨ã€Œè™šæ‹Ÿ DOM å±‚çº§(Virtual-DOM level)ã€ï¼ˆä¾‹å¦‚ï¼Œä½¿ç”¨æ¸²æŸ“å‡½æ•°(render function)ï¼‰ã€‚
2. å¦‚æœä½ æœ‰ä¸€ä¸ªè‡ªå®šä¹‰æŒ‡ä»¤ï¼Œä½†æ˜¯ä¸æ˜¯å¾ˆå®¹æ˜“æ›¿æ¢ä¸ºç»„ä»¶ï¼Œåˆ™å¯ä»¥åœ¨åˆ›å»ºæœåŠ¡å™¨ renderer æ—¶ï¼Œä½¿ç”¨ [`directives`](https://v2.ssr.vuejs.org/zh/api/#directives) é€‰é¡¹æ‰€æä¾›"æœåŠ¡å™¨ç«¯ç‰ˆæœ¬(server-side version)"ã€‚

### æºç ç»“æ„

#### é¿å…çŠ¶æ€å•ä¾‹

å½“ç¼–å†™çº¯å®¢æˆ·ç«¯ (client-only) ä»£ç æ—¶ï¼Œæˆ‘ä»¬ä¹ æƒ¯äºæ¯æ¬¡åœ¨æ–°çš„ä¸Šä¸‹æ–‡ä¸­å¯¹ä»£ç è¿›è¡Œå–å€¼ã€‚ä½†æ˜¯ï¼ŒNode.js æœåŠ¡å™¨æ˜¯ä¸€ä¸ªé•¿æœŸè¿è¡Œçš„è¿›ç¨‹ã€‚å½“æˆ‘ä»¬çš„ä»£ç è¿›å…¥è¯¥è¿›ç¨‹æ—¶ï¼Œå®ƒå°†è¿›è¡Œä¸€æ¬¡å–å€¼å¹¶ç•™å­˜åœ¨å†…å­˜ä¸­ã€‚è¿™æ„å‘³ç€å¦‚æœåˆ›å»ºä¸€ä¸ªå•ä¾‹å¯¹è±¡ï¼Œå®ƒå°†åœ¨æ¯ä¸ªä¼ å…¥çš„è¯·æ±‚ä¹‹é—´å…±äº«ã€‚

å¦‚åŸºæœ¬ç¤ºä¾‹æ‰€ç¤ºï¼Œæˆ‘ä»¬**ä¸ºæ¯ä¸ªè¯·æ±‚åˆ›å»ºä¸€ä¸ªæ–°çš„æ ¹ Vue å®ä¾‹**ã€‚è¿™ä¸æ¯ä¸ªç”¨æˆ·åœ¨è‡ªå·±çš„æµè§ˆå™¨ä¸­ä½¿ç”¨æ–°åº”ç”¨ç¨‹åºçš„å®ä¾‹ç±»ä¼¼ã€‚å¦‚æœæˆ‘ä»¬åœ¨å¤šä¸ªè¯·æ±‚ä¹‹é—´ä½¿ç”¨ä¸€ä¸ªå…±äº«çš„å®ä¾‹ï¼Œå¾ˆå®¹æ˜“å¯¼è‡´äº¤å‰è¯·æ±‚çŠ¶æ€æ±¡æŸ“ (cross-request state pollution)ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬ä¸åº”è¯¥ç›´æ¥åˆ›å»ºä¸€ä¸ªåº”ç”¨ç¨‹åºå®ä¾‹ï¼Œè€Œæ˜¯**åº”è¯¥æš´éœ²ä¸€ä¸ªå¯ä»¥é‡å¤æ‰§è¡Œçš„å·¥å‚å‡½æ•°**ï¼Œä¸ºæ¯ä¸ªè¯·æ±‚åˆ›å»ºæ–°çš„åº”ç”¨ç¨‹åºå®ä¾‹ï¼š

src/app.js

```javascript
const Vue =  require('vue')

module.exports = function createApp(context) {
    return new Vue({
        data: {
            url: context.url
        },
        template: `<h1>ä½ è®¿é—®çš„ URL æ˜¯ï¼š {{ url }}</h1>`
    })
}
```

src/server.js

```javascript
`const createApp  = require('./app')`
const server = require('express')()

const template = require('fs').readFileSync('./index.html', 'utf-8')

const renderer = require('vue-server-renderer').createRenderer({
    template
})

const context = {
    title: 'è‡ªå®šä¹‰æ ‡é¢˜',
    meta: `
        <meta name="keyword" content="vue,ssr">
        <meta name="description" content="vue srr demo">
    `
}

server.get('*', (req,res) => {
`    const param = { url: req.url }
    const app = createApp(param)`
    // å°†Vueå®ä¾‹æ¸²æŸ“ä¸ºHTML
    renderer.renderToString(app, context, (err, html) => {
        if(err) {
            res.status(500).end('æœåŠ¡å™¨ç«¯å‘ç”Ÿé”™è¯¯')
            return
        }
        res.end(html)
    })
})

server.listen(8080)
```

#### ä»‹ç»æ„å»ºæ­¥éª¤

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬è¿˜æ²¡æœ‰è®¨è®ºè¿‡å¦‚ä½•å°†ç›¸åŒçš„ Vue åº”ç”¨ç¨‹åºæä¾›ç»™å®¢æˆ·ç«¯ã€‚ä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ webpack æ¥æ‰“åŒ…æˆ‘ä»¬çš„ Vue åº”ç”¨ç¨‹åºã€‚äº‹å®ä¸Šï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦åœ¨æœåŠ¡å™¨ä¸Šä½¿ç”¨ webpack æ‰“åŒ… Vue åº”ç”¨ç¨‹åºï¼Œå› ä¸ºï¼š

- é€šå¸¸ Vue åº”ç”¨ç¨‹åºæ˜¯ç”± webpack å’Œ `vue-loader` æ„å»ºï¼Œå¹¶ä¸”è®¸å¤š webpack ç‰¹å®šåŠŸèƒ½ä¸èƒ½ç›´æ¥åœ¨ Node.js ä¸­è¿è¡Œï¼ˆä¾‹å¦‚é€šè¿‡ `file-loader` å¯¼å…¥æ–‡ä»¶ï¼Œé€šè¿‡ `css-loader` å¯¼å…¥ CSSï¼‰ã€‚
- å°½ç®¡ Node.js æœ€æ–°ç‰ˆæœ¬èƒ½å¤Ÿå®Œå…¨æ”¯æŒ ES2015 ç‰¹æ€§ï¼Œæˆ‘ä»¬è¿˜æ˜¯éœ€è¦è½¬è¯‘å®¢æˆ·ç«¯ä»£ç ä»¥é€‚åº”è€ç‰ˆæµè§ˆå™¨ã€‚è¿™ä¹Ÿä¼šæ¶‰åŠåˆ°æ„å»ºæ­¥éª¤ã€‚

æ‰€ä»¥åŸºæœ¬çœ‹æ³•æ˜¯ï¼Œå¯¹äºå®¢æˆ·ç«¯åº”ç”¨ç¨‹åºå’ŒæœåŠ¡å™¨åº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬éƒ½è¦ä½¿ç”¨ webpack æ‰“åŒ… - æœåŠ¡å™¨éœ€è¦ã€ŒæœåŠ¡å™¨ bundleã€ç„¶åç”¨äºæœåŠ¡å™¨ç«¯æ¸²æŸ“(SSR)ï¼Œè€Œã€Œå®¢æˆ·ç«¯ bundleã€ä¼šå‘é€ç»™æµè§ˆå™¨ï¼Œç”¨äºæ··åˆé™æ€æ ‡è®°ã€‚

![æ¶æ„](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202308091120995.png)

#### ä½¿ç”¨ webpack çš„æºç ç»“æ„

ç°åœ¨æˆ‘ä»¬æ­£åœ¨ä½¿ç”¨ webpack æ¥å¤„ç†æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯çš„åº”ç”¨ç¨‹åºï¼Œå¤§éƒ¨åˆ†æºç å¯ä»¥ä½¿ç”¨é€šç”¨æ–¹å¼ç¼–å†™ï¼Œå¯ä»¥ä½¿ç”¨ webpack æ”¯æŒçš„æ‰€æœ‰åŠŸèƒ½ã€‚

ä¸€ä¸ªåŸºæœ¬é¡¹ç›®å¯èƒ½åƒæ˜¯è¿™æ ·ï¼š

```bash
src
â”œâ”€â”€ components
â”‚   â”œâ”€â”€ Foo.vue
â”‚   â”œâ”€â”€ Bar.vue
â”‚   â””â”€â”€ Baz.vue
â”œâ”€â”€ App.vue
â”œâ”€â”€ app.js # é€šç”¨ entry(universal entry)
â”œâ”€â”€ entry-client.js # ä»…è¿è¡Œäºæµè§ˆå™¨
â””â”€â”€ entry-server.js # ä»…è¿è¡ŒäºæœåŠ¡å™¨
```

`app.js`

`app.js` æ˜¯æˆ‘ä»¬åº”ç”¨ç¨‹åºçš„ã€Œé€šç”¨ entryã€ã€‚åœ¨çº¯å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºä¸­ï¼Œæˆ‘ä»¬å°†åœ¨æ­¤æ–‡ä»¶ä¸­åˆ›å»ºæ ¹ Vue å®ä¾‹ï¼Œå¹¶ç›´æ¥æŒ‚è½½åˆ° DOMã€‚ä½†æ˜¯ï¼Œå¯¹äºæœåŠ¡å™¨ç«¯æ¸²æŸ“(SSR)ï¼Œè´£ä»»è½¬ç§»åˆ°çº¯å®¢æˆ·ç«¯ entry æ–‡ä»¶ã€‚`app.js` ç®€å•åœ°ä½¿ç”¨ export å¯¼å‡ºä¸€ä¸ª `createApp` å‡½æ•°ï¼š

```javascript
import Vue from 'vue'
import App from './App.vue'

// å¯¼å‡ºä¸€ä¸ªå·¥å‚å‡½æ•°ï¼Œç”¨äºåˆ›å»ºæ–°çš„
// åº”ç”¨ç¨‹åºã€router å’Œ store å®ä¾‹
export function createApp () {
  const app = new Vue({
    // æ ¹å®ä¾‹ç®€å•çš„æ¸²æŸ“åº”ç”¨ç¨‹åºç»„ä»¶ã€‚
    render: h => h(App)
  })
  return { app }
}
```

`entry-client.js`:

å®¢æˆ·ç«¯ entry åªéœ€åˆ›å»ºåº”ç”¨ç¨‹åºï¼Œå¹¶ä¸”å°†å…¶æŒ‚è½½åˆ° DOM ä¸­ï¼š

```js
import { createApp } from './app'

// å®¢æˆ·ç«¯ç‰¹å®šå¼•å¯¼é€»è¾‘â€¦â€¦

const { app } = createApp()

// è¿™é‡Œå‡å®š App.vue æ¨¡æ¿ä¸­æ ¹å…ƒç´ å…·æœ‰ `id="app"`
app.$mount('#app')
```

`entry-server.js`:

æœåŠ¡å™¨ entry ä½¿ç”¨ default export å¯¼å‡ºå‡½æ•°ï¼Œå¹¶åœ¨æ¯æ¬¡æ¸²æŸ“ä¸­é‡å¤è°ƒç”¨æ­¤å‡½æ•°ã€‚æ­¤æ—¶ï¼Œé™¤äº†åˆ›å»ºå’Œè¿”å›åº”ç”¨ç¨‹åºå®ä¾‹ä¹‹å¤–ï¼Œå®ƒä¸ä¼šåšå¤ªå¤šäº‹æƒ… - ä½†æ˜¯ç¨åæˆ‘ä»¬å°†åœ¨æ­¤æ‰§è¡ŒæœåŠ¡å™¨ç«¯è·¯ç”±åŒ¹é… (server-side route matching) å’Œæ•°æ®é¢„å–é€»è¾‘ (data pre-fetching logic)ã€‚

```javascript
import { createApp } from './app'

export default context => {
  const { app } = createApp()
  return app
}
```

## Nuxt

å®˜æ–¹æ–‡æ¡£ï¼šhttps://www.nuxtjs.cn/guide

ç®€å•æ¥è¯´ï¼Œ**Nuxt**å°±æ˜¯åŸºäº**Vue**çš„ä¸€ä¸ªåº”ç”¨æ¡†æ¶ï¼Œé‡‡ç”¨**æœåŠ¡ç«¯æ¸²æŸ“**ï¼Œè®©ä½ çš„**SPAåº”ç”¨(Vue)**ä¹Ÿå¯ä»¥æ‹¥æœ‰**SEO**

Vue å¼€å‘ä¸€ä¸ªå•é¡µé¢åº”ç”¨ï¼Œç›¸ä¿¡å¾ˆå¤šå‰ç«¯å·¥ç¨‹å¸ˆéƒ½å·²ç»å­¦ä¼šäº†ï¼Œä½†æ˜¯å•é¡µé¢åº”ç”¨æœ‰ä¸€ä¸ªè‡´å‘½çš„ç¼ºç‚¹ï¼Œå°±æ˜¯ SEO æä¸å‹å¥½ã€‚é™¤éï¼Œvue èƒ½åœ¨æœåŠ¡ç«¯æ¸²æŸ“ï¼ˆssrï¼‰å¹¶ç›´æ¥è¿”å›å·²ç»æ¸²æŸ“å¥½çš„é¡µé¢ï¼Œè€Œå¹¶éåªæ˜¯ä¸€ä¸ªå•çº¯çš„ `<div id="app"></div>`ã€‚

[Nuxt.js](https://zh.nuxtjs.org/) å°±æ˜¯ä¸€ä¸ªæç®€çš„ vue ç‰ˆçš„ ssr æ¡†æ¶ã€‚åŸºäºå®ƒï¼Œæˆ‘ä»¬å¯ä»¥å¿«é€Ÿå¼€å‘ä¸€ä¸ªåŸºäº vue çš„ ssr å•é¡µé¢åº”ç”¨ã€‚

Nuxt.jsç®€å•çš„è¯´æ˜¯Vue.jsçš„é€šç”¨æ¡†æ¶ï¼Œæœ€å¸¸ç”¨çš„å°±æ˜¯ç”¨æ¥ä½œSSRï¼ˆæœåŠ¡å™¨ç«¯æ¸²æŸ“ï¼‰ã€‚å†ç›´ç™½ç‚¹è¯´ï¼Œå°±æ˜¯Vue.jsåŸæ¥æ˜¯å¼€å‘SPAï¼ˆå•é¡µåº”ç”¨ï¼‰çš„ï¼Œä½†æ˜¯éšç€æŠ€æœ¯çš„æ™®åŠï¼Œå¾ˆå¤šäººæƒ³ç”¨Vueå¼€å‘å¤šé¡µåº”ç”¨ï¼Œå¹¶åœ¨æœåŠ¡ç«¯å®Œæˆæ¸²æŸ“ã€‚è¿™æ—¶å€™å°±å‡ºç°äº†Nuxt.jsè¿™ä¸ªæ¡†æ¶ï¼Œå¥¹å®ƒç®€åŒ–äº†SSRçš„å¼€å‘éš¾åº¦ã€‚è¿˜å¯ä»¥ç›´æ¥ç”¨å‘½ä»¤æŠŠæˆ‘ä»¬åˆ¶ä½œçš„vueé¡¹ç›®ç”Ÿæˆä¸ºé™æ€htmlã€‚

### å®‰è£…

Nuxt.js å®˜æ–¹æä¾›äº†ä¸€ä¸ªæ¨¡æ¿ï¼Œå¯ä»¥ä½¿ç”¨ vue-cli ç›´æ¥å®‰è£…ã€‚

```shell
vue init nuxt-community/starter-template project-name
```

æˆ–è€…

```shell
npx create-nuxt-app xxx
```

![image-20230816160422342](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202308161604438.png)

åˆ›å»ºæˆåŠŸå

ğŸ‰  Successfully created project nuxt01-start

  To get started:

        cd nuxt01-start
        npm run dev

  To build & start for production:

        cd nuxt01-start
        npm run build
        npm run start
åˆ›å»ºçš„ç›®å½•ç»“æ„

![image-20230816163247734](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202308161632802.png)

#### ç›®å½•ç»“æ„ä»‹ç»

```
.
â”œâ”€â”€ README.md
â”œâ”€â”€ assets
â”œâ”€â”€ components
â”œâ”€â”€ layouts
â”œâ”€â”€ middleware
â”œâ”€â”€ node_modules
â”œâ”€â”€ nuxt.config.js
â”œâ”€â”€ package.json
â”œâ”€â”€ pages
â”œâ”€â”€ plugins
â”œâ”€â”€ static
â”œâ”€â”€ store
â””â”€â”€ yarn.lock
```

å…¶ä¸­ï¼š

1. **assets**: èµ„æºæ–‡ä»¶ã€‚æ”¾ç½®éœ€è¦ç»è¿‡ webpack æ‰“åŒ…å¤„ç†çš„èµ„æºæ–‡ä»¶ï¼Œå¦‚ scssï¼Œå›¾ç‰‡ï¼Œå­—ä½“ç­‰ã€‚

2. **components**: vueç»„ä»¶ã€‚è¿™é‡Œå­˜æ”¾åœ¨é¡µé¢ä¸­ï¼Œå¯ä»¥å¤ç”¨çš„ç»„ä»¶,ä¸æ”¯æŒæœåŠ¡å™¨ç«¯çš„é’©å­ã€‚

3. **layouts**: å¸ƒå±€ã€‚é¡µé¢éƒ½éœ€è¦æœ‰ä¸€ä¸ªå¸ƒå±€ï¼Œé»˜è®¤ä¸º defaultã€‚å®ƒè§„å®šäº†ä¸€ä¸ªé¡µé¢å¦‚ä½•å¸ƒå±€é¡µé¢ã€‚æ‰€æœ‰é¡µé¢éƒ½ä¼šåŠ è½½åœ¨å¸ƒå±€é¡µé¢ä¸­çš„ `<nuxt />` æ ‡ç­¾ä¸­ã€‚å¦‚æœéœ€è¦åœ¨æ™®é€šé¡µé¢ä¸­ä½¿ç”¨ä¸‹çº§è·¯ç”±ï¼Œåˆ™éœ€è¦åœ¨é¡µé¢ä¸­æ·»åŠ  `<nuxt-child />`ã€‚è¯¥ç›®å½•åä¸ºNuxt.jsä¿ç•™çš„ï¼Œä¸å¯æ›´æ”¹ã€‚åœ¨ layout ä¸­æˆ‘ä»¬å¯ä»¥æ”¾å…¥ä¸€äº›æ¯ä¸ªé¡µé¢éƒ½ä¼šä»¥ç”¨åˆ°çš„ç»„ä»¶ï¼Œæ¯”å¦‚ header & footerã€‚å½“ç„¶å¦‚æœä½ ä¸æƒ³ä½¿ç”¨å·²ç”Ÿæˆçš„ layout ç»„ä»¶ï¼Œä½ å¯ä»¥é‡æ–°åˆ›å»ºä¸€ä¸ªï¼Œæ¯”å¦‚ blank.vue ä¸€èˆ¬ä¸éœ€è¦å¼•å…¥ header&footer çš„é¡µé¢å¯ä»¥ä½¿ç”¨ blank.vue è¿™ä¸ª layout ç»„ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š

   ```
   layout: 'blank'
   ```

4. **middleware**: ä¸­é—´ä»¶ã€‚å­˜æ”¾ä¸­é—´ä»¶ã€‚å¯ä»¥åœ¨é¡µé¢ä¸­è°ƒç”¨ï¼š `middleware: 'middlewareName'` ã€‚

5. **pages**: é¡µé¢ã€‚ä¸€ä¸ª vue æ–‡ä»¶å³ä¸ºä¸€ä¸ªé¡µé¢ã€‚index.vue ä¸ºæ ¹é¡µé¢ã€‚

   1. è‹¥éœ€è¦äºŒçº§é¡µé¢ï¼Œåˆ™æ·»åŠ æ–‡ä»¶å¤¹å³å¯ã€‚
   2. å¦‚æœé¡µé¢çš„åç§°ç±»ä¼¼äº `_id.vue` ï¼ˆä»¥ `_` å¼€å¤´ï¼‰ï¼Œåˆ™ä¸ºåŠ¨æ€è·¯ç”±é¡µé¢ï¼Œ`_` åä¸ºåŒ¹é…çš„å˜é‡ï¼ˆparamsï¼‰ã€‚

   3. è‹¥å˜é‡æ˜¯å¿…é¡»çš„ï¼Œåˆ™åœ¨æ–‡ä»¶å¤¹ä¸‹å»ºç«‹ç©ºæ–‡ä»¶ `index.vue`ã€‚æ›´å¤šçš„é…ç½®è¯·ç§»æ­¥è‡³ [å®˜ç½‘](https://zh.nuxtjs.org/guide/routing) ã€‚

6. **plugin**: æ’ä»¶ã€‚ç”¨äºç»„ç»‡å’Œé…ç½®ï¼Œé‚£äº›éœ€è¦åœ¨ `æ ¹vue.jsåº”ç”¨` å®ä¾‹åŒ–ä¹‹å‰éœ€è¦è¿è¡Œçš„ Javascript æ’ä»¶ï¼Œéœ€è¦é…åˆnuxt.config.js

7. **static**: é™æ€æ–‡ä»¶ã€‚æ”¾ç½®ä¸éœ€è¦ç»è¿‡ webpack æ‰“åŒ…çš„é™æ€èµ„æºã€‚å¦‚ä¸€äº› js, css åº“ã€‚

8. **store**: Nuxt.js æ¡†æ¶é›†æˆäº† [Vuex çŠ¶æ€æ ‘](http://vuex.vuejs.org/) çš„ç›¸å…³åŠŸèƒ½é…ç½®ï¼Œåœ¨ `store` ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª `index.js` æ–‡ä»¶å¯æ¿€æ´»è¿™äº›é…ç½®ã€‚

9. **nuxt.config.js**: `nuxt.config.js` æ–‡ä»¶ç”¨äºç»„ç»‡Nuxt.js åº”ç”¨çš„ä¸ªæ€§åŒ–é…ç½®ï¼Œä»¥ä¾¿è¦†ç›–é»˜è®¤é…ç½®ã€‚å…·ä½“é…ç½®è¯·ç§»æ­¥è‡³ [å®˜ç½‘](https://zh.nuxtjs.org/guide/configuration)ã€‚

### Nuxtç”Ÿå‘½å‘¨æœŸ

å‚è€ƒæ–‡ç« ï¼šhttps://www.cnblogs.com/XF-eng/p/14611496.html

ä¼—æ‰€å‘¨çŸ¥ï¼ŒVue çš„ç”Ÿå‘½å‘¨æœŸå…¨éƒ½è·‘åœ¨å®¢æˆ·ç«¯(æµè§ˆå™¨)ï¼Œè€ŒNuxtçš„ç”Ÿå‘½å‘¨æœŸæœ‰äº›åœ¨æœåŠ¡ç«¯(Node)ã€å®¢æˆ·ç«¯ï¼Œç”šè‡³ä¸¤è¾¹éƒ½åœ¨:

![img](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202308161617933.png)

ä»¥ä¸Šæ˜¯ nuxt.js çš„ç”Ÿå‘½å‘¨æœŸæµç¨‹å›¾ï¼Œçº¢æ¡†å†…çš„æ˜¯Nuxt çš„ç”Ÿå‘½å‘¨æœŸ(è¿è¡Œåœ¨æœåŠ¡ç«¯)ï¼Œé»„æ¡†å†…åŒæ—¶è¿è¡Œåœ¨æœåŠ¡ç«¯&&å®¢æˆ·ç«¯ä¸Šï¼Œç»¿æ¡†å†…åˆ™è¿è¡Œåœ¨å®¢æˆ·ç«¯ã€‚

**å› ä¸º çº¢æ¡†ã€é»„æ¡†å†…çš„å‘¨æœŸéƒ½ä¸å­˜åœ¨Windowå¯¹è±¡ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥ä½¿ç”¨window**

```vue
<script>
export default {
  asyncData() {
    console.log(window) // æœåŠ¡ç«¯æŠ¥é”™
  },
  fetch() {
    console.log(window) // æœåŠ¡ç«¯æŠ¥é”™
  },
  created () {
    console.log(window) // undefined
  },
  mounted () {
    console.log(window) // Window {postMessage: Æ’, blur: Æ’, focus: Æ’, close: Æ’, frames: Window, â€¦}
  }
}
</script>
```

#### nuxtServerInit (SSR)

nuxtServerInit å¯¹stroeæ“ä½œ

1.æœåŠ¡å™¨åˆå§‹åŒ–
2.åªèƒ½å¤Ÿåœ¨store/index.jsä¸­ä½¿ç”¨
3.ç”¨äºåœ¨æ¸²æŸ“é¡µé¢ä¹‹å‰å­˜å‚¨æ•°æ®åˆ°vuexä¸­

ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ï¼švuexä¸Šä¸‹æ–‡
ç¬¬äºŒä¸ªå‚æ•°æ˜¯ï¼šNuxtä¸Šä¸‹æ–‡

store/index.js

```javascript
export const actions = {
    nuxtServerInit(store, context) {
        console.log('nuxtServerInit', store, context)
    }
}
```

![image-20230816162701463](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202308161627574.png)

```javascript
// store/index.js

export const actions = {
  nuxtServerInit(store, {app:{$cookies},route,$axios,req,res,redirect}) {

    let user = $cookies.get('user') ? $cookies.get('user') : {err:2,msg:'æœªç™»å½•',token:''};
    // store.dispatch('user/A_UPDATE_USER',user)  user== store/user.js
    store.commit('user/M_UPDATE_USER',user)
  }
}
```

#### middleware(SSR)

> ä¸­é—´ä»¶æ‰§è¡Œæµç¨‹é¡ºåº:
>
> `nuxt.config.js`->åŒ¹é…å¸ƒå±€->åŒ¹é…é¡µé¢
>
> `middleware nuxt.config outside`->`middleware layouts`->`middleware pages`

```javascript
//middleware/auth.js
export default ({app:{$cookies},store,redirect,route,$axios,params,query,req,res})=>{
  
}

//nuxt.conig.js
router: {
  middleware: 'auth' //å…¨å±€å®ˆå« è¿è¡Œä¸€ç»„é¡µé¢æ¸²æŸ“ä¹‹å‰
}

//layouts/a.vue  è¿è¡Œåœ¨ä¸€ä¸ªå¸ƒå±€ä¹‹å‰
middleware(){..}, //å®šä¹‰åœ¨å†…éƒ¨
middleware:'auth', //å®šä¹‰åœ¨å¤–éƒ¨
  
//pages/a.vue  è¿è¡Œåœ¨ä¸€ä¸ªé¡µé¢ä¹‹å‰
middleware(){..}, //å®šä¹‰åœ¨å†…éƒ¨
middleware:'auth', //å®šä¹‰åœ¨å¤–éƒ¨
  
//ä¸­é—´ä»¶æ‰§è¡Œæµç¨‹é¡ºåºï¼š
//nuxt.config.js->åŒ¹é…å¸ƒå±€->åŒ¹é…é¡µé¢
```

##### nuxt.config.js

æ–°å»ºmiddleware/auth.js

```javascript
export default ({store, route, redirect, params, query, req, res}) => {
    // context æœåŠ¡å™¨ä¸Šä¸‹æ–‡
    // å…¨å±€å®ˆå«ä¸šåŠ¡
    console.log('middleware/auth.js')
}
```

æ­¤å¤–è¿˜éœ€è¦åœ¨nuxt.config.jsä¸­æ–°å¢routeré…ç½®

```javascript
export default {
  // Global page headers: https://go.nuxtjs.dev/config-head
  head: {
    title: 'nuxt01-start',
    htmlAttrs: {
      lang: 'en'
    },
    meta: [
      { charset: 'utf-8' },
      { name: 'viewport', content: 'width=device-width, initial-scale=1' },
      { hid: 'description', name: 'description', content: '' },
      { name: 'format-detection', content: 'telephone=no' }
    ],
    link: [
      { rel: 'icon', type: 'image/x-icon', href: '/favicon.ico' }
    ]
  },

`  router: {
    middleware: 'auth'
  },`

  // Global CSS: https://go.nuxtjs.dev/config-css
  css: [
  ],

  // Plugins to run before rendering page: https://go.nuxtjs.dev/config-plugins
  plugins: [
  ],

  // Auto import components: https://go.nuxtjs.dev/config-components
  components: true,

  // Modules for dev and build (recommended): https://go.nuxtjs.dev/config-modules
  buildModules: [
  ],

  // Modules: https://go.nuxtjs.dev/config-modules
  modules: [
  ],

  // Build Configuration: https://go.nuxtjs.dev/config-build
  build: {
  }
}
```

![image-20230816163738009](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202308161637065.png)

##### å¸ƒå±€

æ–°å»ºlayouts/default.vueæ–‡ä»¶

```vue
<template>
  <div class="d-layout">
        <nuxt/>
  </div>
</template>

<script>
export default {
`    // middleware: 'auth' // é¡µé¢å±‚çº§ä¸­é—´ä»¶å®šä¹‰
    middleware() {
        console.log('middleware->layouts/default.vue')
    }`

}
</script>

<style scoped>
.d-layout {
    width: 100%;
    height: 100%;
    border: 1px solid red;
    background-color: #ccc;
}
</style>
```

ä¿®æ”¹pages/index.vueçš„å¸ƒå±€

```vue
<template>
  <Tutorial/>
</template>

<script>
export default {
  name: 'IndexPage',
`  layout: 'default'`
}
</script>

```

![image-20230816170211025](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202308161702124.png)

##### é¡µé¢

pages/index.vue

```vue
<template>
  <Tutorial/>
</template>

<script>
export default {
  name: 'IndexPage',
  layout: 'default',
`  // middleware: 'auth' // é¡µé¢å±‚çº§ä¸­é—´ä»¶å®šä¹‰
  middleware() {
    console.log('middleware->pages/index.vue')
  }`
}
</script>

```

![image-20230816170601706](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202308161706764.png)

#### validate(SSR)

ä¸‹æ¥è¯·æ±‚åˆ°è¾¾ validate æ–¹æ³•ï¼Œåœ¨è¿™é‡Œå¯ä»¥å¯¹ page ç»„ä»¶ component ç»„ä»¶ è¿›è¡ŒåŠ¨æ€è·¯å‚æ•°çš„æœ‰æ•ˆæ€§ã€‚è¿”å› `true` è¯´æ˜è·¯ç”±æœ‰æ•ˆï¼Œåˆ™è¿›å…¥è·¯ç”±é¡µé¢ã€‚è¿”å›ä¸æ˜¯ `true` åˆ™æ˜¾ç¤º 404 é¡µé¢ã€‚

åªèƒ½åœ¨é¡µé¢ç»„ä»¶ä½¿ç”¨(pages/xx.vue)

å¯ä»¥è®©ä½ åœ¨åŠ¨æ€è·¯ç”±å¯¹åº”çš„é¡µé¢ç»„ä»¶ä¸­é…ç½®ä¸€ä¸ªæ ¡éªŒæ–¹æ³•ç”¨äºæ ¡éªŒåŠ¨æ€è·¯ç”±å‚æ•°çš„æœ‰æ•ˆæ€§ã€‚

pages/index.vue

```vue
<template>
  <Tutorial/>
</template>

<script>
export default {
  name: 'IndexPage',
  layout: 'default',
  // middleware: 'auth' // é¡µé¢å±‚çº§ä¸­é—´ä»¶å®šä¹‰
  middleware() {
    console.log('middleware->pages/index.vue')
  },

`  // å‚æ•°çš„æœ‰æ•ˆæ€§
  validate({params, query}) {
    console.log('validate', params, query)
    return true; // trueé¡µé¢æ‰ä¼šæ˜¾ç¤º
  }`
}
</script>

```

![image-20230816171203848](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202308161712934.png)

#### asyncData(SSR)

è¿™ä¸ªæ–¹æ³•å¯ä»¥ä½¿å¾—ä½ èƒ½å¤Ÿåœ¨æ¸²æŸ“ç»„ä»¶ä¹‹å‰å¼‚æ­¥è·å–æ•°æ®ã€‚å¥½æ¯”ä½ åœ¨vueç»„ä»¶ä¸­ç”¨createdè·å–æ•°æ®ä¸€æ ·ï¼Œä¸åŒçš„æ˜¯asyncDataæ˜¯åœ¨æœåŠ¡ç«¯æ‰§è¡Œçš„
è¿˜æœ‰è¦æ³¨æ„çš„æ˜¯ï¼š**asyncDataåªæ˜¯åœ¨é¦–å±çš„æ—¶å€™è°ƒç”¨ä¸€æ¬¡ï¼ˆå³é¡µé¢æ¸²æŸ“ä¹‹å‰ï¼Œæ‰€ä»¥äº‹ä»¶è§¦å‘ä¸äº†å®ƒï¼‰**

pages/index.vue

```vue
<template>
  <Tutorial/>
</template>

<script>
export default {
  name: 'IndexPage',
  layout: 'default',
  // middleware: 'auth' // é¡µé¢å±‚çº§ä¸­é—´ä»¶å®šä¹‰
  middleware() {
    console.log('middleware->pages/index.vue')
  },

  // å‚æ•°çš„æœ‰æ•ˆæ€§
  validate({params, query}) {
    console.log('validate', params, query)
    return true; // trueé¡µé¢æ‰ä¼šæ˜¾ç¤º
  },

 ` // è¯»æ•°æ®ï¼Œè¿”å›ç»™ç»„ä»¶
  asyncData(context) {
    // å¼‚æ­¥ä¸šåŠ¡é€»è¾‘ï¼Œè¯»å–æœåŠ¡å™¨æ•°æ®
    console.log('asyncData')
    // è¿”å›çš„æ•°æ®ä¼šå’Œdataé‡Œé¢çš„æ•°æ®åˆå¹¶
    return {
      b: 2
    }
  },`


  data() {
    return {
      a: 1,
      b: 1111
    }
  }
}
</script>

```

![image-20230817104959703](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202308171049784.png)

![image-20230817104917019](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202308171049117.png)

```javascript
//pages/a.vue
async asyncData(context){//é¡µé¢ç»„ä»¶æ•°æ®é¢„è½½ éœ€è¦return ä¹‹åä¼šå’Œé¡µé¢dataåˆå¹¶
  let res = await context.$axios({url:'/api/goods/home'})
  return {msg2:'oo',data:res.data}//ç»„ä»¶æ•°æ® å¼‚æ­¥çš„ï¼Œåˆå§‹çš„éƒ½åœ¨è¿™é‡Œç”Ÿæˆ
}

asyncData ({ params }) {
  return axios.get(`https://my-api/posts/${params.id}`)
    .then((res) => {
      return { title: res.data.title }
    })
}

async fetch(context){
  let res = await context.$axios({url:'/api/goods/home'})
  context.store.commit('XXX',res.data);//çŠ¶æ€æ“ä½œ
}
```

#### fetch(SSR)

fetch æ–¹æ³•ç”¨äºåœ¨æ¸²æŸ“é¡µé¢å‰å¡«å……åº”ç”¨çš„çŠ¶æ€æ ‘ï¼ˆstoreï¼‰æ•°æ®ï¼Œ ä¸ asyncData æ–¹æ³•ç±»ä¼¼ï¼Œä¸åŒçš„æ˜¯å®ƒä¸ä¼šè®¾ç½®ç»„ä»¶çš„æ•°æ®ã€‚
å¦‚æœé¡µé¢ç»„ä»¶è®¾ç½®äº† fetch æ–¹æ³•ï¼Œå®ƒä¼šåœ¨ç»„ä»¶æ¯æ¬¡åŠ è½½å‰è¢«è°ƒç”¨ï¼ˆåœ¨æœåŠ¡ç«¯æˆ–åˆ‡æ¢è‡³ç›®æ ‡è·¯ç”±ä¹‹å‰ï¼‰ã€‚
fetch æ–¹æ³•çš„**ç¬¬ä¸€ä¸ªå‚æ•°**æ˜¯é¡µé¢ç»„ä»¶çš„ä¸Šä¸‹æ–‡å¯¹è±¡ contextï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ fetch æ–¹æ³•æ¥è·å–æ•°æ®å¡«å……åº”ç”¨çš„çŠ¶æ€æ ‘ã€‚ä¸ºäº†è®©è·å–è¿‡ç¨‹å¯ä»¥å¼‚æ­¥ï¼Œä½ éœ€è¦è¿”å›ä¸€ä¸ª **Promise**ï¼ŒNuxt.js ä¼šç­‰è¿™ä¸ª promise å®Œæˆåå†æ¸²æŸ“ç»„ä»¶ã€‚
**æ³¨æ„**ï¼Œåœ¨fetché˜¶æ®µæ˜¯æ— æ³•ä½¿ç”¨thisè·å–ç»„ä»¶å®ä¾‹ï¼Œfetchæ˜¯åœ¨ç»„ä»¶åˆå§‹åŒ–ä¹‹å‰è¢«è°ƒç”¨ï¼ˆå¥½åƒfetchå‡½æ•°ä¹Ÿä¼šåœ¨createdå’ŒbeforeMountä¹‹é—´æ‰§è¡Œä¸€æ¬¡ï¼‰

pages/index.vue

```vue
<template>
  <Tutorial/>
</template>

<script>
export default {
  name: 'IndexPage',
  layout: 'default',
  // middleware: 'auth' // é¡µé¢å±‚çº§ä¸­é—´ä»¶å®šä¹‰
  middleware() {
    console.log('middleware->pages/index.vue')
  },

  // å‚æ•°çš„æœ‰æ•ˆæ€§
  validate({params, query}) {
    console.log('validate', params, query)
    return true; // trueé¡µé¢æ‰ä¼šæ˜¾ç¤º
  },

  // è¯»æ•°æ®ï¼Œè¿”å›ç»™ç»„ä»¶
  asyncData(context) {
    // å¼‚æ­¥ä¸šåŠ¡é€»è¾‘ï¼Œè¯»å–æœåŠ¡å™¨æ•°æ®
    console.log('asyncData')
    // è¿”å›çš„æ•°æ®ä¼šå’Œdataé‡Œé¢çš„æ•°æ®åˆå¹¶
    return {
      b: 2
    }
  },

`  // è¯»æ•°æ®ï¼Œè¿”å›ç»™vuex
  fetch({store}) {
    // å¼‚æ­¥ä¸šåŠ¡é€»è¾‘ï¼Œè¯»å–æœåŠ¡å™¨æ•°æ®æäº¤ç»™vuex
    console.log('fetch')
  },`


  data() {
    return {
      a: 1,
      b: 1111
    }
  }
}
</script>

```

![image-20230817105356687](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202308171053784.png)



```vue
<template>
  <h1>Stars: {{ $store.state.stars }}</h1>
</template>

<script>
  export default {
    fetch({ store, params }) {
      return axios.get('http://my-api/stars').then(res => {
        store.commit('setStars', res.data)
      })
    }
  }
</script>
```

å¦‚æœè¦åœ¨fetchä¸­è°ƒç”¨å¹¶æ“ä½œstoreï¼Œè¯·ä½¿ç”¨store.dispatchï¼Œä½†æ˜¯è¦ç¡®ä¿åœ¨å†…éƒ¨ä½¿ç”¨async / awaitç­‰å¾…æ“ä½œç»“æŸï¼š
```vue
<script>
  export default {
    async fetch({ store, params }) {
      await store.dispatch('GET_STARS')
    }
  }
</script>
```

#### beforeCreatå’Œcreatedé˜¶æ®µ(SSR && CSR)

pages/index.vue

```vue
<template>
  <Tutorial/>
</template>

<script>
export default {
  name: 'IndexPage',
  layout: 'default',
  // middleware: 'auth' // é¡µé¢å±‚çº§ä¸­é—´ä»¶å®šä¹‰
  middleware() {
    console.log('middleware->pages/index.vue')
  },

  // å‚æ•°çš„æœ‰æ•ˆæ€§
  validate({params, query}) {
    console.log('validate', params, query)
    return true; // trueé¡µé¢æ‰ä¼šæ˜¾ç¤º
  },

  // è¯»æ•°æ®ï¼Œè¿”å›ç»™ç»„ä»¶
  asyncData(context) {
    // å¼‚æ­¥ä¸šåŠ¡é€»è¾‘ï¼Œè¯»å–æœåŠ¡å™¨æ•°æ®
    console.log('asyncData')
    // è¿”å›çš„æ•°æ®ä¼šå’Œdataé‡Œé¢çš„æ•°æ®åˆå¹¶
    return {
      b: 2
    }
  },

  // è¯»æ•°æ®ï¼Œè¿”å›ç»™vuex
  fetch({store}) {
    // å¼‚æ­¥ä¸šåŠ¡é€»è¾‘ï¼Œè¯»å–æœåŠ¡å™¨æ•°æ®æäº¤ç»™vuex
    console.log('fetch')
  },
`  //SSR && CSR
  beforeCreate(){
    console.log('beforeCreate')
  },
  created(){
    // console.log('created',this)
    console.log('created')
  },`

  data() {
    return {
      a: 1,
      b: 1111
    }
  }
}
</script>

```

![image-20230817110531602](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202308171105672.png)

#### å…¶ä»–vueç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼ˆCSRï¼‰

pages/index.vue

```vue
<template>
  <Tutorial />
</template>

<script>
export default {
  name: "IndexPage",
  layout: "default",
  // middleware: 'auth' // é¡µé¢å±‚çº§ä¸­é—´ä»¶å®šä¹‰
  middleware() {
    console.log("middleware->pages/index.vue");
  },

  // å‚æ•°çš„æœ‰æ•ˆæ€§
  validate({ params, query }) {
    console.log("validate", params, query);
    return true; // trueé¡µé¢æ‰ä¼šæ˜¾ç¤º
  },

  // è¯»æ•°æ®ï¼Œè¿”å›ç»™ç»„ä»¶
  asyncData(context) {
    // å¼‚æ­¥ä¸šåŠ¡é€»è¾‘ï¼Œè¯»å–æœåŠ¡å™¨æ•°æ®
    console.log("asyncData");
    // è¿”å›çš„æ•°æ®ä¼šå’Œdataé‡Œé¢çš„æ•°æ®åˆå¹¶
    return {
      b: 2,
    };
  },

  // è¯»æ•°æ®ï¼Œè¿”å›ç»™vuex
  fetch({ store }) {
    // å¼‚æ­¥ä¸šåŠ¡é€»è¾‘ï¼Œè¯»å–æœåŠ¡å™¨æ•°æ®æäº¤ç»™vuex
    console.log("fetch");
  },
  //SSR && CSR
  beforeCreate() {
    console.log("beforeCreate");
  },
  created() {
    // console.log('created',this)
    console.log("created");
  },

  //CSR   window thisæŒ‡å‘ç»„ä»¶
  beforeMount() {
    console.log('beforeMount')
  },
  mounted() {
    console.log("mounted")
  },
  beforeUpdate() {
    console.log('beforeUpdate')
  },
  updated() {
    console.log("updated")
  },
  beforeDestroy() {
    console.log('beforeDestroy')
  },
  destroyed() {
    console.log('destroyed')
  },

  ///æœåŠ¡ç«¯æ¸²æŸ“ æ¿€æ´»ã€å¤±æ´» ä¸å­˜åœ¨
  // activated(){},
  // deactivated(){},
  data() {
    return {
      a: 1,
      b: 1111,
    };
  },
};
</script>

```

![image-20230817110759997](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202308171108062.png)

### è·¯ç”±

#### çº¦å®šå¼è·¯ç”±

å±•ç¤ºåŒº:
name:è·¯ç”±åç›®å½•å-å…¶ä»–ç›®å½•-æ–‡ä»¶å
params: keyè¦å¯¹ç­‰æ–‡ä»¶å
å­è·¯ç”±:ç›®å½•ä»£è¡¨å­è·¯ç”±ï¼Œå­è·¯ç”±å†…éƒ¨åŒçº§çš„æ–‡ä»¶ï¼Œä»£è¡¨æ˜¯åŒçº§ä¸€çº§è·¯ç”±
é…ç½®
å£°æ˜å¼è·³è½¬:`<nuxt-link :to=" name: 'product-id' ,params:{id:3] ,query:{a:111,b:222}}">å•†å“e3</nuxt-link>`

åŠ¨æ€è·¯ç”±ï¼Œ_åç§° ï¼ŒåŠ ä¸‹åˆ’çº¿ï¼Œä»£è¡¨å˜é‡

è·¯å¾„ä»pageså‡ºå‘ä¸ºä¾æ®

![image-20230819122838040](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202308191228182.png)

layouts/default.vue

```vue
<template>
  <div class="d-layout">
    <!-- è·³è½¬  å£°æ˜å¼è·³è½¬ router-link -->
    <nuxt-link to="/">é¦–é¡µ</nuxt-link>
    <nuxt-link to="/goods">å•†å“é¡µé¢</nuxt-link>
    <nuxt-link to="/userinfo">ç”¨æˆ·ä¿¡æ¯</nuxt-link>
    <nuxt-link :to="{name:'login',query:{a:11,b:22}}">ç™»é™†é¡µé¢</nuxt-link>
    <!-- å±•ç¤ºåŒº  ~~ router-view -->
    <nuxt />
  </div>
</template>

<script>
export default {
    // middleware: 'auth' // é¡µé¢å±‚çº§ä¸­é—´ä»¶å®šä¹‰
    middleware() {
        console.log('middleware->layouts/default.vue')
    }
}
</script>

<style scoped>
.d-layout {
    width: 100%;
    height: 100%;
    border: 1px solid red;
    background-color: #ccc;
}
</style>
```

pages/index.vue

```vue
<template>
  <div>
    <h1>é¦–é¡µ</h1>
  </div>
</template>
```

pages/UserInfo.vue

```vue
<template>
  <div>
    ç”¨æˆ·ä¿¡æ¯é¡µé¢
  </div>
</template>
```

pages/goods.vue

```vue
<template>
  <div>
    å•†å“é¡µé¢
    <hr>
    <nuxt-link to="/goods/1?a=1&b=2">å•†å“01</nuxt-link>
    <nuxt-link :to="{name:'goods-id',params:{id:2},query:{a:111,b:222}}">å•†å“02</nuxt-link>
    <nuxt-link :to="{name:'goods-id',params:{id:3},query:{a:111,b:222}}">å•†å“03</nuxt-link>
    <nuxt-link to="/goods/comment">è¯„è®º</nuxt-link>
    <nuxt/>
  </div>
</template>

<script>
export default {

}
</script>

<style>

</style>
```

pages/goods/_id.vue

```vue
<template>
  <div>
    å•†å“è¯¦æƒ…é¡µé¢{{ $route.params }}
  </div>
</template>
```

pages/goods/comment.vue

```vue
<template>
  <div> 
    è¯„è®ºé¡µé¢
    <hr>
    <nuxt-link :to="{name: 'goods-comment-uid', params: {uid: 1}, query: {a: 111, b: 2222}}">è¯„è®º01</nuxt-link>
    <nuxt-link to="/goods/comment/2?a=111&b=222">è¯„è®º02</nuxt-link>

    <nuxt/>
  </div>
</template>
```

pages/goods/comment/_uid.vue

```vue
<template>
  <div>
    è¯„è®ºé¡µé¢{{ $route.params }}
  </div>
</template>
```

![image-20230819123442098](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202308191234174.png)

#### å±•ç¤ºåŒºå±‚çº§æ§åˆ¶

| Path                     | File                |
| ------------------------ | ------------------- |
| `/`                      | `index.vue`         |
| `/goods`                 | `goods/index.vue`   |
| `/goods/123`             | `goods/_id.vue`     |
| `/goods/comment`         | `goods/comment.vue` |
| `/about`                 | `_.vue`             |
| `/about/careers`         | `_.vue`             |
| `/about/careers/chicago` | `_.vue`             |

pages/ä¸€çº§å±•ç¤º/äºŒçº§å±•ç¤º
								/index.vueä¼šåœ¨ä¸€çº§å±•ç¤º
								/index.vueç©ºæ–‡æ¡£ä»£è¡¨æœ‰é»˜è®¤é¡µï¼Œä¸ä¼šæ‰¾å¯»å…¶ä»–_è¯¦æƒ….vue

å¤„ç† 404 é¡µé¢ï¼Œç°åœ¨ç¬¦åˆ`_.vue`é¡µé¢çš„é€»è¾‘

æ¯”å¦‚è¯´æƒ³è¦å•†å“è¯¦æƒ…é¡µé¢ä¸€çº§å±•ç¤ºå°±éœ€è¦ï¼ŒæŠŠpages/goods.vueç§»è‡³pages/goods/index.vue

![image-20230819125523877](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202308191255015.png)

#### æ‰©å±•æ€§è·¯ç”±

å…ˆå°†è·³è½¬æŠ½å–åˆ°app-headeræ–‡ä»¶ä¸­

`exact-active-class="xxx"`ï¼Œxxxæ ·å¼,åŠ ä¸Šexactï¼Œä»£è¡¨ä¸¥æ ¼åŒ¹é…

> ![image-20230819155301308](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202308191559612.png)

layouts/app-header.vue

```vue
<template>
  <div>
        <!-- è·³è½¬  å£°æ˜å¼è·³è½¬ router-link -->
        <nuxt-link to="/index" exact-active-class="app_header--active">é¦–é¡µ</nuxt-link>
        <nuxt-link to="/goods" active-class="app_header--active">å•†å“é¡µé¢</nuxt-link>
        <nuxt-link to="/userinfo" active-class="app_header--active">ç”¨æˆ·ä¿¡æ¯</nuxt-link>
        <nuxt-link :to="{name:'login',query:{a:11,b:22}}" active-class="app_header--active">ç™»é™†é¡µé¢</nuxt-link>
  </div>
</template>

<script>
export default {

}
</script>

<style scoped>
.app_header--active {
    color: red;
    background-color: blueviolet;
}
</style>
```

nuxt.config.js

```javascript
export default {
  // Global page headers: https://go.nuxtjs.dev/config-head
  head: {
    title: 'nuxt01-start',
    htmlAttrs: {
      lang: 'en'
    },
    meta: [
      { charset: 'utf-8' },
      { name: 'viewport', content: 'width=device-width, initial-scale=1' },
      { hid: 'description', name: 'description', content: '' },
      { name: 'format-detection', content: 'telephone=no' }
    ],
    link: [
      { rel: 'icon', type: 'image/x-icon', href: '/favicon.ico' }
    ]
  },

  router: {
    middleware: 'auth',
  `  // æ‰©å±•è·¯ç”±
    extendRoutes(routes, resolve) {
      console.log(routes)
      routes.push({
        name: 'home',
        path: '/index',
        component: resolve(__dirname, 'pages/index.vue')
      })
    }`
  },

  // Global CSS: https://go.nuxtjs.dev/config-css
  css: [
  ],

  // Plugins to run before rendering page: https://go.nuxtjs.dev/config-plugins
  plugins: [
  ],

  // Auto import components: https://go.nuxtjs.dev/config-components
  components: true,

  // Modules for dev and build (recommended): https://go.nuxtjs.dev/config-modules
  buildModules: [
  ],

  // Modules: https://go.nuxtjs.dev/config-modules
  modules: [
  ],

  // Build Configuration: https://go.nuxtjs.dev/config-build
  build: {
  }
}

```

#### å‚æ•°æ ¡éªŒ

pages/goods/_id.vue

validateå‡½æ•°è¿”å›trueæ‰å¯ä»¥è®¿é—®è¯¥é¡µé¢ï¼Œè¿”å›falseä¼šè·³è½¬åˆ°erroré¡µé¢

```vue
<template>
  <div>
    å•†å“è¯¦æƒ…é¡µé¢{{ $route.params }}
  </div>
</template>

<script>
export default {
  // å‚æ•°æœ‰æ•ˆæ€§åˆ¤æ–­
  validate({ params, query }) {
    return  typeof params.id === 'number'
  }
}
</script>

<style>

</style>
```

#### é”™è¯¯é¡µé¢å®šåˆ¶

é¢„å®šå¼ï¼Œé”™è¯¯é¡µé¢ä¸ºerror.vue

layouts/error.vue

```vue
<template>
  <div>
    <h1 v-if="error.statusCode">{{error.message}}</h1>
    <h1 v-else>åº”ç”¨å‘ç”Ÿå¼‚å¸¸</h1>
    <button @click="$router.replace('/index')">è·³è½¬åˆ°é¦–é¡µ</button>
  </div>
</template>

<script>
export default {
    // æ¥å—é”™è¯¯ä¿¡æ¯ error: {statusCode, message }
    props: ['error']
}
</script>

<style>

</style>
```

![image-20230819164220643](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202308191642732.png)

#### è·¯ç”±ç»Ÿä¸€åŠ¨æ•ˆ

assets/css/transition.css

```css
/* è·¯ç”±ç»Ÿä¸€åŠ¨æ•ˆï¼ˆå¿…é¡»ç”¨pageï¼‰ */

/*åŠ¨ç”»å½¢å¼*/
.page-enter-active, .page-leave-active {
    transition: opticity .5s;
}
/*å…¥ é€€*/
.page-enter, .page-leave-active {
    opacity: 0;
}
```

nuxt.config.js

```javascript
export default {
  // Global page headers: https://go.nuxtjs.dev/config-head
  head: {
    title: 'nuxt01-start',
    htmlAttrs: {
      lang: 'en'
    },
    meta: [
      { charset: 'utf-8' },
      { name: 'viewport', content: 'width=device-width, initial-scale=1' },
      { hid: 'description', name: 'description', content: '' },
      { name: 'format-detection', content: 'telephone=no' }
    ],
    link: [
      { rel: 'icon', type: 'image/x-icon', href: '/favicon.ico' }
    ]
  },

  router: {
    middleware: 'auth',
    // æ‰©å±•è·¯ç”±
    extendRoutes(routes, resolve) {
      console.log(routes)
      routes.push({
        name: 'home',
        path: '/index',
        component: resolve(__dirname, 'pages/index.vue')
      })
    }
  },

  // Global CSS: https://go.nuxtjs.dev/config-css
  // å…¨å±€æ ·å¼
`  css: [
    'assets/css/transition.css'
  ],`

  // Plugins to run before rendering page: https://go.nuxtjs.dev/config-plugins
  plugins: [
  ],

  // Auto import components: https://go.nuxtjs.dev/config-components
  components: true,

  // Modules for dev and build (recommended): https://go.nuxtjs.dev/config-modules
  buildModules: [
  ],

  // Modules: https://go.nuxtjs.dev/config-modules
  modules: [
  ],

  // Build Configuration: https://go.nuxtjs.dev/config-build
  build: {
  }
}

```

#### è·¯ç”±ç‹¬äº«åŠ¨æ•ˆ

assets/transition.css

```css
/* è·¯ç”±ç»Ÿä¸€åŠ¨æ•ˆï¼ˆå¿…é¡»ç”¨pageï¼‰ */

/*åŠ¨ç”»å½¢å¼*/
.page-enter-active, .page-leave-active {
    transition: opticity .5s;
}
/*å…¥ é€€*/
.page-enter, .page-leave-active {
    opacity: 0;
}


/*è·¯ç”±ç‹¬äº«åŠ¨æ•ˆ*/
.test-enter-active, .test-leave-active {
    transition: .5s ease all;
}
.test-enter, .test-leave-active {
    margin-left: -1000px;
}  
```

pages/goods/_id.vue

```vue
<template>
  <div>
    å•†å“è¯¦æƒ…é¡µé¢{{ $route.params }}
  </div>
</template>

<script>
export default {
  // å‚æ•°æœ‰æ•ˆæ€§åˆ¤æ–­
  validate({ params, query }) {
    return  typeof params.id === 'number'
  },
  // transition: 'åŠ¨ç”»å'
  transition: 'test'
}
</script>

<style scoped>
/**
  .test-enter-active, .test-leave-active {
    transition: .5s ease all;
  }
  .test-enter, .test-leave-active {
    margin-left: -1000px;
  }  
*/
</style>
```

#### è·¯ç”±å®ˆå«

å‰ç½®ï¼šä¾èµ–ä¸­é—´ä»¶middlware,æ’ä»¶

* å…¨å±€å®ˆå«: nuxt.configæŒ‡å‘middleware	
* layoutså®šä¹‰ä¸­é—´ä»¶	
* ç»„ä»¶ç‹¬äº«å®ˆå«: middlewareï¼ˆå†™æ³•åŒlayoutsï¼‰
* æ’ä»¶å…¨å±€å‰ç½®å®ˆå«

åç½®ï¼šç»„ä»¶ç‹¬äº«åç½®å®ˆå«ï¼Œä½¿ç”¨vueçš„beforeRouteLeaveé’©å­

 	æ’ä»¶å…¨å±€åç½®å®ˆå«

##### å‰ç½®å®ˆå«

**ç¬¬ä¸€ç§æ–¹å¼ï¼š nuxt.config.js**

åœ¨middlewareä¸­æŒ‡å®šauth.jsæ–‡ä»¶ï¼ˆmiddleware/auth.jsï¼‰

```javascript
export default {
  router: {
    `middleware: 'auth',`
    // æ‰©å±•è·¯ç”±
    extendRoutes(routes, resolve) {
      console.log(routes)
      routes.push({
        name: 'home',
        path: '/index',
        component: resolve(__dirname, 'pages/index.vue')
      })
    }
  }
}

```

middleware/auth.js

```javascript
export default ({store, route, redirect, params, query, req, res}) => {
    //context æœåŠ¡ç«¯ä¸Šä¸‹æ–‡
    //å…¨å±€å®ˆå«å‰ç½®ä¸šåŠ¡
    //store çŠ¶æ€æ ‘ä¿¡æ¯
    //route ä¸€æ¡ç›®æ ‡è·¯ç”±ä¿¡æ¯
    // redirect å¼ºåˆ¶è·³è½¬
    //params,query æ ¡éªŒå‚æ•°åˆç†æ€§
    console.log('middleware/auth.js')
    redirect('/login')
}
```

**ç¬¬äºŒç§æ–¹å¼ï¼š**

layouts/default.vue

```vue
<template>
  <div class="d-layout">
    <app-header></app-header>
    <!-- å±•ç¤ºåŒº  ~~ router-view -->
    <nuxt />
  </div>
</template>

<script>
import appHeader from './app-header.vue'
export default {
  components: { appHeader },
    // middleware: 'auth' // é¡µé¢å±‚çº§ä¸­é—´ä»¶å®šä¹‰
`  middleware({store,route,redirect,params,query}) {
    //context æœåŠ¡ç«¯ä¸Šä¸‹æ–‡
    //å…¨å±€å®ˆå«å‰ç½®ä¸šåŠ¡
    //store çŠ¶æ€æ ‘ä¿¡æ¯
    //route ä¸€æ¡ç›®æ ‡è·¯ç”±ä¿¡æ¯
    // redirect å¼ºåˆ¶è·³è½¬
    //params,query æ ¡éªŒå‚æ•°åˆç†æ€§
    console.log('middleware layouts å…¨å±€å®ˆå«å‰ç½®ä¸šåŠ¡')
    console.log('middleware->layouts/default.vue')
    redirect('/login')
  }`
}
</script>

<style scoped>
.d-layout {
    width: 100%;
    height: 100%;
    border: 1px solid red;
    background-color: #ccc;
}
</style>
```

**ç¬¬ä¸‰ç§æ–¹å¼ï¼šç»„ä»¶ç‹¬äº«å®ˆå«**

pages/index.vue

```vue
<template>
  <div>
    <h1>é¦–é¡µ</h1>
  </div>
</template>

<script>
export default {
  name: "IndexPage",
  layout: "default",
  // middleware: 'auth' // é¡µé¢å±‚çº§ä¸­é—´ä»¶å®šä¹‰
  middleware({store,route,redirect,params,query}) {
    //context æœåŠ¡ç«¯ä¸Šä¸‹æ–‡
    //å…¨å±€å®ˆå«å‰ç½®ä¸šåŠ¡
    //store çŠ¶æ€æ ‘ä¿¡æ¯
    //route ä¸€æ¡ç›®æ ‡è·¯ç”±ä¿¡æ¯
    // redirect å¼ºåˆ¶è·³è½¬
    //params,query æ ¡éªŒå‚æ•°åˆç†æ€§
    console.log('middleware layouts å…¨å±€å®ˆå«å‰ç½®ä¸šåŠ¡')
    console.log("middleware->pages/index.vue");
    redirect('/userinfo')
  },

  // å‚æ•°çš„æœ‰æ•ˆæ€§
  validate({ params, query }) {
    console.log("validate", params, query);
    return true; // trueé¡µé¢æ‰ä¼šæ˜¾ç¤º
  }
};
</script>

```

ç‚¹å‡»é¦–é¡µï¼Œä¼šè·³è½¬åˆ°ç”¨æˆ·ä¿¡æ¯é¡µé¢

![image-20230819230423122](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202308192304229.png)

**ç¬¬å››ç§æ–¹å¼ï¼š æ’ä»¶å…¨å±€å‰ç½®å®ˆå«**

nuxt.config.js

//nuxt.configæ–‡ä»¶,~ä»£è¡¨æ ¹ç›®å½•

```javascript
export default {
  // Global page headers: https://go.nuxtjs.dev/config-head
  head: {
    title: 'nuxt01-start',
    htmlAttrs: {
      lang: 'en'
    },
    meta: [
      { charset: 'utf-8' },
      { name: 'viewport', content: 'width=device-width, initial-scale=1' },
      { hid: 'description', name: 'description', content: '' },
      { name: 'format-detection', content: 'telephone=no' }
    ],
    link: [
      { rel: 'icon', type: 'image/x-icon', href: '/favicon.ico' }
    ]
  },

  router: {
    middleware: 'auth',
    // æ‰©å±•è·¯ç”±
    extendRoutes(routes, resolve) {
      console.log(routes)
      routes.push({
        name: 'home',
        path: '/index',
        component: resolve(__dirname, 'pages/index.vue')
      })
    }
  },

  // Global CSS: https://go.nuxtjs.dev/config-css
  // å…¨å±€æ ·å¼
  css: [
    'assets/css/transition.css'
  ],

  // Plugins to run before rendering page: https://go.nuxtjs.dev/config-plugins
 ` plugins: [
	//nuxt.configæ–‡ä»¶,~ä»£è¡¨æ ¹ç›®å½•
    '~/plugins/router'
  ],`
}

```

plugins/router.js

```javascript
export default ({app,redirect,params,query,store})=>{ 
    console.log('æ’ä»¶å‰ç½®å®ˆå«')
     // app == vueå®ä¾‹
     app.router.beforeEach((to,from,next)=>{
        //å…¨å±€å‰ç½®çš„å®ˆå«ï¼Œæ’ä»¶
        //next(true)/next(false)   
        //next( '/login ') Ã—  redirect è·³è½¬å‡½æ•° âˆš
        // æ³¨æ„ï¼šä¸èƒ½ä½¿ç”¨nextæ¥è·³è½¬ï¼Œè¦ä½¿ç”¨redirect
        if (to.path === '/login') {
            next()
        } else {
            redirect('/login')
        }
     })
}
```

##### åç½®å®ˆå«

ç¬¬ä¸€ç§æ–¹å¼ï¼š

æ’ä»¶

plugins/router.js

```javascript
export default ({app,redirect,params,query,store})=>{ 
    console.log('æ’ä»¶å‰ç½®å®ˆå«')
     // app == vueå®ä¾‹
     app.router.beforeEach((to,from,next)=>{
        //å…¨å±€å‰ç½®çš„å®ˆå«ï¼Œæ’ä»¶
        //next(true)/next(false)   
        //next( '/login ') Ã—  redirect è·³è½¬å‡½æ•° âˆš
        // æ³¨æ„ï¼šä¸èƒ½ä½¿ç”¨nextæ¥è·³è½¬ï¼Œè¦ä½¿ç”¨redirect
        if (to.path === '/login') {
            next()
        } else {
            redirect('/login')
        }
     })
    
   ` //æ’ä»¶å…¨å±€åç½®å®ˆå«
    app.router.afterEach((to,from)=>{
    	console.log('æ’ä»¶å…¨å±€åç½®å®ˆå«')
    }) `
}
```

ç¬¬äºŒç§æ–¹å¼ï¼šç»„ä»¶ç‹¬äº«åç½®å®ˆå«

pages/index.vue

```vue
<template>
  <div>
    <h1>é¦–é¡µ</h1>
  </div>
</template>

<script>
export default {
  name: "IndexPage",
  layout: "default",
  // middleware: 'auth' // é¡µé¢å±‚çº§ä¸­é—´ä»¶å®šä¹‰
  middleware({store,route,redirect,params,query}) {
    //context æœåŠ¡ç«¯ä¸Šä¸‹æ–‡
    //å…¨å±€å®ˆå«å‰ç½®ä¸šåŠ¡
    //store çŠ¶æ€æ ‘ä¿¡æ¯
    //route ä¸€æ¡ç›®æ ‡è·¯ç”±ä¿¡æ¯
    // redirect å¼ºåˆ¶è·³è½¬
    //params,query æ ¡éªŒå‚æ•°åˆç†æ€§
    // console.log('middleware layouts å…¨å±€å®ˆå«å‰ç½®ä¸šåŠ¡')
    // console.log("middleware->pages/index.vue");
    // redirect('/userinfo')
  },
  // å‚æ•°çš„æœ‰æ•ˆæ€§
  validate({ params, query }) {
    console.log("validate", params, query);
    return true; // trueé¡µé¢æ‰ä¼šæ˜¾ç¤º
  },

`  // ç»„ä»¶ç‹¬äº«åç½®å®ˆå«
  beforeRouteLeave(to,from,next){
    let b1 = window.confirm('æ˜¯å¦è¦ç¦»å¼€')
    next(b1)
  }`
};
</script>

```

### æ•°æ®äº¤äº’ã€è·¨åŸŸ

å®‰è£…axiosã€proxy

```shell
npm i @nuxtjs/axios @nuxtjs/proxy --save
```

#### æ•°æ®äº¤äº’

é…ç½®nuxt.config.js

````javascript
export default {

  // Modules: https://go.nuxtjs.dev/config-modules
`  modules: [
    '@nuxtjs/axios'
  ],`

}

````

å…ˆæ¨¡æ‹Ÿæ•°æ®

static/data/list.json

```json
{
  "title": "nuxtæ•°æ®"
}
```

å‘é€è¯·æ±‚è·å–æ•°æ®

pages/index.vue

```vue
<template>
  <div>
    <h1>é¦–é¡µ</h1>
    <h3>{{title}}</h3>
  </div>
</template>

<script>
export default {
  name: "IndexPage",
  layout: "default",
  // è¯»æ•°æ®ï¼Œè¿”å›ç»™ç»„ä»¶
`  async asyncData({$axios}) {
    // å¼‚æ­¥ä¸šåŠ¡é€»è¾‘ï¼Œè¯»å–æœåŠ¡å™¨æ•°æ®
    let res = await $axios({url: '/data/list.json'})
    console.log('è¯»å–åˆ°çš„é™æ€æ•°æ®', res.data)
    // è¿”å›çš„æ•°æ®ä¼šå’Œdataé‡Œé¢çš„æ•°æ®åˆå¹¶
    return {
      title: res.data.title
    }
  },`

  // è¯»æ•°æ®ï¼Œè¿”å›ç»™vuex
  fetch({ store }) {
    // å¼‚æ­¥ä¸šåŠ¡é€»è¾‘ï¼Œè¯»å–æœåŠ¡å™¨æ•°æ®æäº¤ç»™vuex
    console.log("fetch");
  }
};
</script>


```

![image-20230821181441934](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202308211814098.png)

![image-20230821181556845](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202308211815962.png)

#### è·¨åŸŸ

è§£å†³è·¨åŸŸ

nuxt.config.js

```javascript

module.exports = {
  
  /*
  ** Nuxt.js modules
  */
  modules: [
    '@nuxtjs/axios'
  ],

 ` axios:{
    proxy:true,//å¼€å¯axiosè·¨åŸŸ
    // prefix:'/api',//baseUrl
  },
  proxy:{
    '/api/':{
      target:'http://localhost:3001',//ä»£ç†è½¬å‘çš„åœ°å€
      changeOrigin:true,
      pathRewrite:{
        // '^/api':''
      }
    }
  }`
}

```

#### æ‹¦æˆªå™¨é…ç½®ä¸tokenæºå¸¦

nuxt.config.js

```javascript
export default {

  // Plugins to run before rendering page: https://go.nuxtjs.dev/config-plugins
  plugins: [
    //nuxt.configæ–‡ä»¶,~ä»£è¡¨æ ¹ç›®å½•
    '~/plugins/router',
 `   {
      src: '~/plugins/axios',
      ssr: true // æœåŠ¡å™¨
    }`
  ],

  // Modules: https://go.nuxtjs.dev/config-modules
  modules: [
    '@nuxtjs/axios'
  ],
}

```

plugins/axios.js

```javascript
export default function({$axios,redirect,route,store}){
    //åŸºæœ¬é…ç½®
    $axios.defaults.timeout=10000;

    // è¯·æ±‚æ‹¦æˆª
    $axios.onRequest(config => {
        console.log('è¯·æ±‚æ‹¦æˆª')
        config.headers.token = 'eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI4YTZlNDk0MWFhZTI0OTViOGViYjllNzc1ZDQ5MWEzYiIsInN1YiI6IjEiLCJpc3MiOiJkZXAiLCJpYXQiOjE2OTI2MTQ5NDQsImV4cCI6MTY5MjcwMTM0NH0.GqanFI_WzYAfiaTFMcyk9xgNv5Aw2M0PlAiRF_bEyhY'
        return config
    })

    //å“åº”æ‹¦æˆª
    $axios.onResponse(res=>{
        console.log('å“åº”æ‹¦æˆª')
        if (res.code !== 200) {
            consolelog('è®¤è¯å¤±è´¥')            // 401 è®¤è¯å¤±è´¥(tokenè¿‡æœŸæˆ–å¤±æ•ˆæˆ–éæ³•) 403 æƒé™ä¸è¶³
            if (res.code === 401) {
              store.dispatch('user/logout')
              redirect('/login?path='+route.fullPath)
            }
          } else {
            return res
          }
    })

    //é”™è¯¯å¤„ç†
    $axios.onError(error=>{
        //å¤„ç†
        return error;
    })
}
```

pages/index.vue

```vue
<template>
  <div>
    <h1>é¦–é¡µ</h1>
    <h3>{{title}}</h3>
  </div>
</template>

<script>
export default {
  name: "IndexPage",
  layout: "default", 
  // è¯»æ•°æ®ï¼Œè¿”å›ç»™ç»„ä»¶
  async asyncData({$axios}) {
    // å¼‚æ­¥ä¸šåŠ¡é€»è¾‘ï¼Œè¯»å–æœåŠ¡å™¨æ•°æ®
    let res = await $axios({url: '/data/list.json'})
    console.log('è¯»å–åˆ°çš„é™æ€æ•°æ®', res.data)
    // è¿”å›çš„æ•°æ®ä¼šå’Œdataé‡Œé¢çš„æ•°æ®åˆå¹¶
    return {
      title: res.data.title
    }
  },

  // è¯»æ•°æ®ï¼Œè¿”å›ç»™vuex
  async fetch({ store, $axios}) {
    // å¼‚æ­¥ä¸šåŠ¡é€»è¾‘ï¼Œè¯»å–æœåŠ¡å™¨æ•°æ®æäº¤ç»™vuex
    // æµ‹è¯•è·¨åŸŸæ•°æ®
  `  let res = await $axios({url: '/api/sys/user'})
    console.log('è¯»å–çš„è·¨åŸŸæ•°æ®', res.data)
    console.log("fetch");`
  }
};
</script>

```

#### loadingé¡µé…ç½®ä¸å®šåˆ¶

nuxt.config.js

```javascript
export default {

  //å®šä¹‰ç³»ç»Ÿé»˜è®¤loadingæ•ˆæœ
  loading: {color:'#399', height: ' 3px'},

}

```

![image-20230821190417998](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202308211904103.png)

å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰ç»„ä»¶

components/loadding.vue

```vue
<template>
  <div v-if="loading" class="spinner"></div>
</template>
  <script>
export default {
  data: () => ({
    loading: false,
  }),
  methods: {
    // è¿™ä¸¤ä¸ªå‡½æ•°ä½¿nuxtä¸ºæˆ‘ä»¬æä¾›çš„ï¼Œä¸€ä¸ªæ˜¯è¯·æ±‚å¼€å§‹ï¼Œä¸€ä¸ªæ˜¯ç»“æŸ
    start() {
      this.loading = true;
    },
    finish() {
      this.loading = false;
    },
  },
};
</script>
  <style scoped>
.spinner {
  width: 60px;
  height: 60px;
  background-color: #399;

  position: fixed;
  left: 50%;
  top: 50%;
  margin-left: -30px;
  margin-top: -30px;
  -webkit-animation: rotateplane 1.2s infinite ease-in-out;
  animation: rotateplane 1.2s infinite ease-in-out;
}

@-webkit-keyframes rotateplane {
  0% {
    -webkit-transform: perspective(120px);
  }
  50% {
    -webkit-transform: perspective(120px) rotateY(180deg);
  }
  100% {
    -webkit-transform: perspective(120px) rotateY(180deg) rotateX(180deg);
  }
}

@keyframes rotateplane {
  0% {
    transform: perspective(120px) rotateX(0deg) rotateY(0deg);
    -webkit-transform: perspective(120px) rotateX(0deg) rotateY(0deg);
  }
  50% {
    transform: perspective(120px) rotateX(-180.1deg) rotateY(0deg);
    -webkit-transform: perspective(120px) rotateX(-180.1deg) rotateY(0deg);
  }
  100% {
    transform: perspective(120px) rotateX(-180deg) rotateY(-179.9deg);
    -webkit-transform: perspective(120px) rotateX(-180deg) rotateY(-179.9deg);
  }
}
</style>
  
  
  
```

ç„¶åä¿®æ”¹nuxt.config.jsé…ç½®æ–‡ä»¶

```javascript
export default {
    
  //å®šä¹‰ç³»ç»Ÿé»˜è®¤loadingæ•ˆæœ
  // loading: {color:'#399', height: ' 3px'},
  // ä½¿ç”¨è‡ªå®šä¹‰ç»„ä»¶
  loading: '~/components/loadding.vue',

}
```

### vuexå®šä¹‰å’Œä½¿ç”¨

**æ¨¡å—æ–¹å¼:** storeç›®å½•ä¸‹çš„æ¯ä¸ª`.js`æ–‡ä»¶ä¼šè¢«è½¬æ¢æˆä¸ºçŠ¶æ€æ ‘[æŒ‡å®šå‘½åçš„å­æ¨¡å—](http://vuex.vuejs.org/en/modules.html)ï¼ˆå½“ç„¶ï¼Œ`index`æ˜¯æ ¹æ¨¡å—ï¼‰

**Classic(ä¸å»ºè®®ä½¿ç”¨):** store/index.jsè¿”å›åˆ›å»ºVuex.storeå®ä¾‹çš„æ–¹æ³•ã€‚

stateå¿…é¡»æ˜¯ä¸€ä¸ªå‡½æ•°ï¼ˆè§„å®šï¼‰ï¼Œå…¶ä»–å¯ä»¥ä¸ºå¯¹è±¡ï¼Œç„¶åæ‰¹é‡å¯¼å‡ºindexå†…çš„state,mutations,actions,getters

#### åŸºæœ¬ä½¿ç”¨

store/index.js

```javascript
//ä¸»æ¨¡å—

//state
export const state = () => ({
    bNav: false,
    bLoading: false
});

//mutations
export const mutations = {
    M_UPDATE_NAV(state, payload) {
        state.bNav = payload;
    },
    M_UPDATE_LOADING(state, payload) {
        state.bLoading = payload;
    }
}

//actions
export const actions = {
    nuxtServerInit(store, { app: { $cookies } }) {
        //åˆå§‹åŒ–tokenä¸œè¥¿åˆ°storeå½“ä¸­  
        let user = { err: 2, msg: 'æœªç™»å½•', token: '' }
        store.commit('user/M_UPDATE_USER', user)
    }
}

//getters
export const getters = {
    getNav(state) {
        return state.bNav ? 'æ˜¾ç¤º' : 'éšè—'
    }
}
```

store/user.js

```javascript
export const state = () => ({
    err: 1,
    msg: 'æœªç™»å½•',
    token: '',
    data: {}
})

export const mutations = {
    M_UPDATE_USER(user, payload) {
        user.err = payload.err;
        user.msg = payload.msg;
        user.data = payload.data;
        user.token = payload.token;
    }
}

export const actions = {
    A_UPDATE_USER({ commit, user }, payload) {
        //..å¼‚æ­¥ä¸šåŠ¡
        commit('M_UPDATE_USER', payload)
    }
}
```

store/home.js

```javascript
export const state = () => ({
    err: 1,
    data: {}
})

export const mutations = {
    M_UPDATE_HOME(state, payload) {
        state.err = payload.err;
        state.data = payload.data;
    }
}

export const actions = {
    A_UPDATE_HOME({ commit, state }, payload) {
        //å¼‚æ­¥å¤„ç†
        commit('M_UPDATE_HOME', { err: 0, data: { title: "home æ¨¡å— actionsæ‰€ä¼ é€’çš„æ•°æ®" } })
    }
}
```

pages/index.vue

```vue
<template>
  <div>
    <h1>é¦–é¡µ</h1>
    <button @click="getStore">ç‚¹å‡»ä¿®æ”¹vuexä¸­çš„æ•°æ®</button>
  </div>
</template>

<script>
import {mapActions, mapGetters, mapState, mapMutations} from 'vuex'
export default {
  name: "IndexPage",
  layout: "default",
  methods:{
    getStore(){
      //ç¼–ç¨‹å¼è®¿é—®vuex

      //å‘å‡ºactionsè¯·æ±‚ç»™useræ¨¡å—
      // this.$store.dispatch('user/A_UPDATE_USER',{err:0,msg:'ç™»å½•æˆåŠŸ',token:'å‡token',data:{title:"useræ¨¡å—çš„actionsæäº¤è¿‡æ¥çš„æ•°æ®"}})
      // this.A_UPDATE_USER({err:0,msg:'ç™»å½•æˆåŠŸ',token:'å‡token',data:{title:"123"}})
      
      //å‘å‡ºmutationsè¯·æ±‚ç»™useræ¨¡å—
      // this.$store.commit('user/M_UPDATE_USER',{err:0,msg:'ç™»å½•æˆåŠŸ',token:'å‡token',data:{title:"ç»„ä»¶æºå¸¦è¿‡å»çš„æ•°æ®"}})
      this.M_UPDATE_USER({err:0,msg:'ç™»å½•æˆåŠŸ',token:'å‡token',data:{title:"456"}})
    },

    ...mapActions('user',['A_UPDATE_USER']),
    ...mapMutations('user',['M_UPDATE_USER']),
  },

  computed:{
    xx(){},
    ...mapGetters(['getNav']),
    ...mapState(['bNav']),
    ...mapState('user',['data']),
    ...mapState({home:state=>state.home.data}),
  }
};
</script>
```

#### çŠ¶æ€æŒä¹…åŒ–ä¸tokenæ ¡éªŒ

å®‰è£…cookie-universal-nuxtï¼šçŠ¶æ€æŒä¹…åŒ–ï¼Œéœ€è¦åˆ°é…ç½®æ–‡ä»¶çš„muduleså†…æ·»åŠ ä¸€ä¸‹ï¼Œè¯·æ±‚è‡ªåŠ¨æºå¸¦cookie

```shell
npm i cookie-universal-nuxt --save
```

æ€æƒ³ï¼šç™»å½•æ—¶ï¼Œ

1. åŒæ­¥vuex 8& cookieï¼Œ
2. å¼ºåˆ¶åˆ·æ–°**åï¼ˆvuexå¤±æ•ˆï¼‰ï¼Œç”¨nuxtServerInité’©å­ï¼Œå–å‡ºcookiesï¼ŒåŒæ­¥vuexï¼Œ**
3. axiosæ‹¦æˆªå™¨è¯»å–vuexï¼ˆvuexå­˜åœ¨å†…å­˜ä¸Šï¼Œè¯»å–é€Ÿåº¦æ›´å¿«;cookieså­˜åœ¨ç£ç›˜ï¼Œè¯»å–é€Ÿåº¦æ…¢ï¼‰

> 1.åŒæ­¥vuex && cookie
>
> ```javascript
> this.$cookies.set('user',res.data)
> this.$store.commit('user/M_UPDATE_USER ,res.data)
> //è·³è½¬ï¼š 1.ç™»å½•æˆ–æ³¨å†Œè·³è½¬åˆ°ç”¨æˆ·é¡µï¼Œ2.å“ªé‡Œæ¥å›å“ªé‡Œ
> if(!this.$route.query.path || /login|reg/.test(this.$route.query.path)){
> 	this.$router.replace( '/user')
> }else{
> 	this.$router.replace(this.$route.query.path)
> ```
>
> 2.å¼ºåˆ·åï¼Œåˆ©ç”¨nuxtServerInitå–å‡ºcookiesåŒæ­¥vuex
>
> store/index.js
>
> ```javascript
> //actions
> export const actions = {
> 	nuxtServerInit(storeï¼Œ{app:{$cookies}}) {
> 	//åˆå§‹åŒ–tokenä¸œè¥¿åˆ°storeå½“ä¸­
> 	let user = $cookies.get('user')?$cookies.get('user'):{err:2,msg:'æœªç™»å½•',token:''}
>     store.commit('user/M_UPDATE_USER',user)
>     }
> }
> ```
>
> 3.axiosæ‹¦æˆªå™¨è¯»å–vuex
>
> ```javascript
> //è¯·æ±‚æ‹¦æˆª
> $axios.onRequest(config=>{
> 	config.headers.token = store.state.user.token
> 	return config;
> })
> //å–ä¸åˆ°tokenï¼Œåˆ™å‘é€çš„è¯·æ±‚å¾—åˆ°çš„å“åº”æ˜¯é”™è¯¯çš„ï¼Œå¯ä»¥åˆ©ç”¨å“åº”æ‹¦æˆªè·³è½¬åˆ°ç™»å½•ä¹Ÿ
> //å“åº”æ‹¦æˆª
> $axios.onResponse(res=>{
> 	if(res.data.err === 2 && route.fullPath !== '/login'){
> redirect('/login?path= '+route.fullPath)
> return res
> })
> ```



ä¿®æ”¹é…ç½®æ–‡ä»¶nuxt.config.js

```javascript
export default {
  plugins: [
    //nuxt.configæ–‡ä»¶,~ä»£è¡¨æ ¹ç›®å½•
    '~/plugins/router',
    {
      src: '~/plugins/axios',
      ssr: true // æœåŠ¡å™¨
    }
  ],

  axios:{
    proxy:true,//å¼€å¯axiosè·¨åŸŸ
    // prefix:'/api',//baseUrl
  },
  proxy:{
    '/api/':{
      target:'http://www.006969.xyz:8000',//ä»£ç†è½¬å‘çš„åœ°å€
      changeOrigin:true,
      pathRewrite:{
        '^/api':''
      }
    }
  }

  // Modules: https://go.nuxtjs.dev/config-modules
  modules: [
    '@nuxtjs/axios',
   ` 'cookie-universal-nuxt'`
  ]
}

```

store/user.js

```javascript
export const state = () => ({
    token: ''
})

export const mutations = {
    M_UPDATE_USER(user, payload) {
        user.token = payload.token;
    }
}

export const actions = {
    A_UPDATE_USER({ commit, user }, payload) {
        //..å¼‚æ­¥ä¸šåŠ¡
        commit('M_UPDATE_USER', payload)
    }
}
```

// å¯¹tokenè¿›è¡ŒæŒä¹…åŒ–

store/index.js

```javascript
//ä¸»æ¨¡å—

//state
export const state = () => ({
    bNav: false,
    bLoading: false
});

//mutations
export const mutations = {
    M_UPDATE_NAV(state, payload) {
        state.bNav = payload;
    },
    M_UPDATE_LOADING(state, payload) {
        state.bLoading = payload;
    }
}

//actions
export const actions = {
    nuxtServerInit(store, { app: { $cookies } }) {
      `  //åˆå§‹åŒ–tokenä¸œè¥¿åˆ°storeå½“ä¸­  
        let user = $cookies.get('token') ? {token: $cookies.get('token')} : { token: '' }
        store.commit('user/M_UPDATE_USER', user)`
    }
}

//getters
export const getters = {
    getNav(state) {
        return state.bNav ? 'æ˜¾ç¤º' : 'éšè—'
    }
}
```

ç™»é™†é¡µé¢æ¨¡æ‹Ÿç™»é™†æ“ä½œ

pages/login.vue

```vue
<template>
  <div>
    ç™»é™†é¡µé¢
    <button @click="login">ç™»é™†</button>
  </div>
</template>

<script>
export default {
  name: 'login',
  methods: {
    login(){
      this.$axios({
        url:'/api/login',
        method:'post',
        data:{
          username: 'admin',
          password: '123456'
        }
      }).then(
        res=>{
          console.log(res)
          console.log(res.code)
          // ç™»é™†æˆåŠŸï¼Œtokenåœ¨vuexå’Œcookieä¸­å„å­˜ä¸€ä»½
          if(res.code == 200){
            //åŒæ­¥vuex && cookie
            this.$cookies.set('token',res.data.token)
            this.$store.commit('user/M_UPDATE_USER',res.data)
            if(!this.$route.query.path || /login|reg/.test(this.$route.query.path)){
              this.$router.replace('/index')
            }else{
              this.$router.replace(this.$route.query.path)
            }
          }else{
            this.message=res.message
          }
          
        }
      )
    }
  }
}
</script>

<style>

</style>
```

plugins/axios.js

```javascript
import { Message } from 'element-ui'
export default function({$axios,redirect,route,store}){
    //åŸºæœ¬é…ç½®
    $axios.defaults.timeout=10000;

    // è¯·æ±‚æ‹¦æˆª
    $axios.onRequest(config => {
        console.log('è¯·æ±‚æ‹¦æˆª')
        console.log(store.state.user.token)
        config.headers.token = store.state.user.token
        return config
    })

    //å“åº”æ‹¦æˆª
    $axios.onResponse(res=>{
        console.log('å“åº”æ‹¦æˆª')
        if (res.data.code !== 200) {
            Message({
                message: res.data.message,
                type: 'error'
            })
            console.log('è®¤è¯å¤±è´¥')            // 401 è®¤è¯å¤±è´¥(tokenè¿‡æœŸæˆ–å¤±æ•ˆæˆ–éæ³•) 403 æƒé™ä¸è¶³
            if (res.data.code === 401 || res.data.code === 403) {
            //   store.dispatch('user/logout')
                store.commit('user/M_UPDATE_USER', {token: '' }) 
                redirect('/login?path='+route.fullPath)
            }
        } else {
            // ç›´æ¥æŠŠéœ€è¦çš„æ•°æ®è¿”å›
            return res.data
        }
    })

    //é”™è¯¯å¤„ç†
    $axios.onError(error=>{
        //å¤„ç†
        return error;
    })
}
```

### element-uiä½¿ç”¨

#### åŸºæœ¬ä½¿ç”¨

å®‰è£…

```shell
npm i element-ui --save
```

plugins/element-ui.js

```javascript
import Vue from 'vue'
//æ•´ä½“å¼•å…¥
import ElementUI from 'element-ui'
Vue.use(ElementUI)

// //æŒ‰éœ€å¼•å…¥å…¨å±€ä½¿ç”¨
// import {Button} from 'element-ui'
// Vue.use(Button)
```

nuxt.config.js

```javascript
export default {
  // å…¨å±€æ ·å¼
  css: [
    'assets/css/transition.css',
    `'element-ui/lib/theme-chalk/index.css'`
  ],
  plugins: [
    //nuxt.configæ–‡ä»¶,~ä»£è¡¨æ ¹ç›®å½•
    '~/plugins/router',
    {
      src: '~/plugins/axios',
      ssr: true // æœåŠ¡å™¨
    },
   ` {
      src: "~/plugins/element-ui",
      ssr:true, // ä¸æ”¯æŒssrçš„æ’ä»¶åªä¼šåœ¨å®¢æˆ·ç«¯è¿è¡Œä¸è¦ç»™true
      //mode: 'server'// client // v2.44
    }`
  ],
  build: {
    `transpile:[ /^element-ui/] `
  }
}

```

æµ‹è¯•

```vue
<el-button type="primary">æŒ‰é’®</el-button>
```

#### ä¿®æ”¹å¯¼èˆªæ 

layouts/app-header.vue

```vue
<template>
  <el-menu 
    :default-active="activeIndex"
    @select="handleSelect"
    active-text-color="#399"
    mode="horizontal"
  >
    <el-menu-item 
      v-for="(item,index) of navs"
      :key="index"
      :index="index+''"
    >{{item.title}}</el-menu-item>
  </el-menu>
</template>
<script>
export default {
  data(){
    return {
      activeIndex:"-1",
      navs:[
        {path:'/index',title:'é¦–é¡µ'},
        {path:'/goods',title:'å•†å“'},
        {path:'/userinfo',title:'ç”¨æˆ·ä¿¡æ¯'},
      ]
    }
  },
  methods:{
    handleSelect(key,keyPath){
      this.$router.push(this.navs[key].path)
    }
  },
  watch:{
    $route:{
      immediate:true,
      handler(route){
        let find=false;
        this.navs.map((item,index)=>{
          if(item.path=='/') this.$router.push({name:'root'})
          if(route.path==item.path) {
            // console.log('true')
           this.activeIndex=index+'';
           find=true;
          }
        })
        if(!find) this.activeIndex="-1";
        
      }
    }
  }
}
</script>

<style scoped>
/* .app_header--active{
  background: #399;
  color:#fff
} */
</style>
```

è§£å†³ç™»é™†æ³¨å†Œé¡µé¢ä¸éœ€è¦å¯¼èˆªæ é—®é¢˜ï¼Œä¹Ÿéœ€è¦ä¿®æ”¹layputs/default.vueæ–‡ä»¶

```vue
<template>
  <div class="d-layout">
    <app-header v-if="bNav"></app-header>
    <!-- å±•ç¤ºåŒº  ~~ router-view -->
    <nuxt />
  </div>
</template>

<script>
import appHeader from './app-header.vue'
export default {
  components: { appHeader },
    // middleware: 'auth' // é¡µé¢å±‚çº§ä¸­é—´ä»¶å®šä¹‰
  middleware({store,route,redirect,params,query}) {
    //context æœåŠ¡ç«¯ä¸Šä¸‹æ–‡
    //å…¨å±€å®ˆå«å‰ç½®ä¸šåŠ¡
    //store çŠ¶æ€æ ‘ä¿¡æ¯
    //route ä¸€æ¡ç›®æ ‡è·¯ç”±ä¿¡æ¯
    // redirect å¼ºåˆ¶è·³è½¬
    //params,query æ ¡éªŒå‚æ•°åˆç†æ€§
    // console.log('middleware layouts å…¨å±€å®ˆå«å‰ç½®ä¸šåŠ¡')
    // console.log('middleware->layouts/default.vue')
    // redirect('/login')
  },
  data(){
    return {
      bNav:true
    }
  },
  watch:{
    $route:{
      immediate:true,
      handler(route){
        if(/login|reg/.test(route.path)){
          this.bNav=false;
        }else{
          this.bNav=true;
        }
      }
    }
  },
}
</script>

<style scoped>
</style>
```

#### ç™»é™†ä¸æ³¨é”€

pages/login.vue

```vue
<template>
  <div class="login">
    <h3>ç™»å½•</h3>
    <el-divider></el-divider>
    <el-input v-model="username" placeholder="è¯·è¾“å…¥" class="mb">
      <template slot="prepend">ç”¨æˆ·</template>
    </el-input>
    <el-input type="password" v-model="password" placeholder="è¯·è¾“å…¥" class="mb">
      <template slot="prepend">å¯†ç </template>
    </el-input>
    <div class="error">{{message}}</div>
    <el-button type="primary" @click="login">ç™»å½•</el-button>
    <el-button @click="$router.push('/reg')">æ³¨å†Œ</el-button>
  </div> 
</template>

<script>
export default {
  name: 'login',
  data:()=>({
    username:'',
    password:'',
    message:''
  }),
  methods: {
    login(){
      this.$axios({
        url:'/api/login',
        method:'post',
        data:{
          username: this.username,
          password: this.password
        }
      }).then(
        res=>{
          console.log(res)
          console.log(res.code)
          // ç™»é™†æˆåŠŸï¼Œtokenåœ¨vuexå’Œcookieä¸­å„å­˜ä¸€ä»½
          if(res.code == 200){
            //åŒæ­¥vuex && cookie
            this.$cookies.set('token',res.data.token)
            this.$store.commit('user/M_UPDATE_USER',res.data)
            if(!this.$route.query.path || /login|reg/.test(this.$route.query.path)){
              this.$router.replace('/index')
            }else{
              this.$router.replace(this.$route.query.path)
            }
          }else{
            this.message=res.message
          }
          
        }
      )
    }
  }
}
</script>

<style>
.login{
  width:35%;
  height:auto;
  position: absolute;
  left:50%;top:50%;
  margin-left:-17%;
  transform: translateY(-50%)
}
.mb{
  margin-bottom: 20px;
}
.error{
  color:red
}
</style>
```

pages/userinfo.vue

```vue
<template>
  <div class="user">
    <h3>ç”¨æˆ·</h3>
    <el-button @click="logout">æ³¨é”€</el-button>
  </div> 
</template>
<script>
export default {
  methods:{
    logout(){
      //åˆ é™¤cookieï¼Œæƒ…å†µvuex
      this.$cookies.remove('token')
      this.$store.commit('user/M_UPDATE_USER',{token:''})
      this.$router.push('/login')
    }
  }
}
</script>
```

### å…¨å±€æ–¹æ³•ã€è¿‡æ»¤å™¨ã€ç»„ä»¶ã€æŒ‡ä»¤

#### å…¨å±€æ–¹æ³•

plugins/mixins.jså®šä¹‰å…¨å±€æ–¹æ³•

```javascript
import Vue from 'vue'
let show = ()=>console.log('å…¨å±€æ–¹æ³•')

Vue.prototype.$show = show  //æœåŠ¡ç«¯é’©å­å†…éƒ¨ä¸å¯ä»¥ä½¿ç”¨ï¼Œthisä¸ä¼šæ‰§è¡Œvueå®ä¾‹
```

nuxt.config.jsé…ç½®

```javascript
export default {
  plugins: [
    //nuxt.configæ–‡ä»¶,~ä»£è¡¨æ ¹ç›®å½•
    '~/plugins/router',
    {
      src: '~/plugins/axios',
      ssr: true // æœåŠ¡å™¨
    },
    {
      src: "~/plugins/element-ui",
      ssr:true, // ä¸æ”¯æŒssrçš„æ’ä»¶åªä¼šåœ¨å®¢æˆ·ç«¯è¿è¡Œä¸è¦ç»™true
      //mode: 'server'// client // v2.44
    },
   ` '~/plugins/mixins'`
  ],
}

```

ç»„ä»¶è°ƒç”¨

```javascript
  mounted() {
    this.$show() //æ‰“å°å…¨å±€æ–¹æ³•
  },
```

#### å…¨å±€è¿‡æ»¤å™¨

assets/script/filter.js

```javascript
export function fillzero(n) {
    return n < 10 ? '0' + n : '' + n;
}

export const date = time => {
    let d = new Date();
    d.setTime(time);
    let year = d.getFullYear();
    let month = d.getMonth() + 1;
    let date = d.getDate();
    let hour = d.getHours();
    let min = d.getMinutes();
    let sec = d.getSeconds();
    return `${year}å¹´${fillzero(month)}æœˆ${fillzero(date)}æ—¥ ${fillzero(hour)}:${fillzero(min)}:${fillzero(sec)}`
}
```

plugins/mixins.js

```javascript
//å…¨å±€æ–¹æ³•
import Vue from 'vue'
let show = () => console.log('å…¨å±€æ–¹æ³•')

Vue.prototype.$show=show//æœåŠ¡ç«¯é’©å­å†…éƒ¨ä¸å¯ä»¥ä½¿ç”¨ï¼Œthisä¸ä¼šæ‰§è¡Œvueå®ä¾‹

//å…¨å±€è¿‡æ»¤å™¨
`import * as filters from '../assets/script/filters';
Object.keys(filters).forEach(key=>Vue.filter(key,filters[key]));`
```

ç»„ä»¶ä½¿ç”¨

```vue
<template>
  <div class="user">
    <h3>ç”¨æˆ·</h3>
    <el-button @click="logout">æ³¨é”€</el-button>
    <hr>
    <h3>å…¨å±€è¿‡æ»¤å™¨ä½¿ç”¨</h3>
    <p>{{4 | fillzero}}</p>
    <span>{{1692779835608 | date}}</span>
  </div> 
</template>
```

![image-20230823163832913](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202308231638048.png)

#### å…¨å±€æŒ‡ä»¤

bindç»‘å®šçš„æ—¶å€™è§¦å‘ï¼Œinsertedæ’å…¥çš„æ—¶å€™è§¦å‘ï¼ŒcomponentUpdatedæ›´æ–°çš„æ—¶å€™è§¦å‘

assets/script/directives/direc1.js

```javascript
function direc1(el, binding, vnode) {
    console.log('å…¨å±€æŒ‡ä»¤1', el, binding, vnode)
}

export default {
    bind(el, binding, vnode) {
        direc1(el, binding, vnode)
    }
}
```

assets/script/directives/direc2.js

```javascript
function direc2(el, binding, vnode) {
    console.log('å…¨å±€æŒ‡ä»¤2')
}
export default {
    inserted(el, binding, vnode) {
        direc2(el, binding, vnode)
    },
    componentUpdated(el, binding, vnode) {
        direc2(el, binding, vnode)
    }
}
```

plugins/mixins.js

```javascript
//å…¨å±€æ–¹æ³•
import Vue from 'vue'
let show = () => console.log('å…¨å±€æ–¹æ³•')

Vue.prototype.$show=show//æœåŠ¡ç«¯é’©å­å†…éƒ¨ä¸å¯ä»¥ä½¿ç”¨ï¼Œthisä¸ä¼šæ‰§è¡Œvueå®ä¾‹

//å…¨å±€è¿‡æ»¤å™¨
import * as filters from '../assets/script/filter';
Object.keys(filters).forEach(key=>Vue.filter(key,filters[key]));


//å…¨å±€æŒ‡ä»¤
import direc1 from '../assets/script/directives/direc1'
import direc2 from '../assets/script/directives/direc2'
Vue.directive('direc1',direc1)
Vue.directive('direc2',direc2)
```

ç»„ä»¶å†…ä½¿ç”¨

```vue
<template>
  <div class="user">
    <h3>å…¨å±€è¿‡æ»¤å™¨ä½¿ç”¨</h3>
    <p>{{4 | fillzero}}</p>
    <span>{{1692779835608 | date}}</span>
    <hr>
    <h3>å…¨å±€æŒ‡ä»¤ä½¿ç”¨</h3>
    <div v-direc1="'red'">direc1</div>
    <div v-direc2>{{title}}</div>
  </div> 
</template>
<script>
export default {
  data() {
    return {
      title: 'å…¨å±€æŒ‡ä»¤'
    }
  },
  mounted() {
    this.$show() //æ‰“å°å…¨å±€æ–¹æ³•
  }
}
</script>
```

![image-20230823164424481](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202308231644622.png)

#### å…¨å±€ç»„ä»¶

components/global/mybutton/index.vue

```vue
<template>
  <button>å…¨å±€æŒ‰é’®</button>
</template>
  <script>
export default {
  name: "my-button",
};
</script>
```

plugins/mixins.js

```javascript
//å…¨å±€æ–¹æ³•
import Vue from 'vue'
let show = () => console.log('å…¨å±€æ–¹æ³•')

Vue.prototype.$show=show//æœåŠ¡ç«¯é’©å­å†…éƒ¨ä¸å¯ä»¥ä½¿ç”¨ï¼Œthisä¸ä¼šæ‰§è¡Œvueå®ä¾‹

//å…¨å±€è¿‡æ»¤å™¨
import * as filters from '../assets/script/filter';
Object.keys(filters).forEach(key=>Vue.filter(key,filters[key]));


//å…¨å±€æŒ‡ä»¤
import direc1 from '../assets/script/directives/direc1'
import direc2 from '../assets/script/directives/direc2'
Vue.directive('direc1',direc1)
Vue.directive('direc2',direc2)

// å…¨å±€ç»„ä»¶
import myButton from '../ components/global/mybutton';
Vue.component('my-button', myButton)
```

ç»„ä»¶ä½¿ç”¨

```vue
<template>
  <div class="user">
    <h3>å…¨å±€è¿‡æ»¤å™¨ä½¿ç”¨</h3>
    <p>{{4 | fillzero}}</p>
    <span>{{1692779835608 | date}}</span>
    <hr>
    <h3>å…¨å±€æŒ‡ä»¤ä½¿ç”¨</h3>
    <div v-direc1="'red'">direc1</div>
    <div v-direc2>{{title}}</div>
    <hr>
    <h3>å…¨å±€ç»„ä»¶ä½¿ç”¨</h3>
    <my-button></my-button>
  </div> 
</template>
<script>
export default {
  data() {
    return {
      title: 'å…¨å±€æŒ‡ä»¤'
    }
  },
  mounted() {
    this.$show() //æ‰“å°å…¨å±€æ–¹æ³•
  }
}
</script>
```

### metaä¿¡æ¯æ³¨å…¥

ç½‘ç«™æè¿°å¤´éƒ¨ä¿¡æ¯ï¼Œä¼˜åŒ–seo

#### å…¨å±€meta

nuxt.config.js

```javascript
export default {
  // Global page headers: https://go.nuxtjs.dev/config-head
  head: {
    title: 'è‡ªå®šä¹‰æ ‡é¢˜',
    htmlAttrs: {
      lang: 'en'
    },
    meta: [
      { charset: 'utf-8' },
      { name: 'viewport', content: 'width=device-width, initial-scale=1' },
      { hid: 'description', name: 'description', content: '' },
      { name: 'format-detection', content: 'telephone=no' }
    ],
    link: [
      { rel: 'icon', type: 'image/x-icon', href: '/favicon.ico' }
    ]
  }
}

```

#### å±€éƒ¨ç‰¹è‰²meta

pages/userInfo.vue

```javascript
<template>
  <div class="user">
    <h3>ç”¨æˆ·</h3>
    <el-button @click="logout">æ³¨é”€</el-button>
    <hr />
    <h3>å…¨å±€è¿‡æ»¤å™¨ä½¿ç”¨</h3>
    <p>{{ 4 | fillzero }}</p>
    <span>{{ 1692779835608 | date }}</span>
    <hr />
    <h3>å…¨å±€æŒ‡ä»¤ä½¿ç”¨</h3>
    <div v-direc1="'red'">direc1</div>
    <div v-direc2>{{ title }}</div>
    <hr />
    <h3>å…¨å±€ç»„ä»¶ä½¿ç”¨</h3>
    <my-button></my-button>
  </div>
</template>
<script>
export default {
  //headé€‰é¡¹ï¼Œé¡µé¢metaé…ç½®
  head() {
    return {
      title: 'å•†å“ä¿¡æ¯',
      meta: [{ name: "keywords", content: 'å•†å“ä¿¡æ¯å†…å®¹' }],
    };
  },
  data() {
    return {
      title: "å…¨å±€æŒ‡ä»¤",
    };
  },
  mounted() {
    this.$show(); //æ‰“å°å…¨å±€æ–¹æ³•
  },
  methods: {
    logout() {
      //åˆ é™¤cookieï¼Œæƒ…å†µvuex
      this.$cookies.remove("token");
      this.$store.commit("user/M_UPDATE_USER", { token: "" });
      this.$router.push("/login");
    },
  },
};
</script>
```

#### Vue.mixin

mixins.jså†…å®šä¹‰æ··å…¥æ–¹æ³•

```javascript
//å…¨å±€æ–¹æ³•
import Vue from 'vue'
let show = () => console.log('å…¨å±€æ–¹æ³•')

Vue.prototype.$show = show//æœåŠ¡ç«¯é’©å­å†…éƒ¨ä¸å¯ä»¥ä½¿ç”¨ï¼Œthisä¸ä¼šæ‰§è¡Œvueå®ä¾‹

//å…¨å±€è¿‡æ»¤å™¨
import * as filters from '../assets/script/filter';
Object.keys(filters).forEach(key => Vue.filter(key, filters[key]));


//å…¨å±€æŒ‡ä»¤
import direc1 from '../assets/script/directives/direc1'
import direc2 from '../assets/script/directives/direc2'
Vue.directive('direc1', direc1)
Vue.directive('direc2', direc2)

// å…¨å±€ç»„ä»¶
import myButton from '../components/global/mybutton';
Vue.component('my-button', myButton)


//æ··å…¥methods
Vue.mixin({
    methods: {
        $seo(title, content, payload = []) {
            return {
                title,
                meta: [{
                    hid: 'description',
                    name: 'keywords',
                    content
                }].concat(payload)
            }
        }
    }
})
```

ç»„ä»¶ä½¿ç”¨

```javascript
<template>
  <div class="user">
    <h3>ç”¨æˆ·</h3>
    <el-button @click="logout">æ³¨é”€</el-button>
    <hr />
    <h3>å…¨å±€è¿‡æ»¤å™¨ä½¿ç”¨</h3>
    <p>{{ 4 | fillzero }}</p>
    <span>{{ 1692779835608 | date }}</span>
    <hr />
    <h3>å…¨å±€æŒ‡ä»¤ä½¿ç”¨</h3>
    <div v-direc1="'red'">direc1</div>
    <div v-direc2>{{ title }}</div>
    <hr />
    <h3>å…¨å±€ç»„ä»¶ä½¿ç”¨</h3>
    <my-button></my-button>
  </div>
</template>
<script>
export default {
  //headé€‰é¡¹ï¼Œé¡µé¢metaé…ç½®
  // head() {
  //   return {
  //     title: 'å•†å“ä¿¡æ¯',
  //     meta: [{ name: "keywords", content: 'å•†å“ä¿¡æ¯å†…å®¹' }],
  //   };
  // },
  head() {
    return this.$seo('è‡ªå®šä¹‰å•†å“æ ‡é¢˜','è‡ªå®šä¹‰å•†å“æè¿°ä¿¡æ¯',[])
  },
  data() {
    return {
      title: "å…¨å±€æŒ‡ä»¤",
    };
  },
  mounted() {
    this.$show(); //æ‰“å°å…¨å±€æ–¹æ³•
  },
  methods: {
    logout() {
      //åˆ é™¤cookieï¼Œæƒ…å†µvuex
      this.$cookies.remove("token");
      this.$store.commit("user/M_UPDATE_USER", { token: "" });
      this.$router.push("/login");
    },
  },
};
</script>
```

### scssä½¿ç”¨

ä¸‹è½½node-sass sass-loader

```shell
npm i node-sass sass-loader --save
```

ä½¿ç”¨

```vue
<template>
  <div class="comment-detail">
    <h3>è¯„è®ºè¯¦æƒ…</h3>
    <div class="box">box</div>
    <div class="box2">box2</div>
  </div>
</template>
<style lang="scss" scoped>
$bg: #399;
.box{
  background: $bg
}
.box2{
  background: $theme-bg
}
</style>
```

å…¨å±€ä¸»é¢˜å¯¼å…¥

ä¸‹è½½@nuxtjs/style-resourcesï¼Œéœ€è¦é…ç½®modulesï¼Œè¿˜éœ€è¦æŒ‡å®šstyleResourceså†…çš„scssæ–‡ä»¶

å®‰è£…

```shell
npm install @nuxtjs/style-resources --save
```

nuxt.config.js

```javascript

module.exports = {
  modules: [
    '@nuxtjs/axios',
    'cookie-universal-nuxt',
    `'@nuxtjs/style-resources'`
  ],

`  styleResources:{
    scss:[
      './assets/scss/global.scss'
    ]
  },`
}

```

assets/scss/gloabl.scss

```csss
$theme-bg:#393;
```

ä½¿ç”¨

```scss
.box2{
	background: $theme-bg
}
```

### å®šä¹‰åŒ–htmlæ¨¡æ¿

é¡¹ç›®æ ¹è·¯å¾„ä¸‹åˆ›å»ºapp.htmlæ–‡ä»¶ï¼Œçº¦å®šæ¨¡æ¿

```html
<!DOCTYPE html>
<html {{HTML_ATTRS}}>
<head {{HEAD_ATTRS}}>
  {{HEAD}}
  <!-- è‡ªå®šä¹‰çš„å†…å®¹ -->
  <!-- <script src="å¤–éƒ¨èµ„æº"></script> -->
</head>
<body {{BODY_ATTRS}}>
  {{APP}}
</body>
</html>
```

### èµ„æºæŒ‡å‘ä¸å¼•å…¥

`~`ä»£è¡¨æ ¹è·¯å¾„

staticæ— ä¼˜åŒ–ï¼Œä¸å‚ä¸æ‰“åŒ…

accetsæ‰“åŒ…ä¼˜åŒ–ï¼Œè½¬base64

```vue
<template>
  <div class="container">
    <h4>å†…éƒ¨èµ„æºæŒ‡å‘</h4>
    <!-- ç›¸å¯¹è·¯å¾„æ‰¾åˆ°ä¸€äº›éœ€è¦å‹ç¼©çš„èµ„æº assets -->
    <!-- <img src="../assets/img/btns.png" alt=""> -->
    <img src="~assets/img/btns.png" alt="">
     <!-- ç»å¯¹è·¯å¾„æ‰¾åˆ°æ— éœ€å‹ç¼©çš„èµ„æºstatic -->
     <img src="/img/bg.jpg" alt="">

     <div class="bgimg">cssæŒ‡å‘éœ€è¦å‹ç¼©çš„èµ„æº</div>
  </div>
</template>

<script>
</script>

<style scoped>
.bgimg {
  /* background: url('../assets/img/btns.png') no-repeat; */
  background: url('~/assets/img/btns.png') no-repeat;
}
</style>

```

#### å…¨å±€å¼•å…¥èµ„æº

1. å…¬å…±æ–‡ä»¶å¯ä»¥åœ¨app.htmlé€šè¿‡srcå¼•å…¥
2. å¯ä»¥é€šè¿‡nuxt.config.jså†…çš„`script:[{src:'...'}]`è¿›è¡Œæ·»åŠ ï¼Œæˆ–è€…ç”¨linké“¾æ¥

nuxt.config.js

```javascript
export default {
  head: {
    title: 'è‡ªå®šä¹‰æ ‡é¢˜',
    htmlAttrs: {
      lang: 'en'
    },
    meta: [
      { charset: 'utf-8' },
      { name: 'viewport', content: 'width=device-width, initial-scale=1' },
      { hid: 'description', name: 'description', content: '' },
      { name: 'format-detection', content: 'telephone=no' }
    ],
   ` script:[
      {src:'https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js'}
    ],`
    link: [
      { rel: 'icon', type: 'image/x-icon', href: '/favicon.ico' },
     ` {rel:'stylesheet',href:'https://fonts.googleapis.com/css?family=Roboto'}`
    ]
  }
}

```

#### å±€éƒ¨å¼•å…¥

pages/userinfo.vue

```vue
<template>
  <div class="user">
    <el-button onclick="alert($)">æµ‹è¯•å¤–éƒ¨å¼•å…¥èµ„æº</el-button>
  </div>
</template>
<script>
export default {
  //headé€‰é¡¹ï¼Œé¡µé¢metaé…ç½®
  // head() {
  //   return {
  //     title: 'å•†å“ä¿¡æ¯',
  //     meta: [{ name: "keywords", content: 'å•†å“ä¿¡æ¯å†…å®¹' }],
  //   };
  // },
  // head() {
  //   return this.$seo('è‡ªå®šä¹‰å•†å“æ ‡é¢˜','è‡ªå®šä¹‰å•†å“æè¿°ä¿¡æ¯',[])
  // },
  head: {
    script:[		
      {src:'https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js'}
    ]
  }
};
</script>
```

### æ”¹è£…æˆts

åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®

```shell
npx create-nuxt-app nuxt-ts
```

![image-20230824120643332](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202308241206485.png)





#### é¡¹ç›®é‡å†™

> ä¹‹å‰é¡¹ç›®éƒ½æ˜¯ç”¨javascriptæ¥å†™çš„ï¼Œç°åœ¨æˆ‘ä»¬ç”¨typescriptæ¥é‡å†™

ä¸‹è½½@nuxt/typescript-build

```shell
yarn add --dev @nuxt/typescript-build @nuxt/types typescript@4
```

é…ç½®nuxt.config.js

```javascript
export default {
  buildModules: [
    '@nuxt/typescript-build'
  ]
}

```

æ·»åŠ tsconfig.jsonï¼Œtypes/vue-shim.d.tsé…ç½®æ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹åœ¨https://typescript.nuxtjs.org/guide/setup.html#configuration

æ–°å»ºtsconfig.json

```json
{
    "compilerOptions": {
      "target": "ES2018",
      "module": "ESNext",
      "moduleResolution": "Node",
      "lib": [
        "ESNext",
        "ESNext.AsyncIterable",
        "DOM"
      ],
      "esModuleInterop": true,
      "allowJs": true,
      "sourceMap": true,
      "strict": true,
      "noEmit": true,
      "baseUrl": ".",
      "paths": {
        "~/*": [
          "./*"
        ],
        "@/*": [
          "./*"
        ]
      },
      "types": [
        "@nuxt/types",
        "@nuxt/typescript-build",
        "@types/node"
      ]
    },
    "exclude": [
      "node_modules"
    ]
  }
```

æ–°å»ºvue-shim.d.ts

```typescript
declare module "*.vue" {
    import Vue from 'vue'
    export default Vue
}
```

åœ¨tsconfig.jsonå†…åŠ ä¸Š

```json
{
"skipLibCheck":true,
"experimentalDecorators":true,
}
```

ä¸‹è½½vue-property-decoratorå’Œvue-class-componentï¼Œç”¨ç±»çš„æ–¹å¼å®šä¹‰vueç»„ä»¶

https://typescript.nuxtjs.org/zh-hant/cookbook/components/

```shell
npm install vue-property-decorator vue-class-component --save-dev
```

ps: é¡¹ç›®å¿…é¡»åœ¨å·¥ä½œåŒºé¦–ä¸ªï¼Œvscodeçš„bug



ç»„ä»¶å†…çš„ts

components/loadding.vue

```vue
<template>
  <div v-if="loading" class="spinner"></div>
</template>
<script lang="ts">
import {Vue,Component} from 'vue-property-decorator'
@Component
export default class Loading extends Vue{
  //dataå…ƒæ•°æ® == å®ä¾‹å±æ€§
  loading: boolean = false

  //methodsçš„æ–¹æ³• == ç±»å†…çš„å®ä¾‹æ–¹æ³•
  start():void{
    this.loading = true;
  }
  finish():void{
    this.loading = false;
  }

}
</script>

<!-- <script>
  export default {
    data: () => ({
      loading: false,
    }),
    methods: {
      // è¿™ä¸¤ä¸ªå‡½æ•°ä½¿nuxtä¸ºæˆ‘ä»¬æä¾›çš„ï¼Œä¸€ä¸ªæ˜¯è¯·æ±‚å¼€å§‹ï¼Œä¸€ä¸ªæ˜¯ç»“æŸ
      start() {
        this.loading = true;
      },
      finish() {
        this.loading = false;
      },
    },
  };
</script> -->
<style scoped>
.spinner {
  width: 60px;
  height: 60px;
  background-color: #399;

  position: fixed;
  left: 50%;
  top: 50%;
  margin-left: -30px;
  margin-top: -30px;
  -webkit-animation: rotateplane 1.2s infinite ease-in-out;
  animation: rotateplane 1.2s infinite ease-in-out;
}

@-webkit-keyframes rotateplane {
  0% {
    -webkit-transform: perspective(120px);
  }
  50% {
    -webkit-transform: perspective(120px) rotateY(180deg);
  }
  100% {
    -webkit-transform: perspective(120px) rotateY(180deg) rotateX(180deg);
  }
}

@keyframes rotateplane {
  0% {
    transform: perspective(120px) rotateX(0deg) rotateY(0deg);
    -webkit-transform: perspective(120px) rotateX(0deg) rotateY(0deg);
  }
  50% {
    transform: perspective(120px) rotateX(-180.1deg) rotateY(0deg);
    -webkit-transform: perspective(120px) rotateX(-180.1deg) rotateY(0deg);
  }
  100% {
    transform: perspective(120px) rotateX(-180deg) rotateY(-179.9deg);
    -webkit-transform: perspective(120px) rotateX(-180deg) rotateY(-179.9deg);
  }
}
</style>
```

components/mybutton/index.vue

```vue
<template>
  <button>å…¨å±€æŒ‰é’®</button>
</template>
<script lang="ts">
import {Vue,Component} from 'vue-property-decorator'
@Component
export default class MyButton extends Vue{

}
</script>
```

layouts/app-header.vue

```vue
<template>
  <el-menu 
    :default-active="activeIndex"
    @select="handleSelect"
    active-text-color="#399"
    mode="horizontal"
  >
    <el-menu-item 
      v-for="(item,index) of navs"
      :key="index"
      :index="index+''"
    >{{item.title}}</el-menu-item>
  </el-menu>
</template>
<script lang="ts">
import {Vue,Component,Watch} from 'vue-property-decorator'
import {Route} from 'vue-router'

type TNavs = {path:string,title:string}

@Component
export default class AppHeader extends Vue {
  activeIndex:string = "-1";
  navs:TNavs[] = [
        {path:'/index',title:'é¦–é¡µ'},
        {path:'/goods',title:'å•†å“'},
        {path:'/userinfo',title:'ç”¨æˆ·ä¿¡æ¯'},
      ];
  handleSelect(key:number):void{
      this.$router.push(this.navs[key].path)
  }
  @Watch('$route',{immediate:true,deep:true})
  onRouteChange(route:Route){
    let find=false;
        this.navs.map((item,index)=>{
          if(item.path=='/') this.$router.push({name:'root'})
          if(route.path==item.path) {
            // console.log('true')
           this.activeIndex=index+'';
           find=true;
          }
        })
      if(!find) this.activeIndex="-1";
  }    
}
// export default {
//   data(){
//     return {
//       activeIndex:"-1",
//       navs:[
//         {path:'/index',title:'é¦–é¡µ'},
//         {path:'/goods',title:'å•†å“'},
//         {path:'/userinfo',title:'ç”¨æˆ·ä¿¡æ¯'},
//       ]
//     }
//   },
//   methods:{
//     handleSelect(key,keyPath){
//       this.$router.push(this.navs[key].path)
//     }
//   },
//   watch:{
//     $route:{
//       immediate:true,
//       handler(route){
//         let find=false;
//         this.navs.map((item,index)=>{
//           if(item.path=='/') this.$router.push({name:'root'})
//           if(route.path==item.path) {
//             // console.log('true')
//            this.activeIndex=index+'';
//            find=true;
//           }
//         })
//         if(!find) this.activeIndex="-1";
        
//       }
//     }
//   }
// }
</script>

<style scoped>
/* .app_header--active{
  background: #399;
  color:#fff
} */
</style>
```

layouts/default.vue

```vue
<template>
  <div class="d-layout">
    <app-header v-if="bNav"></app-header>
    <!-- å±•ç¤ºåŒº  ~~ router-view -->
    <nuxt />
  </div>
</template>

<script lang="ts">
import {Vue,Component,Watch} from 'vue-property-decorator'
import AppHeader from './app-header.vue'
import { Route } from 'vue-router';

@Component({
  middleware({store,route,redirect,params,query}){
    //context æœåŠ¡ç«¯ä¸Šä¸‹æ–‡
    //å…¨å±€å®ˆå«å‰ç½®ä¸šåŠ¡
    //store çŠ¶æ€æ ‘ä¿¡æ¯
    //route ä¸€æ¡ç›®æ ‡è·¯ç”±ä¿¡æ¯
    // redirect å¼ºåˆ¶è·³è½¬
    //params,query æ ¡éªŒå‚æ•°åˆç†æ€§
    console.log('middleware layouts å…¨å±€å®ˆå«å‰ç½®ä¸šåŠ¡')
    // redirect('/reg')
    // console.log('middleware layouts')
  },
  components:{AppHeader}
})
export default class Default extends Vue{
  bNav:boolean = true;

  @Watch('$route',{immediate:true})
  onRouteChange(route:Route){
    if(/login|reg/.test(route.path)){
      this.bNav=false;
    }else{
      this.bNav=true;
    }
  }
}
// import appHeader from './app-header.vue'
// export default {
//   components: { appHeader },
//     // middleware: 'auth' // é¡µé¢å±‚çº§ä¸­é—´ä»¶å®šä¹‰
//   middleware({store,route,redirect,params,query}) {
//     //context æœåŠ¡ç«¯ä¸Šä¸‹æ–‡
//     //å…¨å±€å®ˆå«å‰ç½®ä¸šåŠ¡
//     //store çŠ¶æ€æ ‘ä¿¡æ¯
//     //route ä¸€æ¡ç›®æ ‡è·¯ç”±ä¿¡æ¯
//     // redirect å¼ºåˆ¶è·³è½¬
//     //params,query æ ¡éªŒå‚æ•°åˆç†æ€§
//     // console.log('middleware layouts å…¨å±€å®ˆå«å‰ç½®ä¸šåŠ¡')
//     // console.log('middleware->layouts/default.vue')
//     // redirect('/login')
//   },
//   data(){
//     return {
//       bNav:true
//     }
//   },
//   watch:{
//     $route:{
//       immediate:true,
//       handler(route){
//         if(/login|reg/.test(route.path)){
//           this.bNav=false;
//         }else{
//           this.bNav=true;
//         }
//       }
//     }
//   },
// }
</script>

<style scoped>
</style>
```

layouts/error.vue

```vue
<template>
  <div>
    <h1 v-if="error.statusCode">{{error.message}}</h1>
    <h1 v-else>åº”ç”¨å‘ç”Ÿå¼‚å¸¸</h1>
    <button @click="$router.replace('/index')">è·³è½¬åˆ°é¦–é¡µ</button>
  </div>
</template>

<script lang="ts">
import {Vue,Component,Prop} from 'vue-property-decorator'
@Component
export default class Error extends Vue{
  @Prop() readonly error:string|undefined
}

// export default {
//     // æ¥å—é”™è¯¯ä¿¡æ¯ error: {statusCode, message }
//     props: ['error']
// }
</script>

<style>

</style>
```







æ–°å¢types/vue.d.ts

```typescript
//é‡å†™vueç±»å‹æ¥å£

import Vue from 'vue';
import {NuxtAxiosInstance} from '@nuxtjs/axios'
import {NuxtCookies} from 'cookie-universal-nuxt'
declare module 'vue/types/vue' {
  interface Vue {
    $axios: NuxtAxiosInstance;
    $seo:Function;
    detail:{title:string,des:string};
    $show:()=>void;
    collectionName:string;
    $cookies: NuxtCookies;
    username:string;
    password:string;
  }
}
```

åŒæ—¶ä¹ŸæŠŠvue-shim.d.tsç§»åˆ°typesç›®å½•ä¸‹

pages/login.vue

```vue
<template>
  <div class="login">
    <h3>ç™»å½•</h3>
    <el-divider></el-divider>
    <el-input v-model="username" placeholder="è¯·è¾“å…¥" class="mb">
      <template slot="prepend">ç”¨æˆ·</template>
    </el-input>
    <el-input type="password" v-model="password" placeholder="è¯·è¾“å…¥" class="mb">
      <template slot="prepend">å¯†ç </template>
    </el-input>
    <div class="error">{{message}}</div>
    <el-button type="primary" @click="login">ç™»å½•</el-button>
    <el-button @click="$router.push('/reg')">æ³¨å†Œ</el-button>
  </div> 
</template>

<script lang="ts">
import { Vue, Component } from "vue-property-decorator";
@Component
export default class Login extends Vue {
  username:string = '';
  password:string = '';
  message:string = '';
  login(){
      this.$axios({
        url:'/api/login',
        method:'post',
        data:{
          username: this.username,
          password: this.password
        }
      }).then(
        res=>{
          console.log(res)
          console.log(res.code)
          // ç™»é™†æˆåŠŸï¼Œtokenåœ¨vuexå’Œcookieä¸­å„å­˜ä¸€ä»½
          if(res.code == 200){
            //åŒæ­¥vuex && cookie
            this.$cookies.set('token',res.data.token)
            this.$store.commit('user/M_UPDATE_USER',res.data)
            if(!this.$route.query.path || /login|reg/.test(this.$route.query.path)){
              this.$router.replace('/index')
            }else{
              this.$router.replace(this.$route.query.path)
            }
          }else{
            this.message=res.message
          }
          
        }
      )
    }
}
// export default {
//   name: 'login',
//   data:()=>({
//     username:'',
//     password:'',
//     message:''
//   }),
//   methods: {
//     login(){
//       this.$axios({
//         url:'/api/login',
//         method:'post',
//         data:{
//           username: this.username,
//           password: this.password
//         }
//       }).then(
//         res=>{
//           console.log(res)
//           console.log(res.code)
//           // ç™»é™†æˆåŠŸï¼Œtokenåœ¨vuexå’Œcookieä¸­å„å­˜ä¸€ä»½
//           if(res.code == 200){
//             //åŒæ­¥vuex && cookie
//             this.$cookies.set('token',res.data.token)
//             this.$store.commit('user/M_UPDATE_USER',res.data)
//             if(!this.$route.query.path || /login|reg/.test(this.$route.query.path)){
//               this.$router.replace('/index')
//             }else{
//               this.$router.replace(this.$route.query.path)
//             }
//           }else{
//             this.message=res.message
//           }
          
//         }
//       )
//     }
//   }
// }
</script>

<style>
.login{
  width:35%;
  height:auto;
  position: absolute;
  left:50%;top:50%;
  margin-left:-17%;
  transform: translateY(-50%)
}
.mb{
  margin-bottom: 20px;
}
.error{
  color:red
}
</style>
```

pages/UserInfo.vue

```vue
<template>
  <div class="user">
    <h3>ç”¨æˆ·</h3>
    <el-button @click="logout">æ³¨é”€</el-button>
    <hr />
    <h3>å…¨å±€è¿‡æ»¤å™¨ä½¿ç”¨</h3>
    <p>{{ 4 | fillzero }}</p>
    <span>{{ 1692779835608 | date }}</span>
    <hr />
    <h3>å…¨å±€æŒ‡ä»¤ä½¿ç”¨</h3>
    <div v-direc1="'red'">direc1</div>
    <div v-direc2>{{ title }}</div>
    <hr />
    <h3>å…¨å±€ç»„ä»¶ä½¿ç”¨</h3>
    <my-button></my-button>

    <el-button onclick="alert($)">æµ‹è¯•å¤–éƒ¨å¼•å…¥èµ„æº</el-button>
  </div>
</template>
<script lang="ts">
import { Vue, Component } from "vue-property-decorator";
@Component({
  head:{
    script:[
      {src:'https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js'}
    ]
  }
})
export default class UserInfo extends Vue {
  logout() {
      //åˆ é™¤cookieï¼Œæƒ…å†µvuex
      this.$cookies.remove("token");
      this.$store.commit("user/M_UPDATE_USER", { token: "" });
      this.$router.push("/login");
    }
}
// export default {
//   //headé€‰é¡¹ï¼Œé¡µé¢metaé…ç½®
//   // head() {
//   //   return {
//   //     title: 'å•†å“ä¿¡æ¯',
//   //     meta: [{ name: "keywords", content: 'å•†å“ä¿¡æ¯å†…å®¹' }],
//   //   };
//   // },
//   // head() {
//   //   return this.$seo('è‡ªå®šä¹‰å•†å“æ ‡é¢˜','è‡ªå®šä¹‰å•†å“æè¿°ä¿¡æ¯',[])
//   // },
//   head: {
//     script:[		
//       {src:'https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js'}
//     ]
//   },
//   data() {
//     return {
//       title: "å…¨å±€æŒ‡ä»¤",
//     };
//   },
//   mounted() {
//     this.$show(); //æ‰“å°å…¨å±€æ–¹æ³•
//   },
//   methods: {
//     logout() {
//       //åˆ é™¤cookieï¼Œæƒ…å†µvuex
//       this.$cookies.remove("token");
//       this.$store.commit("user/M_UPDATE_USER", { token: "" });
//       this.$router.push("/login");
//     },
//   },
// };
</script>
```

### vuexåŠ å…¥è£…é¥°å™¨

å®‰è£…

```shell
npm i vuex-class -S
```

pages/index.vue

```vue
<template>
  <div class="container">
    <el-carousel>
      <el-carousel-item v-for="item of banner" :key="item._id">
        <nuxt-link :to="{name:'goods-id',params:{id:item._id},query:{collectionName:'banner'}}">
          <img :src="item.banner" class="img">
          <div class="title_bg">
            <h3 class="title">{{item.title}}</h3>
            <h4 class="sub_title">{{item.sub_title}}</h4>
          </div>
        </nuxt-link>
      </el-carousel-item>
    </el-carousel>
    <el-row class="home" :gutter="20">
      <el-col :span="6" v-for="item of home" :key="item._id">
        <el-card :body-style="{padding:'0px'}" style="margin-bottom:20px">
          <nuxt-link :to="{name:'goods-id',params:{id:item._id},query:{collectionName:'home'}}">
            <img :src="item.detail.auth_icon" alt="" class="image">
          </nuxt-link>
          <div style="padding:14px;">
            <span>{{item.title}}</span>
            <div class="bottom clearfix">
              <time class="time">{{item.time}}</time>
              <el-button class="button" type="warning" icon="el-icon-star-off" circle></el-button>
            </div>
          </div>
        </el-card>
      </el-col>
    </el-row>
    <h4>vuexæ“ä½œ</h4>
    <button @click="getStore">ç¼–ç¨‹å¼æ“ä½œ</button>
    <div>inddex getters:{{getNav}}</div>
    <div>inddex state:{{bNav}}</div>
    <div>user state: {{data}}</div>
    <h4>å†…éƒ¨èµ„æºæŒ‡å‘</h4>
    <!-- ç›¸å¯¹è·¯å¾„æ‰¾åˆ°ä¸€äº›éœ€è¦å‹ç¼©çš„èµ„æº assets -->
    <!-- <img src="../assets/img/btns.png" alt=""> -->
    <img src="~assets/img/btns.png" alt="">
    <!-- ç»å¯¹è·¯å¾„æ‰¾åˆ°æ— éœ€å‹ç¼©çš„èµ„æºstatic -->
    <img src="/img/bg.jpg" alt="">
    <div class="bgimg">cssæŒ‡å‘éœ€è¦å‹ç¼©çš„èµ„æº</div>
    <h4>å¤–éƒ¨èµ„æº</h4>
    <el-button onclick="alert($)">æµ‹è¯•å¤–éƒ¨jsè„šæœ¬</el-button>
  </div>
</template>

<script lang="ts">
import { Vue, Component, Prop } from "vue-property-decorator";
import { State, Getter, Action, Mutation } from "vuex-class";
@Component({
  async asyncData({ app: { $axios } }) {
    let res = await $axios({ url: "/data/list.json" });
    // console.log('è¯»å–åˆ°çš„é™æ€èµ„æº',res.data)

    //è¯»å–è·¨åŸŸæ•°æ®
    try {
      let res2 = await $axios({
        url: "/api/goods/banner",
        params: { _limit: 3 }
      });
      // console.log('è¯»å–åˆ°çš„è·¨åŸŸèµ„æº',res2.data)

      return {
        // title:res.data.title,
        banner: res2.data.data
      };
    } catch (e) {}
  },

  async fetch({ app: { $axios }, store, error }) {
    let res2 = await $axios({ url: "/api/goods/home", params: { _limit: 20 } });
    // console.log('res',res.data.title)
    res2.data &&
      store.commit("home/M_UPDATE_HOME", { err: 0, data: res2.data.data });
  }
})
export default class Index extends Vue {
  @State
  bNav: boolean | undefined; //è£…é¥°ä¸€ä¸ªå®ä¾‹å±æ€§bNavå¼•ç”¨åˆ°state.bNav

  @State(state => state.home.data)
  home?: object[];

  @State("user")
  data!: object; //å¤–éƒ¨state.user åš ç»„ä»¶å†…çš„dataä½¿ç”¨

  @Getter
  getNav!: string; //æŠ“å–gettersçš„keyï¼Œä½œä¸ºç»„ä»¶å®ä¾‹å±æ€§ä½¿ç”¨

  //...mapActions('user',['A_UPDATE_USER']),
  @Action("user/A_UPDATE_USER")
  A_UPDATE_USER!: (payload: object) => void;

  //...mapMutations('user',['M_UPDATE_USER']),
  @Mutation("user/M_UPDATE_USER")
  M_UPDATE_USER!: (payload: object) => void;

  getStore() {
    //ç¼–ç¨‹å¼è®¿é—®vuex
    //å‘å‡ºactionsè¯·æ±‚ç»™useræ¨¡å—
    // this.$store.dispatch('user/A_UPDATE_USER',{err:0,msg:'ç™»å½•æˆåŠŸ',token:'å‡token',data:{title:"useræ¨¡å—çš„actionsæäº¤è¿‡æ¥çš„æ•°æ®"}})
    // this.A_UPDATE_USER({err:0,msg:'ç™»å½•æˆåŠŸ',token:'å‡token',data:{title:"123"}})
    //å‘å‡ºmutationsè¯·æ±‚ç»™useræ¨¡å—
    // this.$store.commit('user/M_UPDATE_USER',{err:0,msg:'ç™»å½•æˆåŠŸ',token:'å‡token',data:{title:"ç»„ä»¶æºå¸¦è¿‡å»çš„æ•°æ®"}})
    this.M_UPDATE_USER({err:0,msg:'ç™»å½•æˆåŠŸ',token:'å‡token',data:{title:"456"}})
  }

  //è®¡ç®—å±æ€§å®šä¹‰
  get xx(): string {
    return this.bNav ? "çœŸ" : "å‡";
  }
}
</script>

<style scoped>
.el-carousel__item .img {
  width: 100%;
  height: auto;
}

.el-carousel__item .title_bg {
  background: rgba(0, 0, 0, 0.5);
  color: #fff;
  height: 60px;
  width: 100%;
  position: absolute;
  left: 0;
  bottom: 0px;
  z-index: 999;
}
.home {
  margin-top: 20px;
}
.time {
  font-size: 13px;
  color: #999;
}
.bottom {
  margin-top: 13px;
  line-height: 12px;
}
.image {
  width: 100%;
  display: block;
}
.button {
  padding: 0;
  float: right;
}
.bgimg {
  height: 50px;
  /* background: url('../assets/img/takeSbmComment.png') no-repeat */
  background: url("~assets/img/takeSbmComment.png") no-repeat;
}
</style>

```

types/index.ts

ç±»å‹ä¸»é¢˜æ¨¡å—

```typescript
//ç±»å‹ä¸»æ¨¡å—  
interface IStoreState{
  bNav:boolean;
  bLoading:boolean;
}

interface IStoreHome{
  err:number;
  msg?:string;
  data:Array<{
    _id:string;
    des:string;
    time:number;
    title:string;
    detail?:{
      auth:string;
      auth_icon:string;
      content:string;
    }
  }>
}

interface IStoreUser{
  err:number;
  msg:string;
  token:string;
  data?:Partial<{
    _id:string;
    nikename:string;
    fans:number;
    follow:number;
    time:number;
    icon:string;
  }>
}

export {IStoreUser, IStoreState, IStoreHome}
```

stroe/index.ts

```javascript
//ä¸»æ¨¡å—
import {IStoreState} from '@/types'

//state
export const state = function():IStoreState{
  return {
    bNav: false,
    bLoading: false
  }
};

//mutations
export const mutations = {
  M_UPDATE_NAV(state:IStoreState, payload:boolean) {
    state.bNav = payload;
  },
  M_UPDATE_LOADING(state:IStoreState, payload:boolean) {
    state.bLoading = payload;
  }
}

//actions
export const actions = {
  nuxtServerInit(store:any, context:any) {
    //åˆå§‹åŒ–tokenä¸œè¥¿åˆ°storeå½“ä¸­  
    let user = context.app.$cookies.get('user') ? context.app.$cookies.get('user') : {err:2,msg:'æœªç™»å½•',token:''};
    store.commit('user/M_UPDATE_USER',user)
  }
}

//getters
export const getters = {
  getNav(state:IStoreState){
    return state.bNav ? 'æ˜¾ç¤º' : 'éšè—'
  }
}
```

store/home.ts

```javascript
import { IStoreHome } from "~/types";
type TAcion = {
  commit:(type:string,payload:object)=>void;
  state:IStoreHome
}
export const state=function():IStoreHome{
  return {
    err:1,
    data:[]
  }
}

export const mutations = {
  M_UPDATE_HOME(state:IStoreHome,payload:IStoreHome){
    state.err=payload.err;
    state.data=payload.data;
  }
}

export const actions = {
  A_UPDATE_HOME({commit,state}:TAcion,payload:IStoreHome){
    //å¼‚æ­¥å¤„ç†
    commit('M_UPDATE_HOME',{err:0,data:{title:"home æ¨¡å— actionsæ‰€ä¼ é€’çš„æ•°æ®"}})
  }
}
```

store/user.ts

```typescript
import { IStoreUser } from "~/types";
type TAction={
  user:IStoreUser;
  commit:(type:string,payload:object)=>void;
}
export const state=function():IStoreUser{
  return {
    err:1,
    msg:'æœªç™»å½•',
    token:'',
    data:{}
  }
}

export const mutations = {
  M_UPDATE_USER(user:IStoreUser,payload:IStoreUser){
    user.err = payload.err;
    user.msg = payload.msg;
    user.data = payload.data;
    user.token = payload.token;
  }
}

export const actions = {
  A_UPDATE_USER({commit,user}:TAction,payload:{}){
    //..å¼‚æ­¥ä¸šåŠ¡
    commit('M_UPDATE_USER',payload)
  }
}
```

### éƒ¨ç½²

nuxté€šè¿‡ä»£ç†ï¼Œå°†è¯·æ±‚è½¬å‘å¸¦çœŸå®æœåŠ¡å™¨ï¼Œéƒ¨ç½²æ—¶ï¼Œnuxté¡¹ç›®å³å‰ç«¯å·¥ç¨‹3000å’ŒçœŸå®æœåŠ¡å™¨å³åç«¯å·¥ç¨‹9001éƒ½è¦éƒ¨ç½²ã€‚

nuxté€šè¿‡server/index.jså¼€å¯è‡ªèº«ç«¯å£æœåŠ¡3000

nuxtå…ˆæ‰“åŒ…npm run buildï¼Œæ”¾åˆ°æœåŠ¡å™¨3000ç«¯å£çš„æœ‰ï¼š.nuxt /server /static /package-lock.json /package.json /nuxt.config.js

çœŸå®æœåŠ¡å™¨å³åç«¯å·¥ç¨‹9001

å…ˆé…ç½®ä¸€ä¸‹nuxt.config.js

```javascript
module.exports = {
    mode: 'universal',
    server:1
    port: 3000,//default 3000
    host:'0.0.0.0' //å› ä¸ºéƒ½è¢«æ”¾åœ¨æœåŠ¡å™¨ä¸Š
	...
}
```

![image-20230824171856471](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202308241718701.png)

```shell
nuxt
   npm run build  æ‰“åŒ…

   æˆ‘ä»¬éœ€è¦å¤åˆ¶åˆ°(é˜¿é‡Œäº‘)æœåŠ¡å™¨çš„æ–‡ä»¶  3000ç›®å½•ä¸‹
    .nuxt
    package-lock.json 
    package.json
    nuxt.config.json
    static
    server   åå‘ä»£ç†
```

![image-20230824172051301](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202308241720455.png)

å¯åŠ¨nodeæœåŠ¡

![image-20230824172324967](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202308241723197.png)

å¯åŠ¨å‰ç«¯å‘½ä»¤

![image-20230824172441561](https://trpora-1300527744.cos.ap-chongqing.myqcloud.com/img/202308241724781.png)

```shell
pm2 start /usr/local/9001/bin/www --name=node9001
cd /usr/local/3000/
pm2 --name=nuxt3000 start npm -- run start
```



## vue-server-rendererå’ŒNuxtåŒºåˆ«

`vue-server-renderer` å’Œ `Nuxt.js` éƒ½æ¶‰åŠåœ¨æœåŠ¡å™¨ç«¯æ¸²æŸ“ (Server-Side Rendering, SSR) ä¸Šçš„ Vue.js åº”ç”¨ç¨‹åºï¼Œä½†å®ƒä»¬æœ‰ä¸åŒçš„ä½œç”¨å’Œä½¿ç”¨æ–¹å¼ã€‚

1. **vue-server-renderer**: `vue-server-renderer` æ˜¯ Vue.js å®˜æ–¹æä¾›çš„ä¸€ä¸ªåº“ï¼Œç”¨äºå°† Vue ç»„ä»¶æ¸²æŸ“ä¸ºå­—ç¬¦ä¸²ï¼Œä»¥ä¾¿åœ¨æœåŠ¡å™¨ä¸Šè¿›è¡Œé¢„æ¸²æŸ“æˆ–åœ¨å®¢æˆ·ç«¯è¿›è¡Œæ¿€æ´»ã€‚å®ƒçš„ä¸»è¦ç›®çš„æ˜¯å°† Vue ç»„ä»¶æ¸²æŸ“ä¸º HTML å­—ç¬¦ä¸²ï¼Œç„¶åå°†è¿™äº›å­—ç¬¦ä¸²å‘é€ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯æ¥æ”¶åå†æ¿€æ´»è¿™äº›ç»„ä»¶ã€‚ä½ å¯ä»¥ä½¿ç”¨å®ƒæ¥å®ç°è‡ªå·±çš„æœåŠ¡å™¨ç«¯æ¸²æŸ“è§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯éœ€è¦æ‰‹åŠ¨å¤„ç†è·¯ç”±ã€æ•°æ®è·å–ç­‰æ–¹é¢çš„é€»è¾‘ã€‚
2. **Nuxt.js**: `Nuxt.js` æ˜¯ä¸€ä¸ªåŸºäº Vue.js çš„æ¡†æ¶ï¼Œä¸“æ³¨äºç®€åŒ– Vue åº”ç”¨ç¨‹åºçš„æœåŠ¡å™¨ç«¯æ¸²æŸ“ã€‚å®ƒæä¾›äº†ä¸€ç³»åˆ—çº¦å®šå’Œé»˜è®¤é…ç½®ï¼Œä½¿å¾—ä½ å¯ä»¥æ›´å®¹æ˜“åœ°æ„å»º SSR åº”ç”¨ç¨‹åºã€‚Nuxt.js è‡ªåŠ¨å¤„ç†è·¯ç”±ã€æ•°æ®è·å–ã€é¡µé¢å¸ƒå±€ç­‰æ–¹é¢çš„ç»†èŠ‚ï¼Œå¤§å¤§å‡è½»äº†å¼€å‘è€…çš„å·¥ä½œé‡ã€‚Nuxt.js è¿˜æä¾›äº†ä¸€äº›å…¶ä»–åŠŸèƒ½ï¼Œå¦‚è‡ªåŠ¨ç”Ÿæˆè·¯ç”±ã€ä»£ç åˆ†å‰²ã€é™æ€ç«™ç‚¹ç”Ÿæˆç­‰ã€‚

æ€»çš„æ¥è¯´ï¼Œ`vue-server-renderer` æ›´åƒæ˜¯ä¸€ä¸ªåº•å±‚çš„åº“ï¼Œå…è®¸ä½ ä»¥è‡ªå®šä¹‰çš„æ–¹å¼å¤„ç†æœåŠ¡å™¨ç«¯æ¸²æŸ“ï¼Œè€Œ `Nuxt.js` åˆ™æ˜¯ä¸€ä¸ªé«˜çº§æ¡†æ¶ï¼Œä¸ºä½ æä¾›äº†ä¸€æ•´å¥—çš„å·¥å…·å’Œçº¦å®šæ¥æ„å»º SSR åº”ç”¨ç¨‹åºï¼Œä½¿å¾—å¼€å‘è¿‡ç¨‹æ›´åŠ ç®€å•å’Œå¿«é€Ÿã€‚

å¦‚æœä½ åªæ˜¯éœ€è¦åœ¨ç°æœ‰çš„ Vue.js åº”ç”¨ç¨‹åºä¸­å®ç°ä¸€äº›æœåŠ¡å™¨ç«¯æ¸²æŸ“çš„åŠŸèƒ½ï¼Œä½ å¯ä»¥ä½¿ç”¨ `vue-server-renderer`ã€‚å¦‚æœä½ æƒ³ä»å¤´å¼€å§‹æ„å»ºä¸€ä¸ªæœåŠ¡å™¨ç«¯æ¸²æŸ“çš„ Vue.js åº”ç”¨ç¨‹åºï¼Œå¹¶å¸Œæœ›æœ‰æ›´å¤šçš„è‡ªåŠ¨åŒ–å’Œä¾¿åˆ©æ€§ï¼Œé‚£ä¹ˆ `Nuxt.js` æ˜¯ä¸€ä¸ªæ›´å¥½çš„é€‰æ‹©ã€‚

